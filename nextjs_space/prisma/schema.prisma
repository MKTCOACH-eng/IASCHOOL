generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/iaschool_app/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  PROFESOR
  PADRE
  ALUMNO
  VOCAL
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum Priority {
  NORMAL
  URGENT
}

enum ConversationType {
  DIRECT           // Chat 1:1 (padre-profesor, padre-admin)
  GROUP_PARENTS    // Chat de padres de un grupo escolar
  GROUP_STUDENTS   // Chat de alumnos de un grupo escolar
  TEAM             // Chat de equipo de trabajo (alumnos)
  ADMIN_CHANNEL    // Canal oficial del colegio
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  SYSTEM
}

model School {
  id           String         @id @default(cuid())
  name         String
  code         String         @unique
  logoUrl      String?
  primaryColor String         @default("#1B4079")
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  users        User[]
  announcements Announcement[]
  invitations  Invitation[]
  groups       Group[]
  students     Student[]
  conversations Conversation[]
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  password           String
  name               String
  phone              String?
  role               Role     @default(PADRE)
  schoolId           String?
  school             School?  @relation(fields: [schoolId], references: [id])
  mustChangePassword Boolean  @default(false)
  profileCompleted   Boolean  @default(false)
  createdAt          DateTime @default(now())
  announcements      Announcement[] @relation("CreatedBy")
  reads              AnnouncementRead[]
  invitationId       String?  @unique
  invitation         Invitation? @relation(fields: [invitationId], references: [id])
  
  // Comunicaci√≥n
  participations     ConversationParticipant[]
  messages           Message[]
  reactions          MessageReaction[]
  
  // Relaci√≥n padres-hijos
  children           Student[] @relation("ParentChildren")
  
  // Profesor asignado a grupos
  teacherGroups      Group[]   @relation("GroupTeacher")
  
  // Vocal de grupo (solo padres con rol VOCAL)
  vocalGroup         Group?    @relation("GroupVocal")
}

model Invitation {
  id            String           @id @default(cuid())
  email         String
  role          Role
  tempPassword  String
  schoolId      String
  school        School           @relation(fields: [schoolId], references: [id])
  status        InvitationStatus @default(PENDING)
  token         String           @unique @default(cuid())
  expiresAt     DateTime
  createdAt     DateTime         @default(now())
  acceptedAt    DateTime?
  user          User?

  @@unique([email, schoolId])
}

// Grupos escolares (ej: "3ro Primaria A", "2do Secundaria B")
model Group {
  id           String    @id @default(cuid())
  name         String    // "3ro Primaria A"
  grade        String?   // "3ro Primaria"
  section      String?   // "A"
  schoolId     String
  school       School    @relation(fields: [schoolId], references: [id])
  teacherId    String?   // Profesor titular
  teacher      User?     @relation("GroupTeacher", fields: [teacherId], references: [id])
  vocalId      String?   @unique // Vocal de grupo (un padre)
  vocal        User?     @relation("GroupVocal", fields: [vocalId], references: [id])
  students     Student[]
  conversations Conversation[]
  createdAt    DateTime  @default(now())
  isActive     Boolean   @default(true)

  @@unique([name, schoolId])
}

// Estudiantes (alumnos)
model Student {
  id           String   @id @default(cuid())
  firstName    String
  lastName     String
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id])
  groupId      String?
  group        Group?   @relation(fields: [groupId], references: [id])
  parents      User[]   @relation("ParentChildren")
  createdAt    DateTime @default(now())
  isActive     Boolean  @default(true)

  @@index([schoolId])
  @@index([groupId])
}

// Conversaciones (chats)
model Conversation {
  id           String           @id @default(cuid())
  type         ConversationType
  name         String?          // Para chats grupales
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id])
  groupId      String?          // Para chats de grupo escolar
  group        Group?           @relation(fields: [groupId], references: [id])
  participants ConversationParticipant[]
  messages     Message[]
  lastMessageAt DateTime?
  createdAt    DateTime         @default(now())
  isActive     Boolean          @default(true)

  @@index([schoolId])
  @@index([groupId])
  @@index([lastMessageAt])
}

// Participantes en conversaciones
model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  isMuted        Boolean      @default(false)
  lastReadAt     DateTime?
  joinedAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
}

// Mensajes
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  type           MessageType  @default(TEXT)
  content        String
  fileUrl        String?
  fileName       String?
  fileSize       Int?
  mimeType       String?
  isPinned       Boolean      @default(false)
  pinnedAt       DateTime?
  pinnedById     String?
  isEdited       Boolean      @default(false)
  createdAt      DateTime     @default(now())
  editedAt       DateTime?
  reactions      MessageReaction[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([conversationId, isPinned])
}

// Reacciones a mensajes
model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  emoji     String   // üëç, ‚ù§Ô∏è, üòÇ, üòÆ, üò¢, üôè
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model Announcement {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  title       String
  content     String
  priority    Priority @default(NORMAL)
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  reads       AnnouncementRead[]
}

model AnnouncementRead {
  id             String       @id @default(cuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  readAt         DateTime     @default(now())

  @@unique([announcementId, userId])
}
