generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/iaschool_app/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  PROFESOR
  PADRE
  ALUMNO
  VOCAL
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum Priority {
  NORMAL
  URGENT
}

enum ConversationType {
  DIRECT           // Chat 1:1 (padre-profesor, padre-admin)
  GROUP_PARENTS    // Chat de padres de un grupo escolar
  GROUP_STUDENTS   // Chat de alumnos de un grupo escolar
  TEAM             // Chat de equipo de trabajo (alumnos)
  ADMIN_CHANNEL    // Canal oficial del colegio
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  SYSTEM
}

model School {
  id           String         @id @default(cuid())
  name         String
  code         String         @unique
  logoUrl      String?
  primaryColor String         @default("#1B4079")
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  users        User[]
  announcements Announcement[]
  invitations  Invitation[]
  groups       Group[]
  students     Student[]
  conversations Conversation[]
  subjects     Subject[]
  events       Event[]
  charges      Charge[]
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  password           String
  name               String
  phone              String?
  role               Role     @default(PADRE)
  schoolId           String?
  school             School?  @relation(fields: [schoolId], references: [id])
  mustChangePassword Boolean  @default(false)
  profileCompleted   Boolean  @default(false)
  createdAt          DateTime @default(now())
  announcements      Announcement[] @relation("CreatedBy")
  reads              AnnouncementRead[]
  invitationId       String?  @unique
  invitation         Invitation? @relation(fields: [invitationId], references: [id])
  
  // Comunicaci贸n
  participations     ConversationParticipant[]
  messages           Message[]
  reactions          MessageReaction[]
  
  // Relaci贸n padres-hijos
  children           Student[] @relation("ParentChildren")
  
  // Profesor asignado a grupos
  teacherGroups      Group[]   @relation("GroupTeacher")
  
  // Vocal de grupo (solo padres con rol VOCAL)
  vocalGroup         Group?    @relation("GroupVocal")
  
  // Tareas
  tasksCreated       Task[]    @relation("TaskTeacher")
  submissionsReviewed Submission[] @relation("SubmissionReviewer")
  
  // Calendario
  eventsCreated      Event[]   @relation("EventCreator")
  eventAttendances   EventAttendee[]
  
  // Pagos
  chargesCreated     Charge[]  @relation("ChargeCreatedBy")
  paymentsRecorded   Payment[] @relation("PaymentRecordedBy")
  
  // Documentos de calificaciones
  gradeDocumentsUploaded GradeDocument[] @relation("GradeDocumentUploader")
}

model Invitation {
  id            String           @id @default(cuid())
  email         String
  role          Role
  tempPassword  String
  schoolId      String
  school        School           @relation(fields: [schoolId], references: [id])
  status        InvitationStatus @default(PENDING)
  token         String           @unique @default(cuid())
  expiresAt     DateTime
  createdAt     DateTime         @default(now())
  acceptedAt    DateTime?
  user          User?

  @@unique([email, schoolId])
}

// Grupos escolares (ej: "3ro Primaria A", "2do Secundaria B")
model Group {
  id           String    @id @default(cuid())
  name         String    // "3ro Primaria A"
  grade        String?   // "3ro Primaria"
  section      String?   // "A"
  schoolId     String
  school       School    @relation(fields: [schoolId], references: [id])
  teacherId    String?   // Profesor titular
  teacher      User?     @relation("GroupTeacher", fields: [teacherId], references: [id])
  vocalId      String?   @unique // Vocal de grupo (un padre)
  vocal        User?     @relation("GroupVocal", fields: [vocalId], references: [id])
  students     Student[]
  conversations Conversation[]
  tasks        Task[]
  events       Event[]
  createdAt    DateTime  @default(now())
  isActive     Boolean   @default(true)

  @@unique([name, schoolId])
}

// Estudiantes (alumnos)
model Student {
  id           String   @id @default(cuid())
  firstName    String
  lastName     String
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id])
  groupId      String?
  group        Group?   @relation(fields: [groupId], references: [id])
  parents      User[]   @relation("ParentChildren")
  submissions  Submission[]
  charges      Charge[]
  gradeDocuments GradeDocument[]
  createdAt    DateTime @default(now())
  isActive     Boolean  @default(true)

  @@index([schoolId])
  @@index([groupId])
}

// Conversaciones (chats)
model Conversation {
  id           String           @id @default(cuid())
  type         ConversationType
  name         String?          // Para chats grupales
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id])
  groupId      String?          // Para chats de grupo escolar
  group        Group?           @relation(fields: [groupId], references: [id])
  participants ConversationParticipant[]
  messages     Message[]
  lastMessageAt DateTime?
  createdAt    DateTime         @default(now())
  isActive     Boolean          @default(true)

  @@index([schoolId])
  @@index([groupId])
  @@index([lastMessageAt])
}

// Participantes en conversaciones
model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  isMuted        Boolean      @default(false)
  lastReadAt     DateTime?
  joinedAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
}

// Mensajes
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  type           MessageType  @default(TEXT)
  content        String
  fileUrl        String?
  fileName       String?
  fileSize       Int?
  mimeType       String?
  isPinned       Boolean      @default(false)
  pinnedAt       DateTime?
  pinnedById     String?
  isEdited       Boolean      @default(false)
  createdAt      DateTime     @default(now())
  editedAt       DateTime?
  reactions      MessageReaction[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([conversationId, isPinned])
}

// Reacciones a mensajes
model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  emoji     String   // , わ, , , , 
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model Announcement {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  title       String
  content     String
  priority    Priority @default(NORMAL)
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  reads       AnnouncementRead[]
}

model AnnouncementRead {
  id             String       @id @default(cuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  readAt         DateTime     @default(now())

  @@unique([announcementId, userId])
}

// ==================== MDULO DE TAREAS ====================

enum TaskStatus {
  DRAFT       // Borrador
  PUBLISHED   // Publicada y visible
  CLOSED      // Cerrada, no acepta m谩s entregas
}

// ==================== MDULO DE CALENDARIO ====================

enum EventType {
  ESCOLAR       // Evento escolar general
  REUNION       // Reuni贸n de padres/junta
  CITA          // Cita individual
  FESTIVO       // D铆a festivo/vacaciones
  ACADEMICO     // Ex谩menes, entrega de boletas
  EXTRACURRICULAR // Deportes, cultura, etc.
}

enum EventAttendeeStatus {
  PENDING
  CONFIRMED
  DECLINED
}

// ==================== MDULO DE PAGOS ====================

enum PaymentStatus {
  PENDIENTE     // Pago pendiente
  PAGADO        // Pago completado
  VENCIDO       // Pago vencido
  PARCIAL       // Pago parcial
  CANCELADO     // Cargo cancelado
}

enum PaymentMethod {
  EFECTIVO
  TRANSFERENCIA
  TARJETA
  DEPOSITO
  OTRO
}

enum ChargeType {
  COLEGIATURA   // Mensualidad
  INSCRIPCION   // Inscripci贸n
  MATERIAL      // Material escolar
  UNIFORME      // Uniforme
  EVENTO        // Eventos especiales
  TRANSPORTE    // Transporte escolar
  COMEDOR       // Comedor/Cafeter铆a
  OTRO          // Otros cargos
}

enum SubmissionStatus {
  PENDING     // Entregada, pendiente de revisi贸n
  REVIEWED    // Revisada con calificaci贸n
  LATE        // Entregada tarde
  RETURNED    // Devuelta para correcciones
}

// Materias/Asignaturas
model Subject {
  id          String   @id @default(cuid())
  name        String   // "Matem谩ticas", "Espa帽ol", "Ciencias"
  color       String   @default("#1B4079") // Color para UI
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  tasks       Task[]
  createdAt   DateTime @default(now())
  isActive    Boolean  @default(true)

  @@unique([name, schoolId])
  @@index([schoolId])
}

// Tareas
model Task {
  id             String     @id @default(cuid())
  title          String
  description    String?    @db.Text
  instructions   String?    @db.Text
  status         TaskStatus @default(DRAFT)
  
  // Fechas
  dueDate        DateTime?  // Fecha l铆mite de entrega
  publishedAt    DateTime?  // Cu谩ndo se public贸
  closedAt       DateTime?  // Cu谩ndo se cerr贸
  
  // Archivos adjuntos (material de apoyo)
  attachments    TaskAttachment[]
  
  // Puntuaci贸n
  maxScore       Int        @default(100)  // Puntuaci贸n m谩xima
  weight         Float      @default(1.0)  // Peso para promedio
  
  // Relaciones
  subjectId      String?
  subject        Subject?   @relation(fields: [subjectId], references: [id])
  groupId        String     // Grupo al que se asigna
  group          Group      @relation(fields: [groupId], references: [id])
  teacherId      String     // Profesor que cre贸 la tarea
  teacher        User       @relation("TaskTeacher", fields: [teacherId], references: [id])
  
  submissions    Submission[]
  
  // Evento de calendario para fecha l铆mite
  calendarEvent  Event?
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([groupId])
  @@index([teacherId])
  @@index([status])
  @@index([dueDate])
}

// Archivos adjuntos de tareas
model TaskAttachment {
  id              String   @id @default(cuid())
  taskId          String
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  fileName        String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  cloudStoragePath String?
  isPublic        Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([taskId])
}

// Entregas de tareas
model Submission {
  id              String           @id @default(cuid())
  taskId          String
  task            Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student          @relation(fields: [studentId], references: [id])
  
  // Contenido de la entrega
  content         String?          @db.Text  // Texto/comentarios del alumno
  attachments     SubmissionAttachment[]
  
  // Estado y calificaci贸n
  status          SubmissionStatus @default(PENDING)
  score           Float?           // Calificaci贸n obtenida
  feedback        String?          @db.Text  // Retroalimentaci贸n del profesor
  
  // Fechas
  submittedAt     DateTime         @default(now())
  reviewedAt      DateTime?
  reviewedById    String?
  reviewedBy      User?            @relation("SubmissionReviewer", fields: [reviewedById], references: [id])
  isLate          Boolean          @default(false)
  
  updatedAt       DateTime         @updatedAt

  @@unique([taskId, studentId])
  @@index([taskId])
  @@index([studentId])
  @@index([status])
}

// Archivos adjuntos de entregas
model SubmissionAttachment {
  id              String     @id @default(cuid())
  submissionId    String
  submission      Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  fileName        String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  cloudStoragePath String?
  isPublic        Boolean    @default(false)
  createdAt       DateTime   @default(now())

  @@index([submissionId])
}

// Documentos de calificaciones (boletas, reportes)
model GradeDocument {
  id              String   @id @default(cuid())
  title           String   // "Boleta Primer Trimestre", "Reporte Anual"
  description     String?
  
  // Relaciones
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  uploadedById    String
  uploadedBy      User     @relation("GradeDocumentUploader", fields: [uploadedById], references: [id])
  
  // Archivo
  fileName        String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  cloudStoragePath String?
  isPublic        Boolean  @default(false)
  
  // Per铆odo acad茅mico
  period          String?  // "2025-T1", "2025-2026"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([studentId])
  @@index([uploadedById])
}

// ==================== EVENTOS DE CALENDARIO ====================

model Event {
  id             String      @id @default(cuid())
  title          String
  description    String?     @db.Text
  
  // Fechas y horario
  startDate      DateTime
  endDate        DateTime?
  allDay         Boolean     @default(false)
  
  // Tipo y visualizaci贸n
  type           EventType   @default(ESCOLAR)
  color          String      @default("#1B4079")
  location       String?     // Ubicaci贸n (aula, auditorio, etc.)
  
  // Visibilidad
  isPublic       Boolean     @default(true)  // Visible para toda la escuela
  
  // Relaciones
  schoolId       String
  school         School      @relation(fields: [schoolId], references: [id])
  createdById    String
  createdBy      User        @relation("EventCreator", fields: [createdById], references: [id])
  groupId        String?     // Para eventos espec铆ficos de un grupo
  group          Group?      @relation(fields: [groupId], references: [id])
  taskId         String?     @unique // Enlace a tarea (para fechas l铆mite)
  task           Task?       @relation(fields: [taskId], references: [id])
  
  // Asistentes
  attendees      EventAttendee[]
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([schoolId])
  @@index([startDate])
  @@index([groupId])
  @@index([type])
}

// Asistentes a eventos
model EventAttendee {
  id           String              @id @default(cuid())
  eventId      String
  event        Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId       String
  user         User                @relation(fields: [userId], references: [id])
  status       EventAttendeeStatus @default(PENDING)
  responseAt   DateTime?
  createdAt    DateTime            @default(now())

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// ==================== CARGOS Y PAGOS ====================

// Cargos (colegiaturas, inscripciones, etc.)
model Charge {
  id             String        @id @default(cuid())
  concept        String        // Descripci贸n del cargo
  type           ChargeType    @default(COLEGIATURA)
  amount         Float         // Monto total
  amountPaid     Float         @default(0) // Monto pagado
  status         PaymentStatus @default(PENDIENTE)
  
  // Fechas
  dueDate        DateTime      // Fecha l铆mite de pago
  periodMonth    Int?          // Mes del periodo (1-12)
  periodYear     Int?          // A帽o del periodo
  
  // Relaciones
  studentId      String
  student        Student       @relation(fields: [studentId], references: [id])
  schoolId       String
  school         School        @relation(fields: [schoolId], references: [id])
  createdById    String
  createdBy      User          @relation("ChargeCreatedBy", fields: [createdById], references: [id])
  
  // Pagos asociados
  payments       Payment[]
  
  // Notas y observaciones
  notes          String?       @db.Text
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([studentId])
  @@index([schoolId])
  @@index([status])
  @@index([dueDate])
  @@index([type])
}

// Pagos realizados
model Payment {
  id             String        @id @default(cuid())
  amount         Float         // Monto del pago
  method         PaymentMethod @default(EFECTIVO)
  reference      String?       // Referencia de pago (# de transferencia, etc.)
  
  // Relaciones
  chargeId       String
  charge         Charge        @relation(fields: [chargeId], references: [id], onDelete: Cascade)
  recordedById   String        // Usuario que registr贸 el pago (admin)
  recordedBy     User          @relation("PaymentRecordedBy", fields: [recordedById], references: [id])
  
  // Notas
  notes          String?       @db.Text
  
  // Comprobante de pago (opcional)
  receiptUrl     String?
  receiptPath    String?
  
  paidAt         DateTime      @default(now())
  createdAt      DateTime      @default(now())

  @@index([chargeId])
  @@index([paidAt])
}
