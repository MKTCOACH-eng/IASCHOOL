generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/iaschool_app/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN   // Administrador global del sistema (multi-escuela)
  ADMIN
  PROFESOR
  PADRE
  ALUMNO
  VOCAL
}

enum AttendanceStatus {
  PRESENTE
  AUSENTE
  TARDANZA
  JUSTIFICADO
}

enum PollStatus {
  ACTIVE
  CLOSED
}

enum DocumentStatus {
  DRAFT           // Borrador
  PENDING         // Pendiente de firma
  PARTIALLY_SIGNED // Firmado parcialmente
  COMPLETED       // Completamente firmado
  EXPIRED         // Expirado
  CANCELLED       // Cancelado
}

enum DocumentType {
  PERMISO           // Permiso de salida/actividad
  AUTORIZACION      // Autorizaci√≥n general
  REGLAMENTO        // Reglamento escolar
  CONTRATO          // Contrato de servicios
  CONSTANCIA        // Constancia
  CIRCULAR          // Circular informativa
  OTRO              // Otro tipo
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum Priority {
  NORMAL
  URGENT
}

enum ConversationType {
  DIRECT           // Chat 1:1 (padre-profesor, padre-admin)
  GROUP_PARENTS    // Chat de padres de un grupo escolar
  GROUP_STUDENTS   // Chat de alumnos de un grupo escolar
  TEAM             // Chat de equipo de trabajo (alumnos)
  ADMIN_CHANNEL    // Canal oficial del colegio
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  SYSTEM
}

model School {
  id           String         @id @default(cuid())
  name         String
  code         String         @unique
  logoUrl      String?
  primaryColor String         @default("#1B4079")
  secondaryColor String?      @default("#CBDF90")
  address      String?
  phone        String?
  email        String?
  website      String?
  description  String?        @db.Text
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @default(now()) @updatedAt
  users        User[]
  announcements Announcement[]
  invitations  Invitation[]
  groups       Group[]
  students     Student[]
  conversations Conversation[]
  subjects     Subject[]
  events       Event[]
  charges      Charge[]
  documents    Document[]
  chatbotConversations ChatbotConversation[]
  settings     SchoolSettings?
  bankConfig   SchoolBankConfig?
  
  // Fase 4B: CRM y Comunicaci√≥n
  crmSegments      CrmSegment[]
  crmCampaigns     CrmCampaign[]
  emailTemplates   EmailTemplate[]
  communicationLogs CommunicationLog[]
  metricsSnapshots SchoolMetricsSnapshot[]
  importLogs       ImportLog[]
  
  // Fase 4C: Tienda y Galer√≠a
  storeCategories  StoreCategory[]
  storeProducts    StoreProduct[]
  orders           Order[]
  photoAlbums      PhotoAlbum[]
  schedules        Schedule[]
  surveys          Survey[]
  enrollments      Enrollment[]
  permitRequests   PermitRequest[]
  
  // Nuevos m√≥dulos
  reportCards      ReportCard[]      @relation("SchoolReportCards")
  disciplineRecords DisciplineRecord[] @relation("SchoolDiscipline")
  nurseVisits      NurseVisit[]      @relation("SchoolNurseVisits")
  bulkImportJobs   BulkImportJob[]   @relation("SchoolImports")
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  password           String
  name               String
  phone              String?
  role               Role     @default(PADRE)
  schoolId           String?
  school             School?  @relation(fields: [schoolId], references: [id])
  mustChangePassword Boolean  @default(false)
  profileCompleted   Boolean  @default(false)
  onboardingCompleted Boolean @default(false)
  preferredLanguage  String   @default("es")
  createdAt          DateTime @default(now())
  announcements      Announcement[] @relation("CreatedBy")
  reads              AnnouncementRead[]
  invitationId       String?  @unique
  invitation         Invitation? @relation(fields: [invitationId], references: [id])
  
  // Comunicaci√≥n
  participations     ConversationParticipant[]
  messages           Message[]
  reactions          MessageReaction[]
  
  // Relaci√≥n padres-hijos
  children           Student[] @relation("ParentChildren")
  
  // Relaci√≥n alumno-estudiante (para usuarios con rol ALUMNO)
  studentProfile     Student?  @relation("StudentUser")
  
  // Profesor asignado a grupos
  teacherGroups      Group[]   @relation("GroupTeacher")
  
  // Vocal de grupo (solo padres con rol VOCAL)
  vocalGroup         Group?    @relation("GroupVocal")
  
  // Tareas
  tasksCreated       Task[]    @relation("TaskTeacher")
  submissionsReviewed Submission[] @relation("SubmissionReviewer")
  
  // Calendario
  eventsCreated      Event[]   @relation("EventCreator")
  eventAttendances   EventAttendee[]
  
  // Pagos
  chargesCreated     Charge[]  @relation("ChargeCreatedBy")
  paymentsRecorded   Payment[] @relation("PaymentRecordedBy")
  
  // Documentos de calificaciones
  gradeDocumentsUploaded GradeDocument[] @relation("GradeDocumentUploader")
  
  // Asistencias registradas por profesor
  attendancesRecorded Attendance[] @relation("AttendanceRecorder")
  
  // Encuestas creadas (vocal)
  pollsCreated       Poll[]    @relation("PollCreator")
  pollVotes          PollVote[]
  
  // Documentos y firmas digitales
  documentsCreated   Document[]          @relation("DocumentCreator")
  documentSignatures DocumentSignature[]
  
  // Chatbot IA
  chatbotConversations ChatbotConversation[]
  
  // Sistema de citas
  teacherAvailability  TeacherAvailability[] @relation("TeacherAvailability")
  appointmentsAsTeacher Appointment[]        @relation("TeacherAppointments")
  appointmentsAsParent  Appointment[]        @relation("ParentAppointments")
  
  // Fase 4B: CRM y Comunicaci√≥n
  languagePreference   UserLanguagePreference?
  campaignsCreated     CrmCampaign[]
  campaignRecipients   CrmCampaignRecipient[]
  communicationLogs    CommunicationLog[]
  
  // Fase 4C: Tienda y Galer√≠a
  cartItems            CartItem[]
  orders               Order[]
  albumsCreated        PhotoAlbum[]
  
  // Horarios (profesores)
  schedules            Schedule[]   @relation("TeacherSchedules")
  
  // M√≥dulo Vocal de Grupo
  groupVocals          GroupVocal[] @relation("UserGroupVocals")
  fundsCreated         GroupFund[]  @relation("FundCreator")
  contributionsRecorded GroupFundContribution[] @relation("ContributionRecorder")
  expensesCreated      GroupExpense[] @relation("ExpenseCreator")
  groupAnnouncementsCreated GroupAnnouncement[] @relation("GroupAnnouncementCreator")
  groupAnnouncementReads GroupAnnouncementRead[]
  
  // Encuestas
  surveysCreated       Survey[]     @relation("SurveyCreator")
  surveyResponses      SurveyResponse[]
  
  // Inscripciones/Preinscripciones
  enrollmentsCreated   Enrollment[] @relation("EnrollmentCreator")
  enrollmentsReviewed  Enrollment[] @relation("EnrollmentReviewer")
  
  // Permisos/Justificantes
  permitRequestsCreated   PermitRequest[] @relation("PermitCreator")
  permitRequestsReviewed  PermitRequest[] @relation("PermitReviewer")
  
  // Nuevos m√≥dulos
  disciplineRecords       DisciplineRecord[] @relation("DisciplineRecorder")
  nurseVisits             NurseVisit[]       @relation("NurseRecorder")
  bulkImportJobs          BulkImportJob[]    @relation("ImportCreator")
  
  // Push Notifications
  pushSubscriptions       PushSubscription[] @relation("UserPushSubscriptions")
}

model Invitation {
  id            String           @id @default(cuid())
  email         String
  role          Role
  tempPassword  String
  schoolId      String
  school        School           @relation(fields: [schoolId], references: [id])
  status        InvitationStatus @default(PENDING)
  token         String           @unique @default(cuid())
  expiresAt     DateTime
  createdAt     DateTime         @default(now())
  acceptedAt    DateTime?
  user          User?

  @@unique([email, schoolId])
}

// Grupos escolares (ej: "3ro Primaria A", "2do Secundaria B")
model Group {
  id           String    @id @default(cuid())
  name         String    // "3ro Primaria A"
  grade        String?   // "3ro Primaria"
  section      String?   // "A"
  schoolId     String
  school       School    @relation(fields: [schoolId], references: [id])
  teacherId    String?   // Profesor titular
  teacher      User?     @relation("GroupTeacher", fields: [teacherId], references: [id])
  vocalId      String?   @unique // Vocal de grupo (un padre) - mantener por retrocompatibilidad
  vocal        User?     @relation("GroupVocal", fields: [vocalId], references: [id])
  students     Student[]
  conversations Conversation[]
  tasks        Task[]
  events       Event[]
  attendances  Attendance[]
  polls        Poll[]
  documents    Document[]
  photoAlbums  PhotoAlbum[]
  schedules    Schedule[]
  createdAt    DateTime  @default(now())
  isActive     Boolean   @default(true)
  
  // Sistema de m√∫ltiples vocales (hasta 2)
  groupVocals       GroupVocal[]
  
  // Sistema de colectas y fondos
  funds             GroupFund[]
  
  // Avisos espec√≠ficos del grupo (por vocales)
  groupAnnouncements GroupAnnouncement[]

  @@unique([name, schoolId])
}

// Estudiantes (alumnos)
model Student {
  id           String   @id @default(cuid())
  firstName    String
  lastName     String
  photoUrl     String?  // Foto de perfil para reconocimiento facial
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id])
  groupId      String?
  group        Group?   @relation(fields: [groupId], references: [id])
  parents      User[]   @relation("ParentChildren")
  
  // Usuario asociado (para alumnos con cuenta)
  userId       String?  @unique
  user         User?    @relation("StudentUser", fields: [userId], references: [id])
  
  submissions  Submission[]
  charges      Charge[]
  gradeDocuments GradeDocument[]
  attendances  Attendance[]
  appointments Appointment[] @relation("StudentAppointments")
  speiReference SpeiReference?
  photoTags    PhotoTag[]
  fundContributions GroupFundContribution[]
  permitRequests PermitRequest[]
  enrollment   Enrollment? @relation("EnrollmentStudent")
  
  // Nuevos m√≥dulos
  reportCards      ReportCard[]      @relation("StudentReportCards")
  disciplineRecords DisciplineRecord[] @relation("StudentDiscipline")
  nurseVisits      NurseVisit[]      @relation("StudentNurseVisits")
  medicalInfo      StudentMedicalInfo? @relation("StudentMedicalInfo")
  
  createdAt    DateTime @default(now())
  isActive     Boolean  @default(true)

  @@index([schoolId])
  @@index([groupId])
}

// Conversaciones (chats)
model Conversation {
  id           String           @id @default(cuid())
  type         ConversationType
  name         String?          // Para chats grupales
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id])
  groupId      String?          // Para chats de grupo escolar
  group        Group?           @relation(fields: [groupId], references: [id])
  participants ConversationParticipant[]
  messages     Message[]
  lastMessageAt DateTime?
  createdAt    DateTime         @default(now())
  isActive     Boolean          @default(true)

  @@index([schoolId])
  @@index([groupId])
  @@index([lastMessageAt])
}

// Participantes en conversaciones
model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  isMuted        Boolean      @default(false)
  lastReadAt     DateTime?
  joinedAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
}

// Mensajes
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  type           MessageType  @default(TEXT)
  content        String
  fileUrl        String?
  fileName       String?
  fileSize       Int?
  mimeType       String?
  isPinned       Boolean      @default(false)
  pinnedAt       DateTime?
  pinnedById     String?
  isEdited       Boolean      @default(false)
  createdAt      DateTime     @default(now())
  editedAt       DateTime?
  reactions      MessageReaction[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([conversationId, isPinned])
}

// Reacciones a mensajes
model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  emoji     String   // üëç, ‚ù§Ô∏è, üòÇ, üòÆ, üò¢, üôè
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model Announcement {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  title       String
  content     String
  priority    Priority @default(NORMAL)
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  reads       AnnouncementRead[]
}

model AnnouncementRead {
  id             String       @id @default(cuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  readAt         DateTime     @default(now())

  @@unique([announcementId, userId])
}

// ==================== M√ìDULO DE TAREAS ====================

enum TaskStatus {
  DRAFT       // Borrador
  PUBLISHED   // Publicada y visible
  CLOSED      // Cerrada, no acepta m√°s entregas
}

// ==================== M√ìDULO DE CALENDARIO ====================

enum EventType {
  ESCOLAR       // Evento escolar general
  REUNION       // Reuni√≥n de padres/junta
  CITA          // Cita individual
  FESTIVO       // D√≠a festivo/vacaciones
  ACADEMICO     // Ex√°menes, entrega de boletas
  EXTRACURRICULAR // Deportes, cultura, etc.
}

enum EventAttendeeStatus {
  PENDING
  CONFIRMED
  DECLINED
}

// ==================== M√ìDULO DE PAGOS ====================

enum PaymentStatus {
  PENDIENTE     // Pago pendiente
  PAGADO        // Pago completado
  VENCIDO       // Pago vencido
  PARCIAL       // Pago parcial
  CANCELADO     // Cargo cancelado
}

enum PaymentMethod {
  EFECTIVO
  TRANSFERENCIA
  SPEI          // Transferencia SPEI con referencia √∫nica
  TARJETA
  DEPOSITO
  OTRO
}

enum ChargeType {
  COLEGIATURA   // Mensualidad
  INSCRIPCION   // Inscripci√≥n
  MATERIAL      // Material escolar
  UNIFORME      // Uniforme
  EVENTO        // Eventos especiales
  TRANSPORTE    // Transporte escolar
  COMEDOR       // Comedor/Cafeter√≠a
  OTRO          // Otros cargos
}

enum SubmissionStatus {
  PENDING     // Entregada, pendiente de revisi√≥n
  REVIEWED    // Revisada con calificaci√≥n
  LATE        // Entregada tarde
  RETURNED    // Devuelta para correcciones
}

// Materias/Asignaturas
model Subject {
  id          String   @id @default(cuid())
  name        String   // "Matem√°ticas", "Espa√±ol", "Ciencias"
  color       String   @default("#1B4079") // Color para UI
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  tasks       Task[]
  schedules   Schedule[]
  reportCardGrades ReportCardGrade[] @relation("SubjectGrades")
  createdAt   DateTime @default(now())
  isActive    Boolean  @default(true)

  @@unique([name, schoolId])
  @@index([schoolId])
}

// Horarios de clases
model Schedule {
  id          String   @id @default(cuid())
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])
  groupId     String
  group       Group    @relation(fields: [groupId], references: [id])
  teacherId   String
  teacher     User     @relation("TeacherSchedules", fields: [teacherId], references: [id])
  dayOfWeek   Int      // 1=Lunes, 2=Martes, ..., 5=Viernes
  startTime   String   // "08:00"
  endTime     String   // "08:50"
  classroom   String?  // "Sal√≥n 101"
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([groupId])
  @@index([teacherId])
  @@index([schoolId])
  @@index([dayOfWeek])
}

// Tareas
model Task {
  id             String     @id @default(cuid())
  title          String
  description    String?    @db.Text
  instructions   String?    @db.Text
  status         TaskStatus @default(DRAFT)
  
  // Fechas
  dueDate        DateTime?  // Fecha l√≠mite de entrega
  publishedAt    DateTime?  // Cu√°ndo se public√≥
  closedAt       DateTime?  // Cu√°ndo se cerr√≥
  
  // Archivos adjuntos (material de apoyo)
  attachments    TaskAttachment[]
  
  // Puntuaci√≥n
  maxScore       Int        @default(100)  // Puntuaci√≥n m√°xima
  weight         Float      @default(1.0)  // Peso para promedio
  
  // Relaciones
  subjectId      String?
  subject        Subject?   @relation(fields: [subjectId], references: [id])
  groupId        String     // Grupo al que se asigna
  group          Group      @relation(fields: [groupId], references: [id])
  teacherId      String     // Profesor que cre√≥ la tarea
  teacher        User       @relation("TaskTeacher", fields: [teacherId], references: [id])
  
  submissions    Submission[]
  
  // Evento de calendario para fecha l√≠mite
  calendarEvent  Event?
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([groupId])
  @@index([teacherId])
  @@index([status])
  @@index([dueDate])
}

// Archivos adjuntos de tareas
model TaskAttachment {
  id              String   @id @default(cuid())
  taskId          String
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  fileName        String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  cloudStoragePath String?
  isPublic        Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([taskId])
}

// Entregas de tareas
model Submission {
  id              String           @id @default(cuid())
  taskId          String
  task            Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student          @relation(fields: [studentId], references: [id])
  
  // Contenido de la entrega
  content         String?          @db.Text  // Texto/comentarios del alumno
  attachments     SubmissionAttachment[]
  
  // Estado y calificaci√≥n
  status          SubmissionStatus @default(PENDING)
  score           Float?           // Calificaci√≥n obtenida
  feedback        String?          @db.Text  // Retroalimentaci√≥n del profesor
  
  // Fechas
  submittedAt     DateTime         @default(now())
  reviewedAt      DateTime?
  reviewedById    String?
  reviewedBy      User?            @relation("SubmissionReviewer", fields: [reviewedById], references: [id])
  isLate          Boolean          @default(false)
  
  updatedAt       DateTime         @updatedAt

  @@unique([taskId, studentId])
  @@index([taskId])
  @@index([studentId])
  @@index([status])
}

// Archivos adjuntos de entregas
model SubmissionAttachment {
  id              String     @id @default(cuid())
  submissionId    String
  submission      Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  fileName        String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  cloudStoragePath String?
  isPublic        Boolean    @default(false)
  createdAt       DateTime   @default(now())

  @@index([submissionId])
}

// Documentos de calificaciones (boletas, reportes)
model GradeDocument {
  id              String   @id @default(cuid())
  title           String   // "Boleta Primer Trimestre", "Reporte Anual"
  description     String?
  
  // Relaciones
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  uploadedById    String
  uploadedBy      User     @relation("GradeDocumentUploader", fields: [uploadedById], references: [id])
  
  // Archivo
  fileName        String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  cloudStoragePath String?
  isPublic        Boolean  @default(false)
  
  // Per√≠odo acad√©mico
  period          String?  // "2025-T1", "2025-2026"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([studentId])
  @@index([uploadedById])
}

// ==================== EVENTOS DE CALENDARIO ====================

model Event {
  id             String      @id @default(cuid())
  title          String
  description    String?     @db.Text
  
  // Fechas y horario
  startDate      DateTime
  endDate        DateTime?
  allDay         Boolean     @default(false)
  
  // Tipo y visualizaci√≥n
  type           EventType   @default(ESCOLAR)
  color          String      @default("#1B4079")
  location       String?     // Ubicaci√≥n (aula, auditorio, etc.)
  
  // Visibilidad
  isPublic       Boolean     @default(true)  // Visible para toda la escuela
  
  // Relaciones
  schoolId       String
  school         School      @relation(fields: [schoolId], references: [id])
  createdById    String
  createdBy      User        @relation("EventCreator", fields: [createdById], references: [id])
  groupId        String?     // Para eventos espec√≠ficos de un grupo
  group          Group?      @relation(fields: [groupId], references: [id])
  taskId         String?     @unique // Enlace a tarea (para fechas l√≠mite)
  task           Task?       @relation(fields: [taskId], references: [id])
  
  // Asistentes
  attendees      EventAttendee[]
  
  // Colecta vinculada (si aplica)
  linkedFund     GroupFund?   @relation("FundEvent")
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([schoolId])
  @@index([startDate])
  @@index([groupId])
  @@index([type])
}

// Asistentes a eventos
model EventAttendee {
  id           String              @id @default(cuid())
  eventId      String
  event        Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId       String
  user         User                @relation(fields: [userId], references: [id])
  status       EventAttendeeStatus @default(PENDING)
  responseAt   DateTime?
  createdAt    DateTime            @default(now())

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// ==================== CARGOS Y PAGOS ====================

// Cargos (colegiaturas, inscripciones, etc.)
model Charge {
  id             String        @id @default(cuid())
  concept        String        // Descripci√≥n del cargo
  type           ChargeType    @default(COLEGIATURA)
  amount         Float         // Monto total
  amountPaid     Float         @default(0) // Monto pagado
  status         PaymentStatus @default(PENDIENTE)
  
  // Fechas
  dueDate        DateTime      // Fecha l√≠mite de pago
  periodMonth    Int?          // Mes del periodo (1-12)
  periodYear     Int?          // A√±o del periodo
  
  // Relaciones
  studentId      String
  student        Student       @relation(fields: [studentId], references: [id])
  schoolId       String
  school         School        @relation(fields: [schoolId], references: [id])
  createdById    String
  createdBy      User          @relation("ChargeCreatedBy", fields: [createdById], references: [id])
  
  // Pagos asociados
  payments       Payment[]
  
  // Notas y observaciones
  notes          String?       @db.Text
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([studentId])
  @@index([schoolId])
  @@index([status])
  @@index([dueDate])
  @@index([type])
}

// Pagos realizados
model Payment {
  id             String        @id @default(cuid())
  amount         Float         // Monto del pago
  method         PaymentMethod @default(EFECTIVO)
  reference      String?       // Referencia de pago (# de transferencia, etc.)
  
  // Relaciones
  chargeId       String
  charge         Charge        @relation(fields: [chargeId], references: [id], onDelete: Cascade)
  recordedById   String        // Usuario que registr√≥ el pago (admin)
  recordedBy     User          @relation("PaymentRecordedBy", fields: [recordedById], references: [id])
  
  // Notas
  notes          String?       @db.Text
  
  // Comprobante de pago (opcional)
  receiptUrl     String?
  receiptPath    String?
  
  paidAt         DateTime      @default(now())
  createdAt      DateTime      @default(now())

  @@index([chargeId])
  @@index([paidAt])
}

// ==================== M√ìDULO DE ASISTENCIAS ====================

model Attendance {
  id           String           @id @default(cuid())
  date         DateTime         @db.Date  // Fecha de la asistencia
  status       AttendanceStatus @default(PRESENTE)
  notes        String?          // Notas opcionales (motivo de falta, etc.)
  
  // Relaciones
  studentId    String
  student      Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  groupId      String
  group        Group            @relation(fields: [groupId], references: [id])
  recordedById String           // Profesor que registr√≥
  recordedBy   User             @relation("AttendanceRecorder", fields: [recordedById], references: [id])
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@unique([studentId, date])  // Un registro por estudiante por d√≠a
  @@index([studentId])
  @@index([groupId])
  @@index([date])
}

// ==================== M√ìDULO DE ENCUESTAS (VOCAL) ====================

model Poll {
  id           String     @id @default(cuid())
  title        String
  description  String?    @db.Text
  status       PollStatus @default(ACTIVE)
  allowMultiple Boolean   @default(false)  // Permite seleccionar m√∫ltiples opciones
  isAnonymous  Boolean    @default(false)  // Votaci√≥n an√≥nima
  endsAt       DateTime?  // Fecha l√≠mite para votar
  
  // Relaciones
  groupId      String
  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdById  String     // Vocal que cre√≥ la encuesta
  createdBy    User       @relation("PollCreator", fields: [createdById], references: [id])
  
  options      PollOption[]
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([groupId])
  @@index([status])
}

model PollOption {
  id        String     @id @default(cuid())
  text      String
  pollId    String
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes     PollVote[]
  createdAt DateTime   @default(now())

  @@index([pollId])
}

model PollVote {
  id        String     @id @default(cuid())
  optionId  String
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  createdAt DateTime   @default(now())

  @@unique([optionId, userId])  // Un voto por usuario por opci√≥n
  @@index([optionId])
  @@index([userId])
}

// ==================== M√ìDULO DE FIRMA DIGITAL ====================

model Document {
  id              String         @id @default(cuid())
  title           String
  description     String?        @db.Text
  content         String         @db.Text   // Contenido HTML del documento
  type            DocumentType   @default(AUTORIZACION)
  status          DocumentStatus @default(DRAFT)
  
  // Archivo PDF generado (opcional)
  pdfUrl          String?
  pdfPath         String?
  
  // Fechas
  expiresAt       DateTime?      // Fecha de expiraci√≥n para firmar
  completedAt     DateTime?      // Fecha en que se complet√≥ la firma
  
  // Destinatarios
  targetRole      Role?          // Rol objetivo (PADRE, PROFESOR, etc.)
  groupId         String?        // Grupo espec√≠fico (opcional)
  group           Group?         @relation(fields: [groupId], references: [id])
  
  // Relaciones
  schoolId        String
  school          School         @relation(fields: [schoolId], references: [id])
  createdById     String
  createdBy       User           @relation("DocumentCreator", fields: [createdById], references: [id])
  
  signatures      DocumentSignature[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([schoolId])
  @@index([status])
  @@index([type])
  @@index([createdById])
}

model DocumentSignature {
  id              String    @id @default(cuid())
  documentId      String
  document        Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  // Datos de la firma
  signatureData   String?   @db.Text   // Firma digital (base64 o hash)
  signatureType   String    @default("ACCEPT") // ACCEPT (checkbox), DRAW (firma dibujada)
  ipAddress       String?                // IP desde donde se firm√≥
  userAgent       String?   @db.Text    // Navegador/dispositivo
  
  // Verificaci√≥n
  signedAt        DateTime  @default(now())
  verificationCode String   @unique @default(cuid()) // C√≥digo √∫nico de verificaci√≥n
  
  createdAt       DateTime  @default(now())

  @@unique([documentId, userId])  // Un usuario solo firma una vez por documento
  @@index([documentId])
  @@index([userId])
  @@index([verificationCode])
}

// ==================== CHATBOT IA ====================

model ChatbotConversation {
  id           String           @id @default(cuid())
  userId       String
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id])
  
  // M√©tricas
  messageCount Int              @default(0)
  topic        String?          // Tema principal detectado (pagos, tareas, calendario, etc.)
  resolved     Boolean          @default(false) // Si el usuario indic√≥ que su duda fue resuelta
  rating       Int?             // Calificaci√≥n 1-5
  
  messages     ChatbotMessage[]
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([userId])
  @@index([schoolId])
  @@index([createdAt])
}

model ChatbotMessage {
  id             String              @id @default(cuid())
  conversationId String
  conversation   ChatbotConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  role           String              // "user" | "assistant"
  content        String              @db.Text
  
  // M√©tricas
  responseTime   Int?                // Tiempo de respuesta en ms (solo para assistant)
  
  createdAt      DateTime            @default(now())

  @@index([conversationId])
}

// ==================== SUPER ADMIN - SISTEMA MULTI-ESCUELA ====================

// Configuraciones globales del sistema
model SystemConfig {
  id           String   @id @default(cuid())
  key          String   @unique  // Ej: "max_schools", "default_theme", "maintenance_mode"
  value        String   @db.Text // Valor como JSON string
  description  String?
  category     String   @default("general") // general, security, notifications, limits
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Configuraciones espec√≠ficas por escuela
model SchoolSettings {
  id               String   @id @default(cuid())
  schoolId         String   @unique
  school           School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // M√≥dulos habilitados
  modulesEnabled   String   @default("[\"announcements\",\"messages\",\"tasks\",\"calendar\",\"payments\",\"attendance\",\"documents\",\"chatbot\"]") // JSON array
  
  // L√≠mites
  maxUsers         Int      @default(500)
  maxStudents      Int      @default(1000)
  maxGroups        Int      @default(50)
  storageLimit     Int      @default(5120) // MB
  
  // Personalizaci√≥n
  customDomain     String?
  customCss        String?  @db.Text
  welcomeMessage   String?  @db.Text
  
  // Plan/Suscripci√≥n
  planType         String   @default("standard") // free, basic, standard, premium
  planExpiresAt    DateTime?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ==================== SISTEMA DE PAGOS SPEI ====================

// Configuraci√≥n bancaria de la escuela
model SchoolBankConfig {
  id            String   @id @default(cuid())
  schoolId      String   @unique
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  bankName      String   // Nombre del banco (ej: "BBVA", "Banorte")
  accountHolder String   // Nombre del titular
  clabe         String   // CLABE interbancaria (18 d√≠gitos)
  accountNumber String?  // N√∫mero de cuenta (opcional)
  
  // Prefijo para referencias (ej: "VS" para Vermont School)
  referencePrefix String @default("REF")
  
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Referencias SPEI √∫nicas por alumno
model SpeiReference {
  id              String   @id @default(cuid())
  studentId       String   @unique
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  schoolId        String
  
  // Referencia num√©rica √∫nica (ej: "VS240001")
  reference       String   @unique
  
  // Estado
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  
  @@index([reference])
}

// ==================== SISTEMA DE CITAS ====================

enum AppointmentStatus {
  PENDING      // Pendiente de confirmaci√≥n
  CONFIRMED    // Confirmada
  CANCELLED    // Cancelada
  COMPLETED    // Completada
  NO_SHOW      // No se present√≥
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// Disponibilidad semanal del profesor
model TeacherAvailability {
  id          String    @id @default(cuid())
  teacherId   String
  teacher     User      @relation("TeacherAvailability", fields: [teacherId], references: [id], onDelete: Cascade)
  dayOfWeek   DayOfWeek
  startTime   String    // "09:00" formato HH:mm
  endTime     String    // "10:00" formato HH:mm
  slotDuration Int      @default(30) // minutos por cita
  isActive    Boolean   @default(true)
  location    String?   // "Sala de maestros", "Aula 5", etc.
  notes       String?   // Notas adicionales
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([teacherId, dayOfWeek, startTime])
  @@index([teacherId])
  @@index([dayOfWeek])
}

// Citas agendadas
model Appointment {
  id              String            @id @default(cuid())
  teacherId       String
  teacher         User              @relation("TeacherAppointments", fields: [teacherId], references: [id])
  parentId        String
  parent          User              @relation("ParentAppointments", fields: [parentId], references: [id])
  studentId       String?
  student         Student?          @relation("StudentAppointments", fields: [studentId], references: [id])
  
  scheduledDate   DateTime          // Fecha de la cita
  startTime       String            // "09:00"
  endTime         String            // "09:30"
  status          AppointmentStatus @default(PENDING)
  
  subject         String            // Motivo de la cita
  notes           String?           @db.Text // Notas adicionales del padre
  teacherNotes    String?           @db.Text // Notas del profesor (despu√©s de la cita)
  location        String?           // Lugar de la cita
  
  // Videoconferencia
  isVideoCall     Boolean           @default(false)
  meetingUrl      String?           // URL de Jitsi Meet
  meetingRoomId   String?           // ID √∫nico de la sala
  
  // Notificaciones
  parentNotified  Boolean           @default(false)
  teacherNotified Boolean           @default(false)
  reminderSent    Boolean           @default(false)
  
  cancelledBy     String?           // userId de quien cancel√≥
  cancelReason    String?           // Raz√≥n de cancelaci√≥n
  cancelledAt     DateTime?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([teacherId])
  @@index([parentId])
  @@index([studentId])
  @@index([scheduledDate])
  @@index([status])
}

// Registro de actividad del sistema (Auditor√≠a)
model SystemAuditLog {
  id           String   @id @default(cuid())
  action       String   // CREATE_SCHOOL, UPDATE_SCHOOL, DEACTIVATE_SCHOOL, UPDATE_CONFIG, etc.
  entityType   String   // School, User, SystemConfig
  entityId     String?
  userId       String?  // Usuario que realiz√≥ la acci√≥n
  userEmail    String?
  details      String?  @db.Text // JSON con detalles adicionales
  ipAddress    String?
  userAgent    String?  @db.Text
  createdAt    DateTime @default(now())

  @@index([action])
  @@index([entityType])
  @@index([userId])
  @@index([createdAt])
}

// ==================== IMPORTACI√ìN CSV ====================

enum ImportStatus {
  PENDING      // Pendiente de procesar
  PROCESSING   // En proceso
  COMPLETED    // Completado exitosamente
  PARTIAL      // Completado con errores
  FAILED       // Fall√≥ completamente
}

enum ImportType {
  STUDENTS     // Importaci√≥n de alumnos
  PARENTS      // Importaci√≥n de padres
  TEACHERS     // Importaci√≥n de profesores
  GROUPS       // Importaci√≥n de grupos
  CHARGES      // Importaci√≥n de cargos/cobros
}

model ImportLog {
  id              String       @id @default(cuid())
  schoolId        String
  school          School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  type            ImportType
  status          ImportStatus @default(PENDING)
  
  // Estad√≠sticas
  totalRows       Int          @default(0)
  successRows     Int          @default(0)
  errorRows       Int          @default(0)
  
  // Archivo original
  fileName        String
  filePath        String?
  
  // Resultados detallados (JSON con errores por fila)
  errors          String?      @db.Text
  
  // Qui√©n import√≥
  importedById    String
  
  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime     @default(now())

  @@index([schoolId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ==================== M√âTRICAS Y REPORTES ====================

// Snapshots de m√©tricas diarias por escuela
model SchoolMetricsSnapshot {
  id                String   @id @default(cuid())
  schoolId          String
  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  date              DateTime @db.Date
  
  // Usuarios
  totalUsers        Int      @default(0)
  activeUsers       Int      @default(0) // Usuarios que iniciaron sesi√≥n este d√≠a
  totalParents      Int      @default(0)
  totalTeachers     Int      @default(0)
  totalStudents     Int      @default(0)
  
  // Grupos
  totalGroups       Int      @default(0)
  
  // Comunicaci√≥n
  messagesCount     Int      @default(0)
  announcementsCount Int     @default(0)
  
  // Acad√©mico
  tasksCreated      Int      @default(0)
  submissionsCount  Int      @default(0)
  averageAttendance Float?
  
  // Pagos
  chargesTotal      Float    @default(0)
  paymentsTotal     Float    @default(0)
  pendingPayments   Float    @default(0)
  
  // Chatbot
  chatbotQueries    Int      @default(0)
  chatbotResolved   Int      @default(0)
  
  // Citas
  appointmentsScheduled Int  @default(0)
  appointmentsCompleted Int  @default(0)
  
  createdAt         DateTime @default(now())

  @@unique([schoolId, date])
  @@index([schoolId])
  @@index([date])
}


// ==========================================
// FASE 4B: COMUNICACI√ìN - TRADUCCIONES Y CRM
// ==========================================

enum Language {
  ES  // Espa√±ol
  EN  // English
  PT  // Portugu√™s
  DE  // Deutsch
  FR  // Fran√ßais
  JA  // Êó•Êú¨Ë™û
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

enum CampaignType {
  EMAIL
  PUSH
  SMS
}

// Preferencias de idioma del usuario
model UserLanguagePreference {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  language  Language @default(ES)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Segmentos de usuarios para CRM
model CrmSegment {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name        String
  description String?
  filters     Json     // Filtros din√°micos: { role: [], groupId: [], hasUnpaidCharges: true, etc }
  userCount   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  campaigns   CrmCampaign[]

  @@index([schoolId])
}

// Campa√±as de comunicaci√≥n
model CrmCampaign {
  id           String         @id @default(cuid())
  schoolId     String
  school       School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  segmentId    String?
  segment      CrmSegment?    @relation(fields: [segmentId], references: [id])
  name         String
  subject      String
  content      String         @db.Text
  type         CampaignType   @default(EMAIL)
  status       CampaignStatus @default(DRAFT)
  scheduledAt  DateTime?
  sentAt       DateTime?
  totalRecipients Int         @default(0)
  deliveredCount  Int         @default(0)
  openedCount     Int         @default(0)
  clickedCount    Int         @default(0)
  createdById  String
  createdBy    User           @relation(fields: [createdById], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  recipients   CrmCampaignRecipient[]

  @@index([schoolId])
  @@index([status])
  @@index([scheduledAt])
}

// Destinatarios de campa√±as
model CrmCampaignRecipient {
  id          String      @id @default(cuid())
  campaignId  String
  campaign    CrmCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  email       String
  status      String      @default("pending") // pending, sent, delivered, opened, clicked, bounced, failed
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  createdAt   DateTime    @default(now())

  @@unique([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@index([status])
}

// Plantillas de email
model EmailTemplate {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name        String
  subject     String
  content     String   @db.Text
  category    String?  // welcome, reminder, announcement, etc
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([schoolId])
  @@index([category])
}

// Historial de comunicaciones enviadas
model CommunicationLog {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // email, sms, push
  subject     String?
  content     String   @db.Text
  status      String   // sent, delivered, failed, bounced
  metadata    Json?    // Info adicional como IP, dispositivo, etc
  sentAt      DateTime @default(now())
  
  @@index([schoolId])
  @@index([userId])
  @@index([sentAt])
}


// ==========================================
// FASE 4C: COMERCIO Y MEDIOS
// ==========================================

// ---------- TIENDA ESCOLAR ----------

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum OrderStatus {
  PENDING      // Pedido creado, esperando pago
  PAID         // Pago confirmado
  PROCESSING   // En preparaci√≥n
  READY        // Listo para entrega
  DELIVERED    // Entregado
  CANCELLED    // Cancelado
}

// Categor√≠as de productos
model StoreCategory {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name        String
  description String?
  imageUrl    String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  products    StoreProduct[]

  @@index([schoolId])
}

// Productos de la tienda
model StoreProduct {
  id          String        @id @default(cuid())
  schoolId    String
  school      School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  categoryId  String
  category    StoreCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name        String
  description String?       @db.Text
  price       Float
  imageUrl    String?
  sku         String?       // C√≥digo de producto
  stock       Int           @default(0)
  status      ProductStatus @default(ACTIVE)
  sizes       String[]      @default([]) // Tallas disponibles: ["XS", "S", "M", "L", "XL"]
  colors      String[]      @default([]) // Colores disponibles
  isRequired  Boolean       @default(false) // Si es uniforme obligatorio
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@index([schoolId])
  @@index([categoryId])
  @@index([status])
}

// Carrito de compras
model CartItem {
  id        String       @id @default(cuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int          @default(1)
  size      String?      // Talla seleccionada
  color     String?      // Color seleccionado
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([userId, productId, size, color])
  @@index([userId])
}

// √ìrdenes/Pedidos
model Order {
  id           String      @id @default(cuid())
  orderNumber  String      @unique // N√∫mero de pedido legible
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId     String
  school       School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subtotal     Float
  discount     Float       @default(0)
  total        Float
  status       OrderStatus @default(PENDING)
  paymentMethod String?    // spei, card, cash
  paymentReference String? // Referencia de pago
  paidAt       DateTime?
  notes        String?     @db.Text
  deliveryDate DateTime?   // Fecha estimada de entrega
  deliveredAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  items        OrderItem[]

  @@index([userId])
  @@index([schoolId])
  @@index([status])
  @@index([orderNumber])
}

// Items de una orden
model OrderItem {
  id         String       @id @default(cuid())
  orderId    String
  order      Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId  String
  product    StoreProduct @relation(fields: [productId], references: [id])
  quantity   Int
  unitPrice  Float
  size       String?
  color      String?
  createdAt  DateTime     @default(now())

  @@index([orderId])
}

// ---------- GALER√çA DE FOTOS ----------

enum AlbumVisibility {
  PUBLIC       // Visible para todos los padres de la escuela
  GROUP_ONLY   // Solo para padres del grupo espec√≠fico
  PRIVATE      // Solo admins
}

// √Ålbumes de fotos
model PhotoAlbum {
  id          String          @id @default(cuid())
  schoolId    String
  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  groupId     String?         // Opcional: √°lbum de un grupo espec√≠fico
  group       Group?          @relation(fields: [groupId], references: [id])
  title       String
  description String?         @db.Text
  coverUrl    String?         // Imagen de portada
  eventDate   DateTime?       // Fecha del evento
  visibility  AlbumVisibility @default(PUBLIC)
  photoCount  Int             @default(0)
  isActive    Boolean         @default(true)
  createdById String
  createdBy   User            @relation(fields: [createdById], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  photos      Photo[]

  @@index([schoolId])
  @@index([groupId])
  @@index([eventDate])
}

// Fotos individuales
model Photo {
  id           String      @id @default(cuid())
  albumId      String
  album        PhotoAlbum  @relation(fields: [albumId], references: [id], onDelete: Cascade)
  url          String      // URL de la imagen
  thumbnailUrl String?     // Miniatura
  caption      String?
  takenAt      DateTime?   // Fecha en que se tom√≥ la foto
  width        Int?
  height       Int?
  fileSize     Int?        // Tama√±o en bytes
  order        Int         @default(0)
  isProcessed  Boolean     @default(false) // Si ya se proces√≥ para reconocimiento facial
  createdAt    DateTime    @default(now())
  tags         PhotoTag[]

  @@index([albumId])
}

// Etiquetas de fotos (reconocimiento facial)
model PhotoTag {
  id         String   @id @default(cuid())
  photoId    String
  photo      Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  studentId  String?  // Si se identific√≥ a un estudiante
  student    Student? @relation(fields: [studentId], references: [id])
  x          Float?   // Coordenada X del rostro (porcentaje)
  y          Float?   // Coordenada Y del rostro
  width      Float?   // Ancho del √°rea (porcentaje)
  height     Float?   // Alto del √°rea
  confidence Float?   // Confianza del reconocimiento (0-1)
  isManual   Boolean  @default(false) // Si fue etiquetado manualmente
  createdAt  DateTime @default(now())

  @@index([photoId])
  @@index([studentId])
}

// ==========================================
// M√ìDULO VOCAL DE GRUPO
// ==========================================

enum FundStatus {
  ACTIVE       // Colecta activa
  PAUSED       // Colecta pausada
  COMPLETED    // Colecta completada (meta alcanzada o cerrada)
  CANCELLED    // Colecta cancelada
}

enum ContributionStatus {
  PENDING      // Pago pendiente
  PAID         // Pago confirmado
  EXEMPT       // Exento de pago
}

// Vocales de grupo (hasta 2 por grupo)
model GroupVocal {
  id           String   @id @default(cuid())
  groupId      String
  group        Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId       String
  user         User     @relation("UserGroupVocals", fields: [userId], references: [id])
  isPrimary    Boolean  @default(false)  // Vocal principal
  isActive     Boolean  @default(true)
  assignedAt   DateTime @default(now())
  
  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

// Colectas/Fondos del grupo
model GroupFund {
  id              String     @id @default(cuid())
  groupId         String
  group           Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdById     String     // Vocal que cre√≥ la colecta
  createdBy       User       @relation("FundCreator", fields: [createdById], references: [id])
  
  title           String     // "D√≠a de San Valent√≠n", "Venta de Recreo"
  description     String?    @db.Text
  
  // Montos
  amountPerStudent Float     // Monto por alumno
  goalAmount      Float?     // Meta total (opcional)
  totalCollected  Float      @default(0) // Total recaudado
  
  // Fechas
  dueDate         DateTime?  // Fecha l√≠mite de pago
  eventDate       DateTime?  // Fecha del evento asociado
  
  // Estado
  status          FundStatus @default(ACTIVE)
  
  // Vinculaci√≥n con actividad/evento
  linkedEventId   String?    @unique
  linkedEvent     Event?     @relation("FundEvent", fields: [linkedEventId], references: [id])
  
  contributions   GroupFundContribution[]
  expenses        GroupExpense[]
  announcements   GroupAnnouncement[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([groupId])
  @@index([status])
  @@index([dueDate])
}

// Contribuciones/Pagos a colectas
model GroupFundContribution {
  id              String             @id @default(cuid())
  fundId          String
  fund            GroupFund          @relation(fields: [fundId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student            @relation(fields: [studentId], references: [id])
  
  amount          Float              // Monto pagado
  status          ContributionStatus @default(PENDING)
  
  // Detalles del pago
  paidAt          DateTime?
  paymentMethod   String?            // "efectivo", "transferencia"
  paymentReference String?           // Referencia de pago
  
  // Recibo
  receiptUrl      String?
  receiptPath     String?
  
  // Qui√©n registr√≥ el pago
  recordedById    String?
  recordedBy      User?              @relation("ContributionRecorder", fields: [recordedById], references: [id])
  
  notes           String?
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  @@unique([fundId, studentId])
  @@index([fundId])
  @@index([studentId])
  @@index([status])
}

// Gastos del fondo (transparencia)
model GroupExpense {
  id              String     @id @default(cuid())
  fundId          String
  fund            GroupFund  @relation(fields: [fundId], references: [id], onDelete: Cascade)
  createdById     String     // Vocal que registr√≥ el gasto
  createdBy       User       @relation("ExpenseCreator", fields: [createdById], references: [id])
  
  concept         String     // "Compra de dulces", "Decoraciones"
  amount          Float
  
  // Comprobante
  receiptUrl      String?
  receiptPath     String?
  
  expenseDate     DateTime   @default(now())
  notes           String?
  
  createdAt       DateTime   @default(now())
  
  @@index([fundId])
  @@index([expenseDate])
}

// Avisos espec√≠ficos del grupo (por vocales)
model GroupAnnouncement {
  id           String   @id @default(cuid())
  groupId      String
  group        Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdById  String   // Vocal que cre√≥ el aviso
  createdBy    User     @relation("GroupAnnouncementCreator", fields: [createdById], references: [id])
  
  title        String
  content      String   @db.Text
  
  // Archivos adjuntos
  attachmentUrl  String?
  attachmentName String?
  
  // Vinculaci√≥n con colecta (opcional)
  linkedFundId String?
  linkedFund   GroupFund? @relation(fields: [linkedFundId], references: [id])
  
  isPinned     Boolean  @default(false)
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  reads        GroupAnnouncementRead[]
  
  @@index([groupId])
  @@index([createdAt])
}

// Lectura de avisos de grupo
model GroupAnnouncementRead {
  id             String            @id @default(cuid())
  announcementId String
  announcement   GroupAnnouncement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User              @relation(fields: [userId], references: [id])
  readAt         DateTime          @default(now())
  
  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
}

// ===============================
// M√ìDULO: Encuestas y NPS
// ===============================

enum SurveyType {
  NPS           // Net Promoter Score (0-10)
  SATISFACTION  // Satisfacci√≥n general (1-5 estrellas)
  FEEDBACK      // Encuesta con preguntas abiertas
  POLL          // Votaci√≥n simple
}

enum SurveyStatus {
  DRAFT
  ACTIVE
  CLOSED
  ARCHIVED
}

model Survey {
  id          String       @id @default(cuid())
  schoolId    String
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User         @relation("SurveyCreator", fields: [createdById], references: [id])
  
  title       String
  description String?      @db.Text
  type        SurveyType   @default(SATISFACTION)
  status      SurveyStatus @default(DRAFT)
  
  // Preguntas (JSON para flexibilidad)
  questions   Json         // [{ id, text, type: "rating"|"text"|"choice", options?: string[] }]
  
  // Audiencia
  targetRoles String[]     @default(["PADRE"]) // Roles que pueden responder
  targetGroups String[]    @default([])        // IDs de grupos espec√≠ficos (vac√≠o = todos)
  
  // Fechas
  startsAt    DateTime?
  endsAt      DateTime?
  
  // Estad√≠sticas cacheadas
  responseCount Int        @default(0)
  averageScore  Float?     // Para NPS/Satisfaction
  
  isAnonymous Boolean      @default(true)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  responses   SurveyResponse[]
  
  @@index([schoolId])
  @@index([status])
  @@index([type])
}

model SurveyResponse {
  id         String   @id @default(cuid())
  surveyId   String
  survey     Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  userId     String?  // Null si es an√≥nimo
  user       User?    @relation(fields: [userId], references: [id])
  
  // Respuestas (JSON)
  answers    Json     // { questionId: answer }
  
  // Para NPS/Satisfaction
  score      Int?     // 0-10 para NPS, 1-5 para satisfacci√≥n
  
  // Metadata
  ipHash     String?  // Hash del IP para evitar duplicados an√≥nimos
  userAgent  String?
  
  createdAt  DateTime @default(now())
  
  @@unique([surveyId, userId])
  @@index([surveyId])
  @@index([score])
}

// ===============================
// M√ìDULO: Inscripciones Online
// ===============================

enum EnrollmentStatus {
  PENDING       // Solicitud enviada
  REVIEWING     // En revisi√≥n
  DOCUMENTS     // Pendiente de documentos
  INTERVIEW     // Pendiente de entrevista
  ACCEPTED      // Aceptado
  REJECTED      // Rechazado
  WAITLIST      // Lista de espera
  ENROLLED      // Inscrito (completado)
  CANCELLED     // Cancelado por padre
}

model Enrollment {
  id           String           @id @default(cuid())
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Datos del solicitante (padre/tutor)
  parentName   String
  parentEmail  String
  parentPhone  String
  relationship String           // "madre", "padre", "tutor"
  
  // Datos del estudiante
  studentName  String
  studentBirthDate DateTime
  studentGender String?         // "M", "F", "Otro"
  currentSchool String?         // Escuela actual
  currentGrade String?          // Grado actual
  
  // Grado solicitado
  requestedGrade String         // "1ro Primaria", "Kinder 3", etc.
  requestedYear  Int            // Ciclo escolar: 2026, 2027, etc.
  
  // Informaci√≥n adicional
  siblings      String?         @db.Text // ¬øTiene hermanos en la escuela?
  howDidYouHear String?         // ¬øC√≥mo conoci√≥ la escuela?
  specialNeeds  String?         @db.Text // Necesidades especiales
  comments      String?         @db.Text
  
  // Documentos subidos
  documents     Json?           // [{ name, url, type }]
  
  // Estado y seguimiento
  status        EnrollmentStatus @default(PENDING)
  priority      Int              @default(0) // Prioridad de lista de espera
  
  // Entrevista
  interviewDate DateTime?
  interviewNotes String?        @db.Text
  
  // Revisi√≥n
  reviewedById  String?
  reviewedBy    User?           @relation("EnrollmentReviewer", fields: [reviewedById], references: [id])
  reviewedAt    DateTime?
  rejectionReason String?       @db.Text
  
  // Admin que proces√≥
  createdById   String?         // Si lo cre√≥ un admin
  createdBy     User?           @relation("EnrollmentCreator", fields: [createdById], references: [id])
  
  // Vinculaci√≥n con estudiante (cuando se inscribe)
  enrolledStudentId String?     @unique
  enrolledStudent   Student?    @relation("EnrollmentStudent", fields: [enrolledStudentId], references: [id])
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([schoolId])
  @@index([status])
  @@index([parentEmail])
  @@index([requestedYear])
}

// ===============================
// M√ìDULO: Permisos y Justificantes
// ===============================

enum PermitType {
  ABSENCE       // Justificante de ausencia
  EARLY_EXIT    // Permiso de salida temprana
  LATE_ARRIVAL  // Permiso de llegada tarde
  MEDICAL       // Permiso m√©dico
  FIELD_TRIP    // Autorizaci√≥n para salida escolar
  PHOTO_VIDEO   // Autorizaci√≥n foto/video
  OTHER         // Otro
}

enum PermitStatus {
  PENDING       // Pendiente de revisi√≥n
  APPROVED      // Aprobado
  REJECTED      // Rechazado
  EXPIRED       // Expirado (no procesado a tiempo)
}

model PermitRequest {
  id           String       @id @default(cuid())
  schoolId     String
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentId    String
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdById  String
  createdBy    User         @relation("PermitCreator", fields: [createdById], references: [id])
  
  type         PermitType
  status       PermitStatus @default(PENDING)
  
  // Detalles
  title        String
  reason       String       @db.Text
  
  // Fechas del permiso
  startDate    DateTime     // Fecha de inicio del permiso
  endDate      DateTime?    // Fecha fin (null si es solo un d√≠a)
  startTime    String?      // Hora (para salida temprana/llegada tarde)
  endTime      String?
  
  // Documentos de soporte
  attachmentUrl  String?
  attachmentName String?
  
  // Revisi√≥n
  reviewedById String?
  reviewedBy   User?        @relation("PermitReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  reviewNotes  String?
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@index([type])
  @@index([startDate])
}

// ==========================================
// BOLETAS DE CALIFICACIONES
// ==========================================

enum ReportCardPeriod {
  BIMESTRE_1
  BIMESTRE_2
  BIMESTRE_3
  BIMESTRE_4
  BIMESTRE_5
  TRIMESTRE_1
  TRIMESTRE_2
  TRIMESTRE_3
  SEMESTRE_1
  SEMESTRE_2
  ANUAL
}

enum ReportCardStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model ReportCard {
  id           String            @id @default(cuid())
  studentId    String
  student      Student           @relation("StudentReportCards", fields: [studentId], references: [id])
  schoolId     String
  school       School            @relation("SchoolReportCards", fields: [schoolId], references: [id])
  
  schoolYear   String            // "2025-2026"
  period       ReportCardPeriod
  status       ReportCardStatus  @default(DRAFT)
  
  // Promedios calculados
  finalAverage Float?
  attendance   Float?            // Porcentaje de asistencia
  absences     Int               @default(0)
  tardies      Int               @default(0)
  
  // Comentarios generales
  teacherComments String?        @db.Text
  principalComments String?      @db.Text
  
  // PDF generado
  pdfUrl       String?
  generatedAt  DateTime?
  publishedAt  DateTime?
  
  // Calificaciones por materia
  grades       ReportCardGrade[]
  
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  @@unique([studentId, schoolYear, period])
  @@index([schoolId])
  @@index([status])
}

model ReportCardGrade {
  id           String      @id @default(cuid())
  reportCardId String
  reportCard   ReportCard  @relation(fields: [reportCardId], references: [id], onDelete: Cascade)
  subjectId    String
  subject      Subject     @relation("SubjectGrades", fields: [subjectId], references: [id])
  
  grade        Float       // Calificaci√≥n num√©rica
  gradeText    String?     // Calificaci√≥n textual (A, B, C / Excelente, Bueno)
  comments     String?     // Comentarios del profesor
  
  @@unique([reportCardId, subjectId])
}

// ==========================================
// SISTEMA DE DISCIPLINA
// ==========================================

enum DisciplineType {
  POSITIVE          // Reconocimiento positivo
  WARNING           // Advertencia verbal
  WRITTEN_WARNING   // Amonestaci√≥n escrita
  DETENTION         // Detenci√≥n
  SUSPENSION        // Suspensi√≥n
  PARENT_MEETING    // Cita con padres
  OTHER
}

enum DisciplineSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model DisciplineRecord {
  id           String             @id @default(cuid())
  studentId    String
  student      Student            @relation("StudentDiscipline", fields: [studentId], references: [id])
  schoolId     String
  school       School             @relation("SchoolDiscipline", fields: [schoolId], references: [id])
  
  type         DisciplineType
  severity     DisciplineSeverity @default(MEDIUM)
  
  // Detalles del incidente
  date         DateTime
  description  String             @db.Text
  location     String?            // Lugar del incidente
  witnesses    String?            // Testigos
  
  // Puntos de conducta (positivos o negativos)
  points       Int                @default(0)
  
  // Acci√≥n tomada
  actionTaken  String?            @db.Text
  
  // Seguimiento
  parentNotified Boolean          @default(false)
  parentNotifiedAt DateTime?
  parentResponse String?          @db.Text
  resolved     Boolean            @default(false)
  resolvedAt   DateTime?
  
  // Evidencia/Adjuntos
  attachmentUrl String?
  
  // Registrado por
  recordedById String
  recordedBy   User               @relation("DisciplineRecorder", fields: [recordedById], references: [id])
  
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  
  @@index([studentId])
  @@index([schoolId])
  @@index([date])
  @@index([type])
}

// ==========================================
// M√ìDULO DE ENFERMER√çA
// ==========================================

enum NurseVisitType {
  ILLNESS           // Enfermedad
  INJURY            // Lesi√≥n/Accidente
  MEDICATION        // Administraci√≥n de medicamento
  CHECKUP           // Revisi√≥n rutinaria
  EMERGENCY         // Emergencia
  MENTAL_HEALTH     // Salud mental/emocional
  OTHER
}

enum NurseVisitStatus {
  IN_PROGRESS       // En atenci√≥n
  RETURNED_CLASS    // Regres√≥ a clase
  SENT_HOME         // Enviado a casa
  EMERGENCY_TRANSFER // Transferido a emergencias
  COMPLETED
}

model NurseVisit {
  id           String           @id @default(cuid())
  studentId    String
  student      Student          @relation("StudentNurseVisits", fields: [studentId], references: [id])
  schoolId     String
  school       School           @relation("SchoolNurseVisits", fields: [schoolId], references: [id])
  
  type         NurseVisitType
  status       NurseVisitStatus @default(IN_PROGRESS)
  
  // Tiempos
  arrivalTime  DateTime         @default(now())
  departureTime DateTime?
  
  // S√≠ntomas y diagn√≥stico
  chiefComplaint String          // Motivo principal de consulta
  symptoms     String?           @db.Text
  vitalSigns   String?           // Temperatura, presi√≥n, etc. (JSON)
  assessment   String?           @db.Text
  
  // Tratamiento
  treatment    String?           @db.Text
  medicationGiven String?        // Medicamentos administrados
  
  // Seguimiento
  followUpRequired Boolean       @default(false)
  followUpNotes String?          @db.Text
  
  // Comunicaci√≥n con padres
  parentNotified Boolean         @default(false)
  parentNotifiedAt DateTime?
  parentNotifiedBy String?       // Nombre de quien notific√≥
  parentResponse String?
  
  // En caso de emergencia
  emergencyContact String?       // Contacto de emergencia usado
  emergencyNotes String?         @db.Text
  
  // Archivo/Evidencia
  attachmentUrl String?
  
  // Registrado por
  recordedById String
  recordedBy   User              @relation("NurseRecorder", fields: [recordedById], references: [id])
  
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  @@index([studentId])
  @@index([schoolId])
  @@index([arrivalTime])
  @@index([type])
  @@index([status])
}

// Historial m√©dico del estudiante (informaci√≥n b√°sica)
model StudentMedicalInfo {
  id           String   @id @default(cuid())
  studentId    String   @unique
  student      Student  @relation("StudentMedicalInfo", fields: [studentId], references: [id])
  
  // Informaci√≥n b√°sica
  bloodType    String?
  allergies    String?  @db.Text
  medications  String?  @db.Text  // Medicamentos que toma regularmente
  conditions   String?  @db.Text  // Condiciones m√©dicas
  
  // Contactos de emergencia
  emergencyContact1Name  String?
  emergencyContact1Phone String?
  emergencyContact1Relation String?
  emergencyContact2Name  String?
  emergencyContact2Phone String?
  emergencyContact2Relation String?
  
  // Doctor/Hospital preferido
  doctorName   String?
  doctorPhone  String?
  preferredHospital String?
  insuranceInfo String?
  
  // Notas adicionales
  notes        String?  @db.Text
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ==========================================
// IMPORTACI√ìN MASIVA
// ==========================================

enum ImportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

enum ImportJobType {
  STUDENTS
  PARENTS
  TEACHERS
  GROUPS
  SUBJECTS
  GRADES
}

model BulkImportJob {
  id           String          @id @default(cuid())
  schoolId     String
  school       School          @relation("SchoolImports", fields: [schoolId], references: [id])
  
  type         ImportJobType
  status       ImportJobStatus @default(PENDING)
  
  // Archivo original
  fileName     String
  fileUrl      String?
  
  // Resultados
  totalRows    Int             @default(0)
  successCount Int             @default(0)
  errorCount   Int             @default(0)
  errors       String?         @db.Text  // JSON con errores detallados
  
  // Procesamiento
  startedAt    DateTime?
  completedAt  DateTime?
  
  // Usuario que inici√≥
  createdById  String
  createdBy    User            @relation("ImportCreator", fields: [createdById], references: [id])
  
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  
  @@index([schoolId])
  @@index([status])
}

// Push Notifications
model PushSubscription {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation("UserPushSubscriptions", fields: [userId], references: [id], onDelete: Cascade)
  
  endpoint     String   @unique
  p256dh       String   @db.Text
  auth         String
  
  // Device info
  userAgent    String?
  deviceType   String?  // mobile, desktop, tablet
  
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([userId])
  @@index([isActive])
}