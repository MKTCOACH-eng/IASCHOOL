generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/iaschool_app/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN   // Administrador global del sistema (multi-escuela)
  ADMIN
  PROFESOR
  PADRE
  ALUMNO
  VOCAL
}

// Subroles para administradores (permisos espec√≠ficos)
enum AdminSubRole {
  DIRECCION         // Director/Subdirector - acceso total
  CAJA              // Caja/Tesorer√≠a - pagos, becas, cobranza
  ENFERMERIA        // Enfermer√≠a - visitas m√©dicas, historial m√©dico
  PSICOLOGIA        // Psicolog√≠a - seguimiento emocional, alertas
  CONSEJO_COMITE    // Consejo/Comit√© - disciplina, decisiones
  COORDINACION      // Coordinaci√≥n acad√©mica
  RECEPCION         // Recepci√≥n - autorizados, permisos entrada/salida
  SISTEMAS          // Sistemas - configuraciones t√©cnicas
}

enum AttendanceStatus {
  PRESENTE
  AUSENTE
  TARDANZA
  JUSTIFICADO
}

enum PollStatus {
  ACTIVE
  CLOSED
}

enum DocumentStatus {
  DRAFT           // Borrador
  PENDING         // Pendiente de firma
  PARTIALLY_SIGNED // Firmado parcialmente
  COMPLETED       // Completamente firmado
  EXPIRED         // Expirado
  CANCELLED       // Cancelado
}

enum DocumentType {
  PERMISO           // Permiso de salida/actividad
  AUTORIZACION      // Autorizaci√≥n general
  REGLAMENTO        // Reglamento escolar
  CONTRATO          // Contrato de servicios
  CONSTANCIA        // Constancia
  CIRCULAR          // Circular informativa
  OTRO              // Otro tipo
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum Priority {
  NORMAL
  URGENT
}

enum ConversationType {
  DIRECT           // Chat 1:1 (padre-profesor, padre-admin)
  GROUP_PARENTS    // Chat de padres de un grupo escolar
  GROUP_STUDENTS   // Chat de alumnos de un grupo escolar
  TEAM             // Chat de equipo de trabajo (alumnos)
  ADMIN_CHANNEL    // Canal oficial del colegio
}

enum MessageType {
  TEXT
  FILE
  IMAGE
  SYSTEM
}

model School {
  id           String         @id @default(cuid())
  name         String
  code         String         @unique
  logoUrl      String?
  primaryColor String         @default("#1B4079")
  secondaryColor String?      @default("#CBDF90")
  address      String?
  phone        String?
  email        String?
  website      String?
  description  String?        @db.Text
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @default(now()) @updatedAt
  users        User[]
  announcements Announcement[]
  invitations  Invitation[]
  groups       Group[]
  students     Student[]
  conversations Conversation[]
  subjects     Subject[]
  events       Event[]
  charges      Charge[]
  documents    Document[]
  chatbotConversations ChatbotConversation[]
  settings     SchoolSettings?
  bankConfig   SchoolBankConfig?
  
  // Fase 4B: CRM y Comunicaci√≥n
  crmSegments      CrmSegment[]
  crmCampaigns     CrmCampaign[]
  emailTemplates   EmailTemplate[]
  communicationLogs CommunicationLog[]
  metricsSnapshots SchoolMetricsSnapshot[]
  importLogs       ImportLog[]
  
  // Fase 4C: Tienda y Galer√≠a
  storeCategories  StoreCategory[]
  storeProducts    StoreProduct[]
  orders           Order[]
  photoAlbums      PhotoAlbum[]
  schedules        Schedule[]
  surveys          Survey[]
  enrollments      Enrollment[]
  permitRequests   PermitRequest[]
  
  // Nuevos m√≥dulos
  reportCards      ReportCard[]      @relation("SchoolReportCards")
  disciplineRecords DisciplineRecord[] @relation("SchoolDiscipline")
  nurseVisits      NurseVisit[]      @relation("SchoolNurseVisits")
  bulkImportJobs   BulkImportJob[]   @relation("SchoolImports")
  
  // Becas y descuentos
  scholarships     Scholarship[]     @relation("SchoolScholarships")
  
  // M√≥dulo Psicoemocional
  psychologicalRecords PsychologicalRecord[] @relation("SchoolPsychological")
  
  // T√©rminos y Condiciones
  terms            TermsAndConditions[] @relation("SchoolTerms")
  
  // Suscripci√≥n
  subscription     SchoolSubscription?  @relation("SchoolSubscription")
  agreement        SchoolAgreement?     @relation("SchoolAgreement")
  
  // Programa de Afiliados
  affiliateReferrals AffiliateReferral[] @relation("SchoolAffiliates")
  
  // Comedor
  cafeteriaMenus   CafeteriaMenu[]      @relation("SchoolCafeteria")
  
  // Rendimiento de Profesores
  teacherMetrics   TeacherPerformanceMetric[] @relation("SchoolTeacherPerformance")
  teacherReviews   TeacherPerformanceReview[] @relation("SchoolTeacherReviews")
  
  // Reportes
  reportSchedules  ReportSchedule[]     @relation("SchoolReportSchedules")
  reportExecutions ReportExecution[]    @relation("SchoolReportExecutions")
  
  // Proveedores
  vendors          Vendor[]             @relation("SchoolVendors")
  
  // Configuraci√≥n de Env√≠os
  shippingConfig   ShippingConfig?      @relation("SchoolShippingConfig")
  
  // Configuraci√≥n de Cargo por Servicio
  serviceFeeConfig ServiceFeeConfig?    @relation("SchoolServiceFeeConfig")
  
  // Sistema de Soporte
  supportTickets   SupportTicket[]      @relation("SchoolSupportTickets")
  
  // Reminders IA
  reminderConfigs  ReminderConfig[]     @relation("SchoolReminderConfigs")
  reminderLogs     ReminderLog[]        @relation("SchoolReminderLogs")
  
  // Programa de Referidos Escolar
  referralProgram  SchoolReferralProgram? @relation("SchoolReferralProgram")
  schoolReferrals  SchoolReferral[]     @relation("SchoolReferralsReceived")
  
  // Ciclos Escolares
  schoolCycles     SchoolCycle[]        @relation("SchoolCycles")
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  password           String
  name               String
  phone              String?
  role               Role     @default(PADRE)
  adminSubRoles      AdminSubRole[] @default([])  // Subroles para ADMIN (m√∫ltiples permitidos)
  schoolId           String?
  school             School?  @relation(fields: [schoolId], references: [id])
  mustChangePassword Boolean  @default(false)
  profileCompleted   Boolean  @default(false)
  onboardingCompleted Boolean @default(false)
  preferredLanguage  String   @default("es")
  createdAt          DateTime @default(now())
  announcements      Announcement[] @relation("CreatedBy")
  reads              AnnouncementRead[]
  invitationId       String?  @unique
  invitation         Invitation? @relation(fields: [invitationId], references: [id])
  
  // Comunicaci√≥n
  participations     ConversationParticipant[]
  messages           Message[]
  reactions          MessageReaction[]
  
  // Relaci√≥n padres-hijos
  children           Student[] @relation("ParentChildren")
  
  // Relaci√≥n alumno-estudiante (para usuarios con rol ALUMNO)
  studentProfile     Student?  @relation("StudentUser")
  
  // Profesor asignado a grupos
  teacherGroups      Group[]   @relation("GroupTeacher")
  
  // Vocal de grupo (solo padres con rol VOCAL)
  vocalGroup         Group?    @relation("GroupVocal")
  
  // Tareas
  tasksCreated       Task[]    @relation("TaskTeacher")
  submissionsReviewed Submission[] @relation("SubmissionReviewer")
  
  // Calendario
  eventsCreated      Event[]   @relation("EventCreator")
  eventAttendances   EventAttendee[]
  
  // Pagos
  chargesCreated     Charge[]  @relation("ChargeCreatedBy")
  paymentsRecorded   Payment[] @relation("PaymentRecordedBy")
  
  // Documentos de calificaciones
  gradeDocumentsUploaded GradeDocument[] @relation("GradeDocumentUploader")
  
  // Asistencias registradas por profesor
  attendancesRecorded Attendance[] @relation("AttendanceRecorder")
  
  // Encuestas creadas (vocal)
  pollsCreated       Poll[]    @relation("PollCreator")
  pollVotes          PollVote[]
  
  // Documentos y firmas digitales
  documentsCreated   Document[]          @relation("DocumentCreator")
  documentSignatures DocumentSignature[]
  
  // Chatbot IA
  chatbotConversations ChatbotConversation[]
  
  // Sistema de citas
  teacherAvailability  TeacherAvailability[] @relation("TeacherAvailability")
  appointmentsAsTeacher Appointment[]        @relation("TeacherAppointments")
  appointmentsAsParent  Appointment[]        @relation("ParentAppointments")
  
  // Fase 4B: CRM y Comunicaci√≥n
  languagePreference   UserLanguagePreference?
  campaignsCreated     CrmCampaign[]
  campaignRecipients   CrmCampaignRecipient[]
  communicationLogs    CommunicationLog[]
  
  // Fase 4C: Tienda y Galer√≠a
  cartItems            CartItem[]
  orders               Order[]
  albumsCreated        PhotoAlbum[]
  
  // Horarios (profesores)
  schedules            Schedule[]   @relation("TeacherSchedules")
  
  // M√≥dulo Vocal de Grupo
  groupVocals          GroupVocal[] @relation("UserGroupVocals")
  fundsCreated         GroupFund[]  @relation("FundCreator")
  contributionsRecorded GroupFundContribution[] @relation("ContributionRecorder")
  expensesCreated      GroupExpense[] @relation("ExpenseCreator")
  groupAnnouncementsCreated GroupAnnouncement[] @relation("GroupAnnouncementCreator")
  groupAnnouncementReads GroupAnnouncementRead[]
  
  // Encuestas
  surveysCreated       Survey[]     @relation("SurveyCreator")
  surveyResponses      SurveyResponse[]
  
  // Inscripciones/Preinscripciones
  enrollmentsCreated   Enrollment[] @relation("EnrollmentCreator")
  enrollmentsReviewed  Enrollment[] @relation("EnrollmentReviewer")
  
  // Permisos/Justificantes
  permitRequestsCreated   PermitRequest[] @relation("PermitCreator")
  permitRequestsReviewed  PermitRequest[] @relation("PermitReviewer")
  
  // Nuevos m√≥dulos
  disciplineRecords       DisciplineRecord[] @relation("DisciplineRecorder")
  nurseVisits             NurseVisit[]       @relation("NurseRecorder")
  bulkImportJobs          BulkImportJob[]    @relation("ImportCreator")
  
  // Push Notifications
  pushSubscriptions       PushSubscription[] @relation("UserPushSubscriptions")
  
  // M√≥dulo Psicoemocional
  psychologicalRecords    PsychologicalRecord[] @relation("PsychologistRecords")
  
  // Becas creadas (admin con subrol CAJA o DIRECCION)
  scholarshipsCreated     Scholarship[] @relation("ScholarshipCreator")
  
  // T√©rminos y Condiciones
  termsAcceptances        UserTermsAcceptance[] @relation("UserTermsAcceptances")
  
  // Membres√≠as (para padres)
  parentSubscriptions     ParentSubscription[] @relation("ParentSubscriptions")
  
  // Programa de Afiliados
  affiliateReferrals      AffiliateReferral[] @relation("AffiliateReferrals")
  affiliateSignatures     AffiliatePetitionSignature[] @relation("AffiliateSignatures")
  
  // Cotizaciones (super admin)
  quotesCreated           Quote[] @relation("QuotesCreated")
  negotiationsCreated     QuoteNegotiation[] @relation("NegotiationsCreated")
  
  // Rendimiento de Profesores
  teacherMetrics          TeacherPerformanceMetric[] @relation("TeacherMetrics")
  teacherReviews          TeacherPerformanceReview[] @relation("TeacherReviews")
  teacherReviewsGiven     TeacherPerformanceReview[] @relation("TeacherReviewsGiven")
  
  // Reportes
  reportSchedulesCreated  ReportSchedule[]  @relation("ReportSchedulesCreated")
  reportsGenerated        ReportExecution[] @relation("ReportsGenerated")
  
  // Proveedores
  vendorsOwned            Vendor[]          @relation("VendorOwner")
  vendorApprovals         Vendor[]          @relation("VendorApprovals")
  vendorOrdersPlaced      VendorOrder[]     @relation("VendorOrdersPlaced")
  
  // Sistema de Soporte
  ticketsCreated          SupportTicket[]   @relation("TicketsCreated")
  ticketsAssigned         SupportTicket[]   @relation("TicketsAssigned")
  ticketMessages          SupportTicketMessage[] @relation("TicketMessages")
  
  // Reminders
  remindersReceived       ReminderLog[]     @relation("RemindersReceived")
  
  // WebAuthn / Passkeys
  passkeys                UserPasskey[]     @relation("UserPasskeys")
  
  // Estado de cuenta
  isActive                Boolean           @default(true)
  lastLoginAt             DateTime?
  failedLoginAttempts     Int               @default(0)
  lockedUntil             DateTime?
  
  // Programa de Referidos Escolar
  schoolReferralsMade     SchoolReferral[]      @relation("UserSchoolReferrals")
  schoolReferralsProcessed SchoolReferral[]     @relation("ProcessedSchoolReferrals")
  
  // Multi-tutor (para padres divorciados/separados)
  tutorRelations          StudentTutor[]        @relation("TutorStudents")
  tutorConfiguredBy       StudentTutor[]        @relation("TutorConfiguredBy")
  referralRewardsReceived ReferralReward[]      @relation("ReferralRewardsBeneficiary")
  referralRewardsApplied  ReferralReward[]      @relation("ReferralRewardsApplied")
  referredBySchoolReferral SchoolReferral?      @relation("ReferredBySchoolReferral")
}

model Invitation {
  id            String           @id @default(cuid())
  email         String
  role          Role
  tempPassword  String
  schoolId      String
  school        School           @relation(fields: [schoolId], references: [id])
  status        InvitationStatus @default(PENDING)
  token         String           @unique @default(cuid())
  expiresAt     DateTime
  createdAt     DateTime         @default(now())
  acceptedAt    DateTime?
  user          User?

  @@unique([email, schoolId])
}

// Grupos escolares (ej: "3ro Primaria A", "2do Secundaria B")
model Group {
  id           String    @id @default(cuid())
  name         String    // "3ro Primaria A"
  grade        String?   // "3ro Primaria"
  section      String?   // "A"
  schoolId     String
  school       School    @relation(fields: [schoolId], references: [id])
  teacherId    String?   // Profesor titular
  teacher      User?     @relation("GroupTeacher", fields: [teacherId], references: [id])
  vocalId      String?   @unique // Vocal de grupo (un padre) - mantener por retrocompatibilidad
  vocal        User?     @relation("GroupVocal", fields: [vocalId], references: [id])
  students     Student[]
  conversations Conversation[]
  tasks        Task[]
  events       Event[]
  attendances  Attendance[]
  polls        Poll[]
  documents    Document[]
  photoAlbums  PhotoAlbum[]
  schedules    Schedule[]
  createdAt    DateTime  @default(now())
  isActive     Boolean   @default(true)
  
  // Sistema de m√∫ltiples vocales (hasta 2)
  groupVocals       GroupVocal[]
  
  // Sistema de colectas y fondos
  funds             GroupFund[]
  
  // Avisos espec√≠ficos del grupo (por vocales)
  groupAnnouncements GroupAnnouncement[]

  @@unique([name, schoolId])
}

// Estudiantes (alumnos)
model Student {
  id           String   @id @default(cuid())
  firstName    String
  lastName     String
  birthDate    DateTime? // Fecha de nacimiento para felicitaciones autom√°ticas
  photoUrl     String?  // Foto de perfil para reconocimiento facial
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id])
  groupId      String?
  group        Group?   @relation(fields: [groupId], references: [id])
  parents      User[]   @relation("ParentChildren")
  
  // Usuario asociado (para alumnos con cuenta)
  userId       String?  @unique
  user         User?    @relation("StudentUser", fields: [userId], references: [id])
  
  submissions  Submission[]
  charges      Charge[]
  gradeDocuments GradeDocument[]
  attendances  Attendance[]
  appointments Appointment[] @relation("StudentAppointments")
  speiReference SpeiReference?
  photoTags    PhotoTag[]
  fundContributions GroupFundContribution[]
  permitRequests PermitRequest[]
  enrollment   Enrollment? @relation("EnrollmentStudent")
  
  // Nuevos m√≥dulos
  reportCards      ReportCard[]      @relation("StudentReportCards")
  disciplineRecords DisciplineRecord[] @relation("StudentDiscipline")
  nurseVisits      NurseVisit[]      @relation("StudentNurseVisits")
  medicalInfo      StudentMedicalInfo? @relation("StudentMedicalInfo")
  
  // M√≥dulo Psicoemocional
  psychologicalRecords PsychologicalRecord[] @relation("StudentPsychological")
  
  // Becas asignadas al estudiante
  scholarships     StudentScholarship[] @relation("StudentScholarships")
  
  // Personas y veh√≠culos autorizados para recoger
  authorizedPickups AuthorizedPickup[] @relation("StudentAuthorizedPickups")
  
  // Suscripci√≥n del padre para este estudiante
  subscription      ParentSubscription? @relation("StudentSubscription")
  
  // Pedidos de proveedores
  vendorOrders      VendorOrder[] @relation("VendorOrdersForStudent")
  
  // Multi-tutor (para padres divorciados/separados)
  tutors            StudentTutor[]           @relation("StudentTutors")
  
  // ============================================
  // GAMIFICACI√ìN
  // ============================================
  badges            StudentBadge[]           @relation("StudentBadges")
  gamificationProfile StudentGamificationProfile? @relation("GamificationProfile")
  pointsLogs        StudentPointsLog[]       @relation("PointsLogs")
  
  createdAt    DateTime @default(now())
  isActive     Boolean  @default(true)

  @@index([schoolId])
  @@index([groupId])
}

// Conversaciones (chats)
model Conversation {
  id           String           @id @default(cuid())
  type         ConversationType
  name         String?          // Para chats grupales
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id])
  groupId      String?          // Para chats de grupo escolar
  group        Group?           @relation(fields: [groupId], references: [id])
  participants ConversationParticipant[]
  messages     Message[]
  lastMessageAt DateTime?
  createdAt    DateTime         @default(now())
  isActive     Boolean          @default(true)

  @@index([schoolId])
  @@index([groupId])
  @@index([lastMessageAt])
}

// Participantes en conversaciones
model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  isMuted        Boolean      @default(false)
  lastReadAt     DateTime?
  joinedAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
}

// Mensajes
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  type           MessageType  @default(TEXT)
  content        String
  fileUrl        String?
  fileName       String?
  fileSize       Int?
  mimeType       String?
  isPinned       Boolean      @default(false)
  pinnedAt       DateTime?
  pinnedById     String?
  isEdited       Boolean      @default(false)
  createdAt      DateTime     @default(now())
  editedAt       DateTime?
  reactions      MessageReaction[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([conversationId, isPinned])
}

// Reacciones a mensajes
model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  emoji     String   // üëç, ‚ù§Ô∏è, üòÇ, üòÆ, üò¢, üôè
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

model Announcement {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  title       String
  content     String
  priority    Priority @default(NORMAL)
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  reads       AnnouncementRead[]
}

model AnnouncementRead {
  id             String       @id @default(cuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  readAt         DateTime     @default(now())

  @@unique([announcementId, userId])
}

// ==================== M√ìDULO DE TAREAS ====================

enum TaskStatus {
  DRAFT       // Borrador
  PUBLISHED   // Publicada y visible
  CLOSED      // Cerrada, no acepta m√°s entregas
}

// ==================== M√ìDULO DE CALENDARIO ====================

enum EventType {
  ESCOLAR       // Evento escolar general
  REUNION       // Reuni√≥n de padres/junta
  CITA          // Cita individual
  FESTIVO       // D√≠a festivo/vacaciones
  ACADEMICO     // Ex√°menes, entrega de boletas
  EXTRACURRICULAR // Deportes, cultura, etc.
}

enum EventAttendeeStatus {
  PENDING
  CONFIRMED
  DECLINED
}

// ==================== M√ìDULO DE PAGOS ====================

enum PaymentStatus {
  PENDIENTE     // Pago pendiente
  PAGADO        // Pago completado
  VENCIDO       // Pago vencido
  PARCIAL       // Pago parcial
  CANCELADO     // Cargo cancelado
}

enum PaymentMethod {
  EFECTIVO
  TRANSFERENCIA
  SPEI          // Transferencia SPEI con referencia √∫nica
  TARJETA
  DEPOSITO
  OTRO
}

enum ChargeType {
  COLEGIATURA   // Mensualidad
  INSCRIPCION   // Inscripci√≥n
  MATERIAL      // Material escolar
  UNIFORME      // Uniforme
  EVENTO        // Eventos especiales
  TRANSPORTE    // Transporte escolar
  COMEDOR       // Comedor/Cafeter√≠a
  OTRO          // Otros cargos
}

enum SubmissionStatus {
  PENDING     // Entregada, pendiente de revisi√≥n
  REVIEWED    // Revisada con calificaci√≥n
  LATE        // Entregada tarde
  RETURNED    // Devuelta para correcciones
}

// Materias/Asignaturas
model Subject {
  id          String   @id @default(cuid())
  name        String   // "Matem√°ticas", "Espa√±ol", "Ciencias"
  color       String   @default("#1B4079") // Color para UI
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  tasks       Task[]
  schedules   Schedule[]
  reportCardGrades ReportCardGrade[] @relation("SubjectGrades")
  createdAt   DateTime @default(now())
  isActive    Boolean  @default(true)

  @@unique([name, schoolId])
  @@index([schoolId])
}

// Horarios de clases
model Schedule {
  id          String   @id @default(cuid())
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])
  groupId     String
  group       Group    @relation(fields: [groupId], references: [id])
  teacherId   String
  teacher     User     @relation("TeacherSchedules", fields: [teacherId], references: [id])
  dayOfWeek   Int      // 1=Lunes, 2=Martes, ..., 5=Viernes
  startTime   String   // "08:00"
  endTime     String   // "08:50"
  classroom   String?  // "Sal√≥n 101"
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([groupId])
  @@index([teacherId])
  @@index([schoolId])
  @@index([dayOfWeek])
}

// Tareas
model Task {
  id             String     @id @default(cuid())
  title          String
  description    String?    @db.Text
  instructions   String?    @db.Text
  status         TaskStatus @default(DRAFT)
  
  // Fechas
  dueDate        DateTime?  // Fecha l√≠mite de entrega
  publishedAt    DateTime?  // Cu√°ndo se public√≥
  closedAt       DateTime?  // Cu√°ndo se cerr√≥
  
  // Archivos adjuntos (material de apoyo)
  attachments    TaskAttachment[]
  
  // Puntuaci√≥n
  maxScore       Int        @default(100)  // Puntuaci√≥n m√°xima
  weight         Float      @default(1.0)  // Peso para promedio
  
  // Relaciones
  subjectId      String?
  subject        Subject?   @relation(fields: [subjectId], references: [id])
  groupId        String     // Grupo al que se asigna
  group          Group      @relation(fields: [groupId], references: [id])
  teacherId      String     // Profesor que cre√≥ la tarea
  teacher        User       @relation("TaskTeacher", fields: [teacherId], references: [id])
  
  submissions    Submission[]
  
  // Evento de calendario para fecha l√≠mite
  calendarEvent  Event?
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([groupId])
  @@index([teacherId])
  @@index([status])
  @@index([dueDate])
}

// Archivos adjuntos de tareas
model TaskAttachment {
  id              String   @id @default(cuid())
  taskId          String
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  fileName        String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  cloudStoragePath String?
  isPublic        Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([taskId])
}

// Entregas de tareas
model Submission {
  id              String           @id @default(cuid())
  taskId          String
  task            Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student          @relation(fields: [studentId], references: [id])
  
  // Contenido de la entrega
  content         String?          @db.Text  // Texto/comentarios del alumno
  attachments     SubmissionAttachment[]
  
  // Estado y calificaci√≥n
  status          SubmissionStatus @default(PENDING)
  score           Float?           // Calificaci√≥n obtenida
  feedback        String?          @db.Text  // Retroalimentaci√≥n del profesor
  
  // Fechas
  submittedAt     DateTime         @default(now())
  reviewedAt      DateTime?
  reviewedById    String?
  reviewedBy      User?            @relation("SubmissionReviewer", fields: [reviewedById], references: [id])
  isLate          Boolean          @default(false)
  
  updatedAt       DateTime         @updatedAt

  @@unique([taskId, studentId])
  @@index([taskId])
  @@index([studentId])
  @@index([status])
}

// Archivos adjuntos de entregas
model SubmissionAttachment {
  id              String     @id @default(cuid())
  submissionId    String
  submission      Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  fileName        String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  cloudStoragePath String?
  isPublic        Boolean    @default(false)
  createdAt       DateTime   @default(now())

  @@index([submissionId])
}

// Documentos de calificaciones (boletas, reportes)
model GradeDocument {
  id              String   @id @default(cuid())
  title           String   // "Boleta Primer Trimestre", "Reporte Anual"
  description     String?
  
  // Relaciones
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  uploadedById    String
  uploadedBy      User     @relation("GradeDocumentUploader", fields: [uploadedById], references: [id])
  
  // Archivo
  fileName        String
  fileUrl         String
  fileSize        Int?
  mimeType        String?
  cloudStoragePath String?
  isPublic        Boolean  @default(false)
  
  // Per√≠odo acad√©mico
  period          String?  // "2025-T1", "2025-2026"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([studentId])
  @@index([uploadedById])
}

// ==================== EVENTOS DE CALENDARIO ====================

model Event {
  id             String      @id @default(cuid())
  title          String
  description    String?     @db.Text
  
  // Fechas y horario
  startDate      DateTime
  endDate        DateTime?
  allDay         Boolean     @default(false)
  
  // Tipo y visualizaci√≥n
  type           EventType   @default(ESCOLAR)
  color          String      @default("#1B4079")
  location       String?     // Ubicaci√≥n (aula, auditorio, etc.)
  
  // Visibilidad
  isPublic       Boolean     @default(true)  // Visible para toda la escuela
  
  // Relaciones
  schoolId       String
  school         School      @relation(fields: [schoolId], references: [id])
  createdById    String
  createdBy      User        @relation("EventCreator", fields: [createdById], references: [id])
  groupId        String?     // Para eventos espec√≠ficos de un grupo
  group          Group?      @relation(fields: [groupId], references: [id])
  taskId         String?     @unique // Enlace a tarea (para fechas l√≠mite)
  task           Task?       @relation(fields: [taskId], references: [id])
  
  // Asistentes
  attendees      EventAttendee[]
  
  // Colecta vinculada (si aplica)
  linkedFund     GroupFund?   @relation("FundEvent")
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([schoolId])
  @@index([startDate])
  @@index([groupId])
  @@index([type])
}

// Asistentes a eventos
model EventAttendee {
  id           String              @id @default(cuid())
  eventId      String
  event        Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId       String
  user         User                @relation(fields: [userId], references: [id])
  status       EventAttendeeStatus @default(PENDING)
  responseAt   DateTime?
  createdAt    DateTime            @default(now())

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// ==================== CARGOS Y PAGOS ====================

// Cargos (colegiaturas, inscripciones, etc.)
model Charge {
  id             String        @id @default(cuid())
  concept        String        // Descripci√≥n del cargo
  type           ChargeType    @default(COLEGIATURA)
  amount         Float         // Monto total
  amountPaid     Float         @default(0) // Monto pagado
  status         PaymentStatus @default(PENDIENTE)
  
  // Fechas
  dueDate        DateTime      // Fecha l√≠mite de pago
  periodMonth    Int?          // Mes del periodo (1-12)
  periodYear     Int?          // A√±o del periodo
  
  // Relaciones
  studentId      String
  student        Student       @relation(fields: [studentId], references: [id])
  schoolId       String
  school         School        @relation(fields: [schoolId], references: [id])
  createdById    String
  createdBy      User          @relation("ChargeCreatedBy", fields: [createdById], references: [id])
  
  // Pagos asociados
  payments       Payment[]
  
  // Notas y observaciones
  notes          String?       @db.Text
  
  // Descuentos de referidos aplicados
  referralRewards ReferralReward[] @relation("ReferralRewardCharge")
  
  // Ciclo escolar
  schoolCycleId   String?
  schoolCycle     SchoolCycle?  @relation("CycleCharges", fields: [schoolCycleId], references: [id])
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([studentId])
  @@index([schoolId])
  @@index([status])
  @@index([schoolCycleId])
  @@index([dueDate])
  @@index([type])
}

// Pagos realizados
model Payment {
  id             String        @id @default(cuid())
  amount         Float         // Monto del pago
  method         PaymentMethod @default(EFECTIVO)
  reference      String?       // Referencia de pago (# de transferencia, etc.)
  
  // Relaciones
  chargeId       String
  charge         Charge        @relation(fields: [chargeId], references: [id], onDelete: Cascade)
  recordedById   String        // Usuario que registr√≥ el pago (admin)
  recordedBy     User          @relation("PaymentRecordedBy", fields: [recordedById], references: [id])
  
  // Notas
  notes          String?       @db.Text
  
  // Comprobante de pago (opcional)
  receiptUrl     String?
  receiptPath    String?
  
  paidAt         DateTime      @default(now())
  createdAt      DateTime      @default(now())

  @@index([chargeId])
  @@index([paidAt])
}

// ==================== M√ìDULO DE ASISTENCIAS ====================

model Attendance {
  id           String           @id @default(cuid())
  date         DateTime         @db.Date  // Fecha de la asistencia
  status       AttendanceStatus @default(PRESENTE)
  notes        String?          // Notas opcionales (motivo de falta, etc.)
  
  // Relaciones
  studentId    String
  student      Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  groupId      String
  group        Group            @relation(fields: [groupId], references: [id])
  recordedById String           // Profesor que registr√≥
  recordedBy   User             @relation("AttendanceRecorder", fields: [recordedById], references: [id])
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@unique([studentId, date])  // Un registro por estudiante por d√≠a
  @@index([studentId])
  @@index([groupId])
  @@index([date])
}

// ==================== M√ìDULO DE ENCUESTAS (VOCAL) ====================

model Poll {
  id           String     @id @default(cuid())
  title        String
  description  String?    @db.Text
  status       PollStatus @default(ACTIVE)
  allowMultiple Boolean   @default(false)  // Permite seleccionar m√∫ltiples opciones
  isAnonymous  Boolean    @default(false)  // Votaci√≥n an√≥nima
  endsAt       DateTime?  // Fecha l√≠mite para votar
  
  // Relaciones
  groupId      String
  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdById  String     // Vocal que cre√≥ la encuesta
  createdBy    User       @relation("PollCreator", fields: [createdById], references: [id])
  
  options      PollOption[]
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([groupId])
  @@index([status])
}

model PollOption {
  id        String     @id @default(cuid())
  text      String
  pollId    String
  poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes     PollVote[]
  createdAt DateTime   @default(now())

  @@index([pollId])
}

model PollVote {
  id        String     @id @default(cuid())
  optionId  String
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  createdAt DateTime   @default(now())

  @@unique([optionId, userId])  // Un voto por usuario por opci√≥n
  @@index([optionId])
  @@index([userId])
}

// ==================== M√ìDULO DE FIRMA DIGITAL ====================

model Document {
  id              String         @id @default(cuid())
  title           String
  description     String?        @db.Text
  content         String         @db.Text   // Contenido HTML del documento
  type            DocumentType   @default(AUTORIZACION)
  status          DocumentStatus @default(DRAFT)
  
  // Archivo PDF generado (opcional)
  pdfUrl          String?
  pdfPath         String?
  
  // Fechas
  expiresAt       DateTime?      // Fecha de expiraci√≥n para firmar
  completedAt     DateTime?      // Fecha en que se complet√≥ la firma
  
  // Destinatarios
  targetRole      Role?          // Rol objetivo (PADRE, PROFESOR, etc.)
  groupId         String?        // Grupo espec√≠fico (opcional)
  group           Group?         @relation(fields: [groupId], references: [id])
  
  // Relaciones
  schoolId        String
  school          School         @relation(fields: [schoolId], references: [id])
  createdById     String
  createdBy       User           @relation("DocumentCreator", fields: [createdById], references: [id])
  
  signatures      DocumentSignature[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([schoolId])
  @@index([status])
  @@index([type])
  @@index([createdById])
}

model DocumentSignature {
  id              String    @id @default(cuid())
  documentId      String
  document        Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  // Datos de la firma
  signatureData   String?   @db.Text   // Firma digital (base64 o hash)
  signatureType   String    @default("ACCEPT") // ACCEPT (checkbox), DRAW (firma dibujada)
  ipAddress       String?                // IP desde donde se firm√≥
  userAgent       String?   @db.Text    // Navegador/dispositivo
  
  // Verificaci√≥n
  signedAt        DateTime  @default(now())
  verificationCode String   @unique @default(cuid()) // C√≥digo √∫nico de verificaci√≥n
  
  createdAt       DateTime  @default(now())

  @@unique([documentId, userId])  // Un usuario solo firma una vez por documento
  @@index([documentId])
  @@index([userId])
  @@index([verificationCode])
}

// ==================== CHATBOT IA ====================

model ChatbotConversation {
  id           String           @id @default(cuid())
  userId       String
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id])
  
  // M√©tricas
  messageCount Int              @default(0)
  topic        String?          // Tema principal detectado (pagos, tareas, calendario, etc.)
  resolved     Boolean          @default(false) // Si el usuario indic√≥ que su duda fue resuelta
  rating       Int?             // Calificaci√≥n 1-5
  
  messages     ChatbotMessage[]
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([userId])
  @@index([schoolId])
  @@index([createdAt])
}

model ChatbotMessage {
  id             String              @id @default(cuid())
  conversationId String
  conversation   ChatbotConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  role           String              // "user" | "assistant"
  content        String              @db.Text
  
  // M√©tricas
  responseTime   Int?                // Tiempo de respuesta en ms (solo para assistant)
  
  createdAt      DateTime            @default(now())

  @@index([conversationId])
}

// ==================== SUPER ADMIN - SISTEMA MULTI-ESCUELA ====================

// Configuraciones globales del sistema
model SystemConfig {
  id           String   @id @default(cuid())
  key          String   @unique  // Ej: "max_schools", "default_theme", "maintenance_mode"
  value        String   @db.Text // Valor como JSON string
  description  String?
  category     String   @default("general") // general, security, notifications, limits
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Configuraciones espec√≠ficas por escuela
model SchoolSettings {
  id               String   @id @default(cuid())
  schoolId         String   @unique
  school           School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // M√≥dulos habilitados
  modulesEnabled   String   @default("[\"announcements\",\"messages\",\"tasks\",\"calendar\",\"payments\",\"attendance\",\"documents\",\"chatbot\"]") // JSON array
  
  // L√≠mites
  maxUsers         Int      @default(500)
  maxStudents      Int      @default(1000)
  maxGroups        Int      @default(50)
  storageLimit     Int      @default(5120) // MB
  
  // Personalizaci√≥n
  customDomain     String?
  customCss        String?  @db.Text
  welcomeMessage   String?  @db.Text
  
  // Plan/Suscripci√≥n
  planType         String   @default("standard") // free, basic, standard, premium
  planExpiresAt    DateTime?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ==================== SISTEMA DE PAGOS SPEI ====================

// Configuraci√≥n bancaria de la escuela
model SchoolBankConfig {
  id            String   @id @default(cuid())
  schoolId      String   @unique
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  bankName      String   // Nombre del banco (ej: "BBVA", "Banorte")
  accountHolder String   // Nombre del titular
  clabe         String   // CLABE interbancaria (18 d√≠gitos)
  accountNumber String?  // N√∫mero de cuenta (opcional)
  
  // Prefijo para referencias (ej: "VS" para Vermont School)
  referencePrefix String @default("REF")
  
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Referencias SPEI √∫nicas por alumno
model SpeiReference {
  id              String   @id @default(cuid())
  studentId       String   @unique
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  schoolId        String
  
  // Referencia num√©rica √∫nica (ej: "VS240001")
  reference       String   @unique
  
  // Estado
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  
  @@index([reference])
}

// ==================== SISTEMA DE CITAS ====================

enum AppointmentStatus {
  PENDING      // Pendiente de confirmaci√≥n
  CONFIRMED    // Confirmada
  CANCELLED    // Cancelada
  COMPLETED    // Completada
  NO_SHOW      // No se present√≥
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// Disponibilidad semanal del profesor
model TeacherAvailability {
  id          String    @id @default(cuid())
  teacherId   String
  teacher     User      @relation("TeacherAvailability", fields: [teacherId], references: [id], onDelete: Cascade)
  dayOfWeek   DayOfWeek
  startTime   String    // "09:00" formato HH:mm
  endTime     String    // "10:00" formato HH:mm
  slotDuration Int      @default(30) // minutos por cita
  isActive    Boolean   @default(true)
  location    String?   // "Sala de maestros", "Aula 5", etc.
  notes       String?   // Notas adicionales
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([teacherId, dayOfWeek, startTime])
  @@index([teacherId])
  @@index([dayOfWeek])
}

// Citas agendadas
model Appointment {
  id              String            @id @default(cuid())
  teacherId       String
  teacher         User              @relation("TeacherAppointments", fields: [teacherId], references: [id])
  parentId        String
  parent          User              @relation("ParentAppointments", fields: [parentId], references: [id])
  studentId       String?
  student         Student?          @relation("StudentAppointments", fields: [studentId], references: [id])
  
  scheduledDate   DateTime          // Fecha de la cita
  startTime       String            // "09:00"
  endTime         String            // "09:30"
  status          AppointmentStatus @default(PENDING)
  
  subject         String            // Motivo de la cita
  notes           String?           @db.Text // Notas adicionales del padre
  teacherNotes    String?           @db.Text // Notas del profesor (despu√©s de la cita)
  location        String?           // Lugar de la cita
  
  // Videoconferencia
  isVideoCall     Boolean           @default(false)
  meetingUrl      String?           // URL de Jitsi Meet
  meetingRoomId   String?           // ID √∫nico de la sala
  
  // Notificaciones
  parentNotified  Boolean           @default(false)
  teacherNotified Boolean           @default(false)
  reminderSent    Boolean           @default(false)
  
  cancelledBy     String?           // userId de quien cancel√≥
  cancelReason    String?           // Raz√≥n de cancelaci√≥n
  cancelledAt     DateTime?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([teacherId])
  @@index([parentId])
  @@index([studentId])
  @@index([scheduledDate])
  @@index([status])
}

// Registro de actividad del sistema (Auditor√≠a)
model SystemAuditLog {
  id           String   @id @default(cuid())
  action       String   // CREATE_SCHOOL, UPDATE_SCHOOL, DEACTIVATE_SCHOOL, UPDATE_CONFIG, etc.
  entityType   String   // School, User, SystemConfig
  entityId     String?
  userId       String?  // Usuario que realiz√≥ la acci√≥n
  userEmail    String?
  details      String?  @db.Text // JSON con detalles adicionales
  ipAddress    String?
  userAgent    String?  @db.Text
  createdAt    DateTime @default(now())

  @@index([action])
  @@index([entityType])
  @@index([userId])
  @@index([createdAt])
}

// ==================== IMPORTACI√ìN CSV ====================

enum ImportStatus {
  PENDING      // Pendiente de procesar
  PROCESSING   // En proceso
  COMPLETED    // Completado exitosamente
  PARTIAL      // Completado con errores
  FAILED       // Fall√≥ completamente
}

enum ImportType {
  STUDENTS     // Importaci√≥n de alumnos
  PARENTS      // Importaci√≥n de padres
  TEACHERS     // Importaci√≥n de profesores
  GROUPS       // Importaci√≥n de grupos
  CHARGES      // Importaci√≥n de cargos/cobros
}

model ImportLog {
  id              String       @id @default(cuid())
  schoolId        String
  school          School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  type            ImportType
  status          ImportStatus @default(PENDING)
  
  // Estad√≠sticas
  totalRows       Int          @default(0)
  successRows     Int          @default(0)
  errorRows       Int          @default(0)
  
  // Archivo original
  fileName        String
  filePath        String?
  
  // Resultados detallados (JSON con errores por fila)
  errors          String?      @db.Text
  
  // Qui√©n import√≥
  importedById    String
  
  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime     @default(now())

  @@index([schoolId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// ==================== M√âTRICAS Y REPORTES ====================

// Snapshots de m√©tricas diarias por escuela
model SchoolMetricsSnapshot {
  id                String   @id @default(cuid())
  schoolId          String
  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  date              DateTime @db.Date
  
  // Usuarios
  totalUsers        Int      @default(0)
  activeUsers       Int      @default(0) // Usuarios que iniciaron sesi√≥n este d√≠a
  totalParents      Int      @default(0)
  totalTeachers     Int      @default(0)
  totalStudents     Int      @default(0)
  
  // Grupos
  totalGroups       Int      @default(0)
  
  // Comunicaci√≥n
  messagesCount     Int      @default(0)
  announcementsCount Int     @default(0)
  
  // Acad√©mico
  tasksCreated      Int      @default(0)
  submissionsCount  Int      @default(0)
  averageAttendance Float?
  
  // Pagos
  chargesTotal      Float    @default(0)
  paymentsTotal     Float    @default(0)
  pendingPayments   Float    @default(0)
  
  // Chatbot
  chatbotQueries    Int      @default(0)
  chatbotResolved   Int      @default(0)
  
  // Citas
  appointmentsScheduled Int  @default(0)
  appointmentsCompleted Int  @default(0)
  
  createdAt         DateTime @default(now())

  @@unique([schoolId, date])
  @@index([schoolId])
  @@index([date])
}


// ==========================================
// FASE 4B: COMUNICACI√ìN - TRADUCCIONES Y CRM
// ==========================================

enum Language {
  ES  // Espa√±ol
  EN  // English
  PT  // Portugu√™s
  DE  // Deutsch
  FR  // Fran√ßais
  JA  // Êó•Êú¨Ë™û
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

enum CampaignType {
  EMAIL
  PUSH
  SMS
}

// Preferencias de idioma del usuario
model UserLanguagePreference {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  language  Language @default(ES)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Segmentos de usuarios para CRM
model CrmSegment {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name        String
  description String?
  filters     Json     // Filtros din√°micos: { role: [], groupId: [], hasUnpaidCharges: true, etc }
  userCount   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  campaigns   CrmCampaign[]

  @@index([schoolId])
}

// Campa√±as de comunicaci√≥n
model CrmCampaign {
  id           String         @id @default(cuid())
  schoolId     String
  school       School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  segmentId    String?
  segment      CrmSegment?    @relation(fields: [segmentId], references: [id])
  name         String
  subject      String
  content      String         @db.Text
  type         CampaignType   @default(EMAIL)
  status       CampaignStatus @default(DRAFT)
  scheduledAt  DateTime?
  sentAt       DateTime?
  totalRecipients Int         @default(0)
  deliveredCount  Int         @default(0)
  openedCount     Int         @default(0)
  clickedCount    Int         @default(0)
  createdById  String
  createdBy    User           @relation(fields: [createdById], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  recipients   CrmCampaignRecipient[]

  @@index([schoolId])
  @@index([status])
  @@index([scheduledAt])
}

// Destinatarios de campa√±as
model CrmCampaignRecipient {
  id          String      @id @default(cuid())
  campaignId  String
  campaign    CrmCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  email       String
  status      String      @default("pending") // pending, sent, delivered, opened, clicked, bounced, failed
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  createdAt   DateTime    @default(now())

  @@unique([campaignId, userId])
  @@index([campaignId])
  @@index([userId])
  @@index([status])
}

// Plantillas de email
model EmailTemplate {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name        String
  subject     String
  content     String   @db.Text
  category    String?  // welcome, reminder, announcement, etc
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([schoolId])
  @@index([category])
}

// Historial de comunicaciones enviadas
model CommunicationLog {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // email, sms, push
  subject     String?
  content     String   @db.Text
  status      String   // sent, delivered, failed, bounced
  metadata    Json?    // Info adicional como IP, dispositivo, etc
  sentAt      DateTime @default(now())
  
  @@index([schoolId])
  @@index([userId])
  @@index([sentAt])
}


// ==========================================
// FASE 4C: COMERCIO Y MEDIOS
// ==========================================

// ---------- TIENDA ESCOLAR ----------

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum OrderStatus {
  PENDING      // Pedido creado, esperando pago
  PAID         // Pago confirmado
  PROCESSING   // En preparaci√≥n
  READY        // Listo para entrega
  DELIVERED    // Entregado
  CANCELLED    // Cancelado
}

// Categor√≠as de productos
model StoreCategory {
  id          String   @id @default(cuid())
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name        String
  description String?
  imageUrl    String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  products    StoreProduct[]
  vendorProducts VendorProduct[]

  @@index([schoolId])
}

// Productos de la tienda
model StoreProduct {
  id          String        @id @default(cuid())
  schoolId    String
  school      School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  categoryId  String
  category    StoreCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name        String
  description String?       @db.Text
  price       Float
  imageUrl    String?
  sku         String?       // C√≥digo de producto
  stock       Int           @default(0)
  status      ProductStatus @default(ACTIVE)
  sizes       String[]      @default([]) // Tallas disponibles: ["XS", "S", "M", "L", "XL"]
  colors      String[]      @default([]) // Colores disponibles
  isRequired  Boolean       @default(false) // Si es uniforme obligatorio
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@index([schoolId])
  @@index([categoryId])
  @@index([status])
}

// Carrito de compras
model CartItem {
  id        String       @id @default(cuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int          @default(1)
  size      String?      // Talla seleccionada
  color     String?      // Color seleccionado
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([userId, productId, size, color])
  @@index([userId])
}

// √ìrdenes/Pedidos
model Order {
  id           String      @id @default(cuid())
  orderNumber  String      @unique // N√∫mero de pedido legible
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId     String
  school       School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subtotal     Float
  discount     Float       @default(0)
  total        Float
  status       OrderStatus @default(PENDING)
  paymentMethod String?    // spei, card, cash
  paymentReference String? // Referencia de pago
  paidAt       DateTime?
  notes        String?     @db.Text
  deliveryDate DateTime?   // Fecha estimada de entrega
  deliveredAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  items        OrderItem[]

  @@index([userId])
  @@index([schoolId])
  @@index([status])
  @@index([orderNumber])
}

// Items de una orden
model OrderItem {
  id         String       @id @default(cuid())
  orderId    String
  order      Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId  String
  product    StoreProduct @relation(fields: [productId], references: [id])
  quantity   Int
  unitPrice  Float
  size       String?
  color      String?
  createdAt  DateTime     @default(now())

  @@index([orderId])
}

// ---------- GALER√çA DE FOTOS ----------

enum AlbumVisibility {
  PUBLIC       // Visible para todos los padres de la escuela
  GROUP_ONLY   // Solo para padres del grupo espec√≠fico
  PRIVATE      // Solo admins
}

// √Ålbumes de fotos
model PhotoAlbum {
  id          String          @id @default(cuid())
  schoolId    String
  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  groupId     String?         // Opcional: √°lbum de un grupo espec√≠fico
  group       Group?          @relation(fields: [groupId], references: [id])
  title       String
  description String?         @db.Text
  coverUrl    String?         // Imagen de portada
  eventDate   DateTime?       // Fecha del evento
  visibility  AlbumVisibility @default(PUBLIC)
  photoCount  Int             @default(0)
  isActive    Boolean         @default(true)
  createdById String
  createdBy   User            @relation(fields: [createdById], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  photos      Photo[]

  @@index([schoolId])
  @@index([groupId])
  @@index([eventDate])
}

// Fotos individuales
model Photo {
  id           String      @id @default(cuid())
  albumId      String
  album        PhotoAlbum  @relation(fields: [albumId], references: [id], onDelete: Cascade)
  url          String      // URL de la imagen
  thumbnailUrl String?     // Miniatura
  caption      String?
  takenAt      DateTime?   // Fecha en que se tom√≥ la foto
  width        Int?
  height       Int?
  fileSize     Int?        // Tama√±o en bytes
  order        Int         @default(0)
  isProcessed  Boolean     @default(false) // Si ya se proces√≥ para reconocimiento facial
  createdAt    DateTime    @default(now())
  tags         PhotoTag[]

  @@index([albumId])
}

// Etiquetas de fotos (reconocimiento facial)
model PhotoTag {
  id         String   @id @default(cuid())
  photoId    String
  photo      Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  studentId  String?  // Si se identific√≥ a un estudiante
  student    Student? @relation(fields: [studentId], references: [id])
  x          Float?   // Coordenada X del rostro (porcentaje)
  y          Float?   // Coordenada Y del rostro
  width      Float?   // Ancho del √°rea (porcentaje)
  height     Float?   // Alto del √°rea
  confidence Float?   // Confianza del reconocimiento (0-1)
  isManual   Boolean  @default(false) // Si fue etiquetado manualmente
  createdAt  DateTime @default(now())

  @@index([photoId])
  @@index([studentId])
}

// ==========================================
// M√ìDULO VOCAL DE GRUPO
// ==========================================

enum FundStatus {
  ACTIVE       // Colecta activa
  PAUSED       // Colecta pausada
  COMPLETED    // Colecta completada (meta alcanzada o cerrada)
  CANCELLED    // Colecta cancelada
}

enum ContributionStatus {
  PENDING      // Pago pendiente
  PAID         // Pago confirmado
  EXEMPT       // Exento de pago
}

// Vocales de grupo (hasta 2 por grupo)
model GroupVocal {
  id           String   @id @default(cuid())
  groupId      String
  group        Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId       String
  user         User     @relation("UserGroupVocals", fields: [userId], references: [id])
  isPrimary    Boolean  @default(false)  // Vocal principal
  isActive     Boolean  @default(true)
  assignedAt   DateTime @default(now())
  
  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

// Colectas/Fondos del grupo
model GroupFund {
  id              String     @id @default(cuid())
  groupId         String
  group           Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdById     String     // Vocal que cre√≥ la colecta
  createdBy       User       @relation("FundCreator", fields: [createdById], references: [id])
  
  title           String     // "D√≠a de San Valent√≠n", "Venta de Recreo"
  description     String?    @db.Text
  
  // Montos
  amountPerStudent Float     // Monto por alumno
  goalAmount      Float?     // Meta total (opcional)
  totalCollected  Float      @default(0) // Total recaudado
  
  // Fechas
  dueDate         DateTime?  // Fecha l√≠mite de pago
  eventDate       DateTime?  // Fecha del evento asociado
  
  // Estado
  status          FundStatus @default(ACTIVE)
  
  // Vinculaci√≥n con actividad/evento
  linkedEventId   String?    @unique
  linkedEvent     Event?     @relation("FundEvent", fields: [linkedEventId], references: [id])
  
  contributions   GroupFundContribution[]
  expenses        GroupExpense[]
  announcements   GroupAnnouncement[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([groupId])
  @@index([status])
  @@index([dueDate])
}

// Contribuciones/Pagos a colectas
model GroupFundContribution {
  id              String             @id @default(cuid())
  fundId          String
  fund            GroupFund          @relation(fields: [fundId], references: [id], onDelete: Cascade)
  studentId       String
  student         Student            @relation(fields: [studentId], references: [id])
  
  amount          Float              // Monto pagado
  status          ContributionStatus @default(PENDING)
  
  // Detalles del pago
  paidAt          DateTime?
  paymentMethod   String?            // "efectivo", "transferencia"
  paymentReference String?           // Referencia de pago
  
  // Recibo
  receiptUrl      String?
  receiptPath     String?
  
  // Qui√©n registr√≥ el pago
  recordedById    String?
  recordedBy      User?              @relation("ContributionRecorder", fields: [recordedById], references: [id])
  
  notes           String?
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  @@unique([fundId, studentId])
  @@index([fundId])
  @@index([studentId])
  @@index([status])
}

// Gastos del fondo (transparencia)
model GroupExpense {
  id              String     @id @default(cuid())
  fundId          String
  fund            GroupFund  @relation(fields: [fundId], references: [id], onDelete: Cascade)
  createdById     String     // Vocal que registr√≥ el gasto
  createdBy       User       @relation("ExpenseCreator", fields: [createdById], references: [id])
  
  concept         String     // "Compra de dulces", "Decoraciones"
  amount          Float
  
  // Comprobante
  receiptUrl      String?
  receiptPath     String?
  
  expenseDate     DateTime   @default(now())
  notes           String?
  
  createdAt       DateTime   @default(now())
  
  @@index([fundId])
  @@index([expenseDate])
}

// Avisos espec√≠ficos del grupo (por vocales)
model GroupAnnouncement {
  id           String   @id @default(cuid())
  groupId      String
  group        Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdById  String   // Vocal que cre√≥ el aviso
  createdBy    User     @relation("GroupAnnouncementCreator", fields: [createdById], references: [id])
  
  title        String
  content      String   @db.Text
  
  // Archivos adjuntos
  attachmentUrl  String?
  attachmentName String?
  
  // Vinculaci√≥n con colecta (opcional)
  linkedFundId String?
  linkedFund   GroupFund? @relation(fields: [linkedFundId], references: [id])
  
  isPinned     Boolean  @default(false)
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  reads        GroupAnnouncementRead[]
  
  @@index([groupId])
  @@index([createdAt])
}

// Lectura de avisos de grupo
model GroupAnnouncementRead {
  id             String            @id @default(cuid())
  announcementId String
  announcement   GroupAnnouncement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User              @relation(fields: [userId], references: [id])
  readAt         DateTime          @default(now())
  
  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
}

// ===============================
// M√ìDULO: Encuestas y NPS
// ===============================

enum SurveyType {
  NPS           // Net Promoter Score (0-10)
  SATISFACTION  // Satisfacci√≥n general (1-5 estrellas)
  FEEDBACK      // Encuesta con preguntas abiertas
  POLL          // Votaci√≥n simple
}

enum SurveyStatus {
  DRAFT
  ACTIVE
  CLOSED
  ARCHIVED
}

model Survey {
  id          String       @id @default(cuid())
  schoolId    String
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User         @relation("SurveyCreator", fields: [createdById], references: [id])
  
  title       String
  description String?      @db.Text
  type        SurveyType   @default(SATISFACTION)
  status      SurveyStatus @default(DRAFT)
  
  // Preguntas (JSON para flexibilidad)
  questions   Json         // [{ id, text, type: "rating"|"text"|"choice", options?: string[] }]
  
  // Audiencia
  targetRoles String[]     @default(["PADRE"]) // Roles que pueden responder
  targetGroups String[]    @default([])        // IDs de grupos espec√≠ficos (vac√≠o = todos)
  
  // Fechas
  startsAt    DateTime?
  endsAt      DateTime?
  
  // Estad√≠sticas cacheadas
  responseCount Int        @default(0)
  averageScore  Float?     // Para NPS/Satisfaction
  
  isAnonymous Boolean      @default(true)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  responses   SurveyResponse[]
  
  @@index([schoolId])
  @@index([status])
  @@index([type])
}

model SurveyResponse {
  id         String   @id @default(cuid())
  surveyId   String
  survey     Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  userId     String?  // Null si es an√≥nimo
  user       User?    @relation(fields: [userId], references: [id])
  
  // Respuestas (JSON)
  answers    Json     // { questionId: answer }
  
  // Para NPS/Satisfaction
  score      Int?     // 0-10 para NPS, 1-5 para satisfacci√≥n
  
  // Metadata
  ipHash     String?  // Hash del IP para evitar duplicados an√≥nimos
  userAgent  String?
  
  createdAt  DateTime @default(now())
  
  @@unique([surveyId, userId])
  @@index([surveyId])
  @@index([score])
}

// ===============================
// M√ìDULO: Inscripciones Online
// ===============================

enum EnrollmentStatus {
  PENDING       // Solicitud enviada
  REVIEWING     // En revisi√≥n
  DOCUMENTS     // Pendiente de documentos
  INTERVIEW     // Pendiente de entrevista
  ACCEPTED      // Aceptado
  REJECTED      // Rechazado
  WAITLIST      // Lista de espera
  ENROLLED      // Inscrito (completado)
  CANCELLED     // Cancelado por padre
}

model Enrollment {
  id           String           @id @default(cuid())
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Datos del solicitante (padre/tutor)
  parentName   String
  parentEmail  String
  parentPhone  String
  relationship String           // "madre", "padre", "tutor"
  
  // Datos del estudiante
  studentName  String
  studentBirthDate DateTime
  studentGender String?         // "M", "F", "Otro"
  currentSchool String?         // Escuela actual
  currentGrade String?          // Grado actual
  
  // Grado solicitado
  requestedGrade String         // "1ro Primaria", "Kinder 3", etc.
  requestedYear  Int            // Ciclo escolar: 2026, 2027, etc.
  
  // Ciclo escolar (referencia)
  schoolCycleId  String?
  schoolCycle    SchoolCycle?   @relation("CycleEnrollments", fields: [schoolCycleId], references: [id])
  
  // Informaci√≥n adicional
  siblings      String?         @db.Text // ¬øTiene hermanos en la escuela?
  howDidYouHear String?         // ¬øC√≥mo conoci√≥ la escuela?
  specialNeeds  String?         @db.Text // Necesidades especiales
  comments      String?         @db.Text
  
  // Documentos subidos
  documents     Json?           // [{ name, url, type }]
  
  // Estado y seguimiento
  status        EnrollmentStatus @default(PENDING)
  priority      Int              @default(0) // Prioridad de lista de espera
  
  // Entrevista
  interviewDate DateTime?
  interviewNotes String?        @db.Text
  
  // Revisi√≥n
  reviewedById  String?
  reviewedBy    User?           @relation("EnrollmentReviewer", fields: [reviewedById], references: [id])
  reviewedAt    DateTime?
  rejectionReason String?       @db.Text
  
  // Admin que proces√≥
  createdById   String?         // Si lo cre√≥ un admin
  createdBy     User?           @relation("EnrollmentCreator", fields: [createdById], references: [id])
  
  // Vinculaci√≥n con estudiante (cuando se inscribe)
  enrolledStudentId String?     @unique
  enrolledStudent   Student?    @relation("EnrollmentStudent", fields: [enrolledStudentId], references: [id])
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([schoolId])
  @@index([status])
  @@index([parentEmail])
  @@index([requestedYear])
}

// ===============================
// M√ìDULO: Permisos y Justificantes
// ===============================

enum PermitType {
  ABSENCE       // Justificante de ausencia
  EARLY_EXIT    // Permiso de salida temprana
  LATE_ARRIVAL  // Permiso de llegada tarde
  MEDICAL       // Permiso m√©dico
  FIELD_TRIP    // Autorizaci√≥n para salida escolar
  PHOTO_VIDEO   // Autorizaci√≥n foto/video
  OTHER         // Otro
}

enum PermitStatus {
  PENDING       // Pendiente de revisi√≥n
  APPROVED      // Aprobado
  REJECTED      // Rechazado
  EXPIRED       // Expirado (no procesado a tiempo)
}

model PermitRequest {
  id           String       @id @default(cuid())
  schoolId     String
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentId    String
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdById  String
  createdBy    User         @relation("PermitCreator", fields: [createdById], references: [id])
  
  type         PermitType
  status       PermitStatus @default(PENDING)
  
  // Detalles
  title        String
  reason       String       @db.Text
  
  // Fechas del permiso
  startDate    DateTime     // Fecha de inicio del permiso
  endDate      DateTime?    // Fecha fin (null si es solo un d√≠a)
  startTime    String?      // Hora (para salida temprana/llegada tarde)
  endTime      String?
  
  // Documentos de soporte
  attachmentUrl  String?
  attachmentName String?
  
  // Revisi√≥n
  reviewedById String?
  reviewedBy   User?        @relation("PermitReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  reviewNotes  String?
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@index([type])
  @@index([startDate])
}

// ==========================================
// BOLETAS DE CALIFICACIONES
// ==========================================

enum ReportCardPeriod {
  BIMESTRE_1
  BIMESTRE_2
  BIMESTRE_3
  BIMESTRE_4
  BIMESTRE_5
  TRIMESTRE_1
  TRIMESTRE_2
  TRIMESTRE_3
  SEMESTRE_1
  SEMESTRE_2
  ANUAL
}

enum ReportCardStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model ReportCard {
  id           String            @id @default(cuid())
  studentId    String
  student      Student           @relation("StudentReportCards", fields: [studentId], references: [id])
  schoolId     String
  school       School            @relation("SchoolReportCards", fields: [schoolId], references: [id])
  
  schoolYear   String            // "2025-2026"
  period       ReportCardPeriod
  status       ReportCardStatus  @default(DRAFT)
  
  // Promedios calculados
  finalAverage Float?
  attendance   Float?            // Porcentaje de asistencia
  absences     Int               @default(0)
  tardies      Int               @default(0)
  
  // Comentarios generales
  teacherComments String?        @db.Text
  principalComments String?      @db.Text
  
  // PDF generado
  pdfUrl       String?
  generatedAt  DateTime?
  publishedAt  DateTime?
  
  // Calificaciones por materia
  grades       ReportCardGrade[]
  
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  @@unique([studentId, schoolYear, period])
  @@index([schoolId])
  @@index([status])
}

model ReportCardGrade {
  id           String      @id @default(cuid())
  reportCardId String
  reportCard   ReportCard  @relation(fields: [reportCardId], references: [id], onDelete: Cascade)
  subjectId    String
  subject      Subject     @relation("SubjectGrades", fields: [subjectId], references: [id])
  
  grade        Float       // Calificaci√≥n num√©rica
  gradeText    String?     // Calificaci√≥n textual (A, B, C / Excelente, Bueno)
  comments     String?     // Comentarios del profesor
  
  @@unique([reportCardId, subjectId])
}

// ==========================================
// SISTEMA DE DISCIPLINA
// ==========================================

enum DisciplineType {
  POSITIVE          // Reconocimiento positivo
  WARNING           // Advertencia verbal
  WRITTEN_WARNING   // Amonestaci√≥n escrita
  DETENTION         // Detenci√≥n
  SUSPENSION        // Suspensi√≥n
  PARENT_MEETING    // Cita con padres
  OTHER
}

enum DisciplineSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model DisciplineRecord {
  id           String             @id @default(cuid())
  studentId    String
  student      Student            @relation("StudentDiscipline", fields: [studentId], references: [id])
  schoolId     String
  school       School             @relation("SchoolDiscipline", fields: [schoolId], references: [id])
  
  type         DisciplineType
  severity     DisciplineSeverity @default(MEDIUM)
  
  // Detalles del incidente
  date         DateTime
  description  String             @db.Text
  location     String?            // Lugar del incidente
  witnesses    String?            // Testigos
  
  // Puntos de conducta (positivos o negativos)
  points       Int                @default(0)
  
  // Acci√≥n tomada
  actionTaken  String?            @db.Text
  
  // Seguimiento
  parentNotified Boolean          @default(false)
  parentNotifiedAt DateTime?
  parentResponse String?          @db.Text
  resolved     Boolean            @default(false)
  resolvedAt   DateTime?
  
  // Evidencia/Adjuntos
  attachmentUrl String?
  
  // Registrado por
  recordedById String
  recordedBy   User               @relation("DisciplineRecorder", fields: [recordedById], references: [id])
  
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  
  @@index([studentId])
  @@index([schoolId])
  @@index([date])
  @@index([type])
}

// ==========================================
// M√ìDULO DE ENFERMER√çA
// ==========================================

enum NurseVisitType {
  ILLNESS           // Enfermedad
  INJURY            // Lesi√≥n/Accidente
  MEDICATION        // Administraci√≥n de medicamento
  CHECKUP           // Revisi√≥n rutinaria
  EMERGENCY         // Emergencia
  MENTAL_HEALTH     // Salud mental/emocional
  OTHER
}

enum NurseVisitStatus {
  IN_PROGRESS       // En atenci√≥n
  RETURNED_CLASS    // Regres√≥ a clase
  SENT_HOME         // Enviado a casa
  EMERGENCY_TRANSFER // Transferido a emergencias
  COMPLETED
}

model NurseVisit {
  id           String           @id @default(cuid())
  studentId    String
  student      Student          @relation("StudentNurseVisits", fields: [studentId], references: [id])
  schoolId     String
  school       School           @relation("SchoolNurseVisits", fields: [schoolId], references: [id])
  
  type         NurseVisitType
  status       NurseVisitStatus @default(IN_PROGRESS)
  
  // Tiempos
  arrivalTime  DateTime         @default(now())
  departureTime DateTime?
  
  // S√≠ntomas y diagn√≥stico
  chiefComplaint String          // Motivo principal de consulta
  symptoms     String?           @db.Text
  vitalSigns   String?           // Temperatura, presi√≥n, etc. (JSON)
  assessment   String?           @db.Text
  
  // Tratamiento
  treatment    String?           @db.Text
  medicationGiven String?        // Medicamentos administrados
  
  // Seguimiento
  followUpRequired Boolean       @default(false)
  followUpNotes String?          @db.Text
  
  // Comunicaci√≥n con padres
  parentNotified Boolean         @default(false)
  parentNotifiedAt DateTime?
  parentNotifiedBy String?       // Nombre de quien notific√≥
  parentResponse String?
  
  // En caso de emergencia
  emergencyContact String?       // Contacto de emergencia usado
  emergencyNotes String?         @db.Text
  
  // Archivo/Evidencia
  attachmentUrl String?
  
  // Registrado por
  recordedById String
  recordedBy   User              @relation("NurseRecorder", fields: [recordedById], references: [id])
  
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  @@index([studentId])
  @@index([schoolId])
  @@index([arrivalTime])
  @@index([type])
  @@index([status])
}

// Historial m√©dico del estudiante (informaci√≥n b√°sica)
model StudentMedicalInfo {
  id           String   @id @default(cuid())
  studentId    String   @unique
  student      Student  @relation("StudentMedicalInfo", fields: [studentId], references: [id])
  
  // Informaci√≥n b√°sica
  bloodType    String?
  allergies    String?  @db.Text
  medications  String?  @db.Text  // Medicamentos que toma regularmente
  conditions   String?  @db.Text  // Condiciones m√©dicas
  
  // Contactos de emergencia
  emergencyContact1Name  String?
  emergencyContact1Phone String?
  emergencyContact1Relation String?
  emergencyContact2Name  String?
  emergencyContact2Phone String?
  emergencyContact2Relation String?
  
  // Doctor/Hospital preferido
  doctorName   String?
  doctorPhone  String?
  preferredHospital String?
  insuranceInfo String?
  
  // Notas adicionales
  notes        String?  @db.Text
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ==========================================
// IMPORTACI√ìN MASIVA
// ==========================================

enum ImportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  PARTIALLY_COMPLETED
}

enum ImportJobType {
  STUDENTS
  PARENTS
  TEACHERS
  GROUPS
  SUBJECTS
  GRADES
}

model BulkImportJob {
  id           String          @id @default(cuid())
  schoolId     String
  school       School          @relation("SchoolImports", fields: [schoolId], references: [id])
  
  type         ImportJobType
  status       ImportJobStatus @default(PENDING)
  
  // Archivo original
  fileName     String
  fileUrl      String?
  
  // Resultados
  totalRows    Int             @default(0)
  successCount Int             @default(0)
  errorCount   Int             @default(0)
  errors       String?         @db.Text  // JSON con errores detallados
  
  // Procesamiento
  startedAt    DateTime?
  completedAt  DateTime?
  
  // Usuario que inici√≥
  createdById  String
  createdBy    User            @relation("ImportCreator", fields: [createdById], references: [id])
  
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  
  @@index([schoolId])
  @@index([status])
}

// Push Notifications
model PushSubscription {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation("UserPushSubscriptions", fields: [userId], references: [id], onDelete: Cascade)
  
  endpoint     String   @unique
  p256dh       String   @db.Text
  auth         String
  
  // Device info
  userAgent    String?
  deviceType   String?  // mobile, desktop, tablet
  
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([userId])
  @@index([isActive])
}

// ==========================================
// M√ìDULO DE BECAS Y DESCUENTOS
// ==========================================

enum ScholarshipType {
  BECA_ACADEMICA      // Por excelencia acad√©mica
  BECA_DEPORTIVA      // Por logros deportivos
  BECA_NECESIDAD      // Por necesidad econ√≥mica
  DESCUENTO_HERMANOS  // Descuento por hermanos
  DESCUENTO_PRONTO_PAGO // Descuento por pago anticipado
  DESCUENTO_ANUAL     // Descuento por pago anual
  BECA_EMPLEADO       // Para hijos de empleados
  CONVENIO            // Por convenio empresarial
  OTRO
}

enum ScholarshipStatus {
  ACTIVA
  SUSPENDIDA
  VENCIDA
  CANCELADA
}

enum DiscountApplyTo {
  COLEGIATURA       // Solo mensualidades
  INSCRIPCION       // Solo inscripci√≥n
  AMBOS             // Colegiatura e inscripci√≥n
  TODO              // Todos los conceptos
}

// Tipos de becas/descuentos disponibles en la escuela
model Scholarship {
  id           String             @id @default(cuid())
  schoolId     String
  school       School             @relation("SchoolScholarships", fields: [schoolId], references: [id])
  
  name         String             // Nombre de la beca
  type         ScholarshipType
  description  String?            @db.Text
  
  // Configuraci√≥n del descuento
  discountType String             @default("PERCENTAGE") // PERCENTAGE o FIXED
  discountValue Float             // Porcentaje (0-100) o monto fijo
  applyTo      DiscountApplyTo    @default(COLEGIATURA)
  
  // Requisitos
  minGPA       Float?             // Promedio m√≠nimo requerido
  requirements String?            @db.Text
  
  // Vigencia
  isActive     Boolean            @default(true)
  validFrom    DateTime?
  validUntil   DateTime?
  
  // L√≠mites
  maxBeneficiaries Int?           // M√°ximo de estudiantes con esta beca
  currentBeneficiaries Int        @default(0)
  
  // Creado por (solo ADMIN con subrol CAJA o DIRECCION)
  createdById  String
  createdBy    User               @relation("ScholarshipCreator", fields: [createdById], references: [id])
  
  // Estudiantes con esta beca
  students     StudentScholarship[]
  
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  
  @@index([schoolId])
  @@index([type])
  @@index([isActive])
}

// Becas asignadas a estudiantes espec√≠ficos
model StudentScholarship {
  id             String            @id @default(cuid())
  studentId      String
  student        Student           @relation("StudentScholarships", fields: [studentId], references: [id])
  scholarshipId  String
  scholarship    Scholarship       @relation(fields: [scholarshipId], references: [id])
  
  status         ScholarshipStatus @default(ACTIVA)
  
  // Personalizaci√≥n (puede sobreescribir el % de la beca)
  customDiscountValue Float?
  
  // Periodo de aplicaci√≥n
  validFrom      DateTime
  validUntil     DateTime?
  
  // Documentos de soporte
  supportingDocUrl String?
  
  // Notas/Observaciones
  notes          String?           @db.Text
  
  // Auditor√≠a
  approvedAt     DateTime?
  approvedBy     String?           // ID del admin que aprob√≥
  
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  
  @@unique([studentId, scholarshipId])
  @@index([studentId])
  @@index([scholarshipId])
  @@index([status])
}

// ==========================================
// M√ìDULO PSICOEMOCIONAL
// ==========================================

enum PsychologicalRecordType {
  SESION_INDIVIDUAL     // Sesi√≥n individual con el alumno
  SESION_FAMILIAR       // Sesi√≥n con padres/familia
  OBSERVACION_AULA      // Observaci√≥n en clase
  EVALUACION            // Evaluaci√≥n psicol√≥gica
  INTERVENCION_CRISIS   // Intervenci√≥n en crisis
  SEGUIMIENTO           // Seguimiento de caso
  CANALIZACION          // Canalizaci√≥n externa
  REPORTE_DOCENTE       // Reporte de profesor
  ALERTA_ACADEMICA      // Alerta por bajo rendimiento
  OTRO
}

enum PsychologicalAlertLevel {
  BAJO            // Seguimiento rutinario
  MEDIO           // Requiere atenci√≥n
  ALTO            // Prioridad alta
  URGENTE         // Atenci√≥n inmediata
}

enum EmotionalState {
  ESTABLE
  ANSIOSO
  DEPRIMIDO
  AGITADO
  RETRAIDO
  AGRESIVO
  TEMEROSO
  CONFUNDIDO
  COOPERATIVO
  RESISTENTE
}

model PsychologicalRecord {
  id           String                    @id @default(cuid())
  studentId    String
  student      Student                   @relation("StudentPsychological", fields: [studentId], references: [id])
  schoolId     String
  school       School                    @relation("SchoolPsychological", fields: [schoolId], references: [id])
  
  type         PsychologicalRecordType
  alertLevel   PsychologicalAlertLevel   @default(BAJO)
  
  // Fecha y duraci√≥n
  date         DateTime
  duration     Int?                      // Minutos
  
  // Evaluaci√≥n emocional
  emotionalState EmotionalState?
  
  // Contenido de la sesi√≥n
  reason       String                    // Motivo de consulta
  description  String                    @db.Text
  observations String?                   @db.Text
  
  // Plan de acci√≥n
  actionPlan   String?                   @db.Text
  recommendations String?                @db.Text
  
  // Seguimiento
  followUpRequired Boolean               @default(false)
  followUpDate DateTime?
  followUpNotes String?                  @db.Text
  
  // Comunicaci√≥n con padres
  parentNotified Boolean                 @default(false)
  parentNotifiedAt DateTime?
  parentMeetingScheduled Boolean         @default(false)
  parentMeetingDate DateTime?
  
  // Canalizaci√≥n externa
  externalReferral Boolean               @default(false)
  externalProvider String?               // Psic√≥logo/Psiquiatra externo
  externalReferralReason String?         @db.Text
  
  // Confidencialidad
  isConfidential Boolean                 @default(true)
  visibleToTeachers Boolean              @default(false)
  
  // Documentos adjuntos
  attachmentUrl String?
  
  // Registrado por (psic√≥logo escolar)
  recordedById String
  recordedBy   User                      @relation("PsychologistRecords", fields: [recordedById], references: [id])
  
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  
  @@index([studentId])
  @@index([schoolId])
  @@index([date])
  @@index([alertLevel])
  @@index([type])
}

// ==========================================
// PERSONAS Y VEH√çCULOS AUTORIZADOS
// ==========================================

enum PickupRelationship {
  PADRE
  MADRE
  ABUELO_A
  TIO_A
  HERMANO_A
  CHOFER
  NANA
  VECINO
  OTRO
}

model AuthorizedPickup {
  id           String             @id @default(cuid())
  studentId    String
  student      Student            @relation("StudentAuthorizedPickups", fields: [studentId], references: [id])
  
  // Informaci√≥n de la persona
  fullName     String
  relationship PickupRelationship
  relationshipOther String?       // Si es OTRO, especificar
  phone        String
  email        String?
  
  // Identificaci√≥n
  idType       String?            // INE, Pasaporte, etc.
  idNumber     String?
  photoUrl     String?            // Foto de la persona
  idDocumentUrl String?           // Foto de la identificaci√≥n
  
  // Veh√≠culos asociados a esta persona
  vehicles     AuthorizedVehicle[]
  
  // Permisos
  canPickupAlone Boolean          @default(true)
  requiresIdVerification Boolean  @default(true)
  
  // Estado
  isActive     Boolean            @default(true)
  activeFrom   DateTime           @default(now())
  activeUntil  DateTime?          // Para autorizaciones temporales
  
  // Notas/Instrucciones especiales
  notes        String?            @db.Text
  
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  
  @@index([studentId])
  @@index([isActive])
}

model AuthorizedVehicle {
  id                 String           @id @default(cuid())
  authorizedPickupId String
  authorizedPickup   AuthorizedPickup @relation(fields: [authorizedPickupId], references: [id], onDelete: Cascade)
  
  // Informaci√≥n del veh√≠culo
  make         String             // Marca
  model        String             // Modelo
  year         Int?
  color        String
  licensePlate String
  
  // Identificaci√≥n visual
  photoUrl     String?            // Foto del veh√≠culo
  
  // Estado
  isActive     Boolean            @default(true)
  
  // Notas
  notes        String?
  
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  
  @@index([authorizedPickupId])
  @@index([licensePlate])
}
// ==========================================
// T√âRMINOS Y CONDICIONES
// ==========================================

enum TermsType {
  GENERAL              // T&C generales de la plataforma
  PRIVACY_POLICY       // Pol√≠tica de privacidad
  ECOMMERCE            // T&C de tienda (deslinde IA School)
  PAYMENTS             // T&C de pagos
  AFFILIATE            // T&C programa de afiliados
  SCHOOL_SPECIFIC      // T&C espec√≠ficos del colegio
}

model TermsAndConditions {
  id           String       @id @default(cuid())
  type         TermsType
  version      String       // e.g., "1.0", "2.0"
  title        String
  content      String       @db.Text
  summary      String?      @db.Text  // Resumen corto
  
  // Puede ser espec√≠fico de un colegio o global (schoolId = null)
  schoolId     String?
  school       School?      @relation("SchoolTerms", fields: [schoolId], references: [id])
  
  isActive     Boolean      @default(true)
  isMandatory  Boolean      @default(true)
  
  effectiveFrom DateTime    @default(now())
  effectiveUntil DateTime?
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  acceptances  UserTermsAcceptance[]
  
  @@unique([type, version, schoolId])
  @@index([type])
  @@index([schoolId])
  @@index([isActive])
}

model UserTermsAcceptance {
  id           String              @id @default(cuid())
  userId       String
  user         User                @relation("UserTermsAcceptances", fields: [userId], references: [id])
  
  termsId      String
  terms        TermsAndConditions  @relation(fields: [termsId], references: [id])
  
  acceptedAt   DateTime            @default(now())
  ipAddress    String?
  userAgent    String?
  
  // Para contexto de d√≥nde se acept√≥
  context      String?             // "registration", "login", "checkout", "affiliate"
  
  @@unique([userId, termsId])
  @@index([userId])
  @@index([termsId])
}

// ==========================================
// SISTEMA DE MEMBRES√çAS Y PLANES
// ==========================================

enum PlanType {
  BASIC      // $149/alumno/mes
  STANDARD   // $199/alumno/mes
  PREMIUM    // $299/alumno/mes
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL
  PENDING_PAYMENT
}

model SubscriptionPlan {
  id                String      @id @default(cuid())
  name              String      // "B√°sico", "Est√°ndar", "Premium"
  type              PlanType    @unique
  pricePerStudent   Decimal     @db.Decimal(10, 2)  // Precio por alumno/mes
  iaSchoolShare     Decimal     @db.Decimal(5, 2)   // Porcentaje IA School (50)
  schoolShare       Decimal     @db.Decimal(5, 2)   // Porcentaje Colegio (50)
  
  description       String?     @db.Text
  features          Json        // Lista de features incluidas
  
  // Descuentos
  annualDiscountMonths Int      @default(2)  // Meses gratis por pago anual
  
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  schoolSubscriptions SchoolSubscription[]
  parentSubscriptions ParentSubscription[]
  quotes              Quote[] @relation("QuotePlan")
}

// Setup fees por tama√±o de colegio
model SetupFeeTier {
  id              String   @id @default(cuid())
  name            String   // "Micro", "Peque√±o", "Mediano", "Grande", "Enterprise"
  minStudents     Int
  maxStudents     Int?     // null = sin l√≠mite
  setupFee        Decimal  @db.Decimal(10, 2)
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([minStudents])
}

// Suscripci√≥n del colegio
model SchoolSubscription {
  id              String             @id @default(cuid())
  schoolId        String             @unique
  school          School             @relation("SchoolSubscription", fields: [schoolId], references: [id])
  
  planId          String
  plan            SubscriptionPlan   @relation(fields: [planId], references: [id])
  
  status          SubscriptionStatus @default(PENDING_PAYMENT)
  
  // Configuraci√≥n de precios (puede variar del plan base por acuerdos)
  customPricePerStudent Decimal?     @db.Decimal(10, 2)
  customIaSchoolShare   Decimal?     @db.Decimal(5, 2)
  customSchoolShare     Decimal?     @db.Decimal(5, 2)
  
  // Setup
  setupFeePaid    Boolean            @default(false)
  setupFeeAmount  Decimal?           @db.Decimal(10, 2)
  setupFeePaidAt  DateTime?
  
  // Fechas
  startDate       DateTime           @default(now())
  endDate         DateTime?
  trialEndsAt     DateTime?
  
  // Stripe Connect
  stripeAccountId String?            // Cuenta Stripe del colegio
  stripeAccountStatus String?        // "pending", "active", "restricted"
  
  // Billing
  billingDay      Int                @default(1)  // D√≠a del mes para cobrar
  paymentMethod   String?            // "school_collects", "platform_collects"
  
  // ============================================
  // BLINDAJE AFILIADOS - First Touch Attribution
  // ============================================
  // CR√çTICO: Solo se vincula el PRIMER link de afiliado usado para registrar
  registeredViaAffiliateId  String?          // ID del AffiliateReferral que registr√≥ la escuela
  registeredViaAffiliate    AffiliateReferral? @relation("SchoolRegisteredViaAffiliate", fields: [registeredViaAffiliateId], references: [id])
  affiliateRegistrationDate DateTime?        // Fecha exacta del registro v√≠a afiliado
  affiliateBenefitsLocked   Boolean          @default(false) // Una vez true, no se puede cambiar el afiliado
  
  // ============================================
  // CONTROL DE MOROSIDAD B2B (Colegio a IA School)
  // ============================================
  // Status de pago del colegio a IA School
  b2bPaymentStatus     B2BPaymentStatus  @default(CURRENT)
  b2bDelinquentSince   DateTime?         // Fecha desde cuando est√° moroso
  b2bGracePeriodDays   Int               @default(15) // D√≠as de gracia antes de suspensi√≥n
  b2bSuspendedAt       DateTime?         // Fecha de suspensi√≥n por morosidad
  b2bLastPaymentDate   DateTime?         // √öltimo pago recibido
  b2bNextDueDate       DateTime?         // Pr√≥xima fecha de pago
  b2bCurrentBalance    Decimal           @db.Decimal(12, 2) @default(0) // Saldo pendiente
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  parentSubscriptions ParentSubscription[]
  b2bPayments         SchoolB2BPayment[] @relation("SubscriptionB2BPayments")
  
  @@index([status])
  @@index([b2bPaymentStatus])
  @@index([registeredViaAffiliateId])
}

// ==========================================
// PAGOS B2B - Colegio a IA School
// ==========================================

enum B2BPaymentStatus {
  CURRENT        // Al corriente
  GRACE_PERIOD   // En per√≠odo de gracia
  OVERDUE        // Vencido (despu√©s de gracia)
  SUSPENDED      // Suspendido por falta de pago
  CANCELLED      // Cancelado definitivamente
}

enum B2BPaymentType {
  SETUP_FEE           // Pago inicial de setup
  MONTHLY_SHARE       // Participaci√≥n mensual 50%
  ADJUSTMENT          // Ajuste
  PENALTY             // Penalizaci√≥n por morosidad
  CREDIT              // Cr√©dito/Devoluci√≥n
}

// Registro de pagos del colegio a IA School
model SchoolB2BPayment {
  id                    String             @id @default(cuid())
  
  schoolSubscriptionId  String
  schoolSubscription    SchoolSubscription @relation("SubscriptionB2BPayments", fields: [schoolSubscriptionId], references: [id])
  
  // Tipo de pago
  paymentType           B2BPaymentType     @default(MONTHLY_SHARE)
  
  // Per√≠odo que cubre
  periodMonth           Int?               // 1-12
  periodYear            Int?               // 2026, 2027, etc.
  
  // Montos
  expectedAmount        Decimal            @db.Decimal(12, 2) // Lo que deb√≠a pagar
  paidAmount            Decimal            @db.Decimal(12, 2) // Lo que pag√≥
  penaltyAmount         Decimal            @db.Decimal(10, 2) @default(0) // Recargos
  
  // Detalles del c√°lculo
  totalStudents         Int?               // Alumnos activos en el per√≠odo
  pricePerStudent       Decimal?           @db.Decimal(10, 2)
  sharePercentage       Decimal?           @db.Decimal(5, 2) // 50%
  
  // M√©todo de pago
  paymentMethod         String?            // "bank_transfer", "stripe", "cash", "check"
  referenceNumber       String?            // N√∫mero de referencia/transferencia
  bankName              String?
  
  // Comprobante
  receiptUrl            String?
  receiptCloudPath      String?
  
  // Fechas
  dueDate               DateTime
  paidAt                DateTime?
  verifiedAt            DateTime?          // Cuando se verific√≥ el pago
  verifiedById          String?            // Quien verific√≥
  
  // Notas
  notes                 String?            @db.Text
  internalNotes         String?            @db.Text
  
  status                B2BPaymentRecordStatus @default(PENDING)
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  
  @@unique([schoolSubscriptionId, periodMonth, periodYear, paymentType])
  @@index([schoolSubscriptionId])
  @@index([status])
  @@index([dueDate])
  @@index([periodYear, periodMonth])
}

enum B2BPaymentRecordStatus {
  PENDING       // Esperando pago
  RECEIVED      // Recibido, pendiente verificaci√≥n
  VERIFIED      // Verificado y aplicado
  PARTIAL       // Pago parcial
  OVERDUE       // Vencido
  DISPUTED      // En disputa
  REFUNDED      // Devuelto
}

// Suscripci√≥n individual de cada padre
model ParentSubscription {
  id                    String             @id @default(cuid())
  userId                String
  user                  User               @relation("ParentSubscriptions", fields: [userId], references: [id])
  
  studentId             String             @unique
  student               Student            @relation("StudentSubscription", fields: [studentId], references: [id])
  
  schoolSubscriptionId  String
  schoolSubscription    SchoolSubscription @relation(fields: [schoolSubscriptionId], references: [id])
  
  planId                String
  plan                  SubscriptionPlan   @relation(fields: [planId], references: [id])
  
  status                SubscriptionStatus @default(ACTIVE)
  
  // Descuentos aplicados
  discountAmount        Decimal?           @db.Decimal(10, 2)
  discountReason        String?            // "affiliate_signer", "annual_payment", etc.
  
  // Control de morosidad
  isDelinquent          Boolean            @default(false)
  delinquentSince       DateTime?
  restrictedAccess      Boolean            @default(false)  // Solo lectura, chat apagado
  
  // Afiliado que refiri√≥ (si aplica)
  referredByAffiliateId String?
  
  // Fechas
  startDate             DateTime           @default(now())
  endDate               DateTime?
  
  // Pagos
  isAnnual              Boolean            @default(false)
  lastPaymentDate       DateTime?
  nextPaymentDate       DateTime?
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  
  @@unique([userId, studentId])
  @@index([userId])
  @@index([studentId])
  @@index([status])
  @@index([isDelinquent])
}

// ==========================================
// PROGRAMA DE AFILIADOS
// ==========================================

enum AffiliateStatus {
  PENDING           // Esperando que el colegio se registre
  SCHOOL_REGISTERED // Colegio registrado, pendiente activaci√≥n
  ACTIVE            // Activo - beneficios aplicados
  EXPIRED           // Expir√≥ el tiempo (30 d√≠as)
  CANCELLED         // Cancelado
}

model AffiliateReferral {
  id              String          @id @default(cuid())
  
  // Mam√°/Padre referente (debe pertenecer al colegio)
  referrerId      String
  referrer        User            @relation("AffiliateReferrals", fields: [referrerId], references: [id])
  
  // C√≥digo √∫nico de referido
  referralCode    String          @unique
  referralLink    String?
  
  // Colegio objetivo (el colegio al que pertenece el referente)
  schoolId        String
  school          School          @relation("SchoolAffiliates", fields: [schoolId], references: [id])
  
  status          AffiliateStatus @default(PENDING)
  
  // Beneficios del referente
  setupFeeEarned        Decimal?    @db.Decimal(10, 2)  // 10% del setup
  freeSubscriptionMonths Int        @default(12)        // 1 a√±o gratis
  freeForStudentId      String?     // Solo para 1 hijo
  
  // Seguimiento
  totalSignatures   Int           @default(0)
  schoolRegisteredAt DateTime?
  benefitsActivatedAt DateTime?
  
  // Vigencia
  expiresAt       DateTime         // 30 d√≠as desde creaci√≥n
  
  // ============================================
  // BLINDAJE: Primera atribuci√≥n vinculante
  // ============================================
  // T√©rminos espec√≠ficos que el referente acept√≥
  termsVersion          String?     // Versi√≥n de T&C aceptados
  termsAcceptedAt       DateTime?
  
  // IP y evidencia del registro
  registrationIP        String?
  registrationUserAgent String?     @db.Text
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  signatures      AffiliatePetitionSignature[]
  
  // Relaci√≥n inversa: escuelas que se registraron con ESTE link espec√≠fico
  schoolsRegistered SchoolSubscription[] @relation("SchoolRegisteredViaAffiliate")
  
  @@index([referrerId])
  @@index([schoolId])
  @@index([referralCode])
  @@index([status])
}

// Firmas de otras mam√°s/padres en la petici√≥n
model AffiliatePetitionSignature {
  id              String             @id @default(cuid())
  referralId      String
  referral        AffiliateReferral  @relation(fields: [referralId], references: [id], onDelete: Cascade)
  
  // Firmante (debe ser padre del mismo colegio)
  signerId        String
  signer          User               @relation("AffiliateSignatures", fields: [signerId], references: [id])
  
  // Descuento ganado
  discountAmount  Decimal            @db.Decimal(10, 2) @default(200)  // $200 MXN
  discountApplied Boolean            @default(false)
  discountAppliedAt DateTime?
  
  // Aceptaci√≥n de t√©rminos
  termsAccepted   Boolean            @default(false)
  termsAcceptedAt DateTime?
  
  signedAt        DateTime           @default(now())
  
  @@unique([referralId, signerId])
  @@index([referralId])
  @@index([signerId])
}

// ==========================================
// SISTEMA DE COTIZACIONES Y NEGOCIACIONES
// ==========================================

enum QuoteStatus {
  DRAFT
  SENT
  VIEWED
  NEGOTIATING
  ACCEPTED
  REJECTED
  EXPIRED
}

model Quote {
  id              String       @id @default(cuid())
  quoteNumber     String       @unique  // COT-2026-0001
  
  // Informaci√≥n del colegio prospecto
  schoolName      String
  contactName     String
  contactEmail    String
  contactPhone    String?
  address         String?
  
  // Detalles
  estimatedStudents Int
  selectedPlanId    String?
  selectedPlan      SubscriptionPlan? @relation("QuotePlan", fields: [selectedPlanId], references: [id])
  
  // C√°lculos
  setupFee        Decimal      @db.Decimal(10, 2)
  monthlyTotal    Decimal      @db.Decimal(10, 2)
  annualTotal     Decimal      @db.Decimal(10, 2)
  iaSchoolMonthly Decimal      @db.Decimal(10, 2)
  schoolMonthly   Decimal      @db.Decimal(10, 2)
  
  // Descuentos negociados
  setupFeeDiscount    Decimal?  @db.Decimal(10, 2)
  customPricePerStudent Decimal? @db.Decimal(10, 2)
  
  status          QuoteStatus  @default(DRAFT)
  
  // Seguimiento
  sentAt          DateTime?
  viewedAt        DateTime?
  respondedAt     DateTime?
  expiresAt       DateTime?
  
  // Notas de negociaci√≥n
  notes           String?      @db.Text
  internalNotes   String?      @db.Text
  
  // Si se convirti√≥ en colegio
  convertedToSchoolId String?
  
  createdById     String
  createdBy       User         @relation("QuotesCreated", fields: [createdById], references: [id])
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  negotiations    QuoteNegotiation[]
  
  @@index([status])
  @@index([schoolName])
  @@index([createdById])
}

model QuoteNegotiation {
  id          String   @id @default(cuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  // Registro de la negociaci√≥n
  action      String   // "created", "sent", "viewed", "counter_offer", "accepted", "rejected"
  notes       String?  @db.Text
  
  // Cambios propuestos
  proposedChanges Json?
  
  createdById String
  createdBy   User     @relation("NegotiationsCreated", fields: [createdById], references: [id])
  
  createdAt   DateTime @default(now())
  
  @@index([quoteId])
}

// Acuerdos finales con colegios
model SchoolAgreement {
  id              String   @id @default(cuid())
  schoolId        String   @unique
  school          School   @relation("SchoolAgreement", fields: [schoolId], references: [id])
  
  // T√©rminos acordados
  planType        PlanType
  pricePerStudent Decimal  @db.Decimal(10, 2)
  iaSchoolShare   Decimal  @db.Decimal(5, 2)
  schoolShare     Decimal  @db.Decimal(5, 2)
  
  setupFee        Decimal  @db.Decimal(10, 2)
  setupFeeStatus  String   @default("pending")  // "pending", "paid", "waived"
  
  // E-commerce
  ecommerceServiceFee     Decimal? @db.Decimal(5, 2)  // % cargo servicio (100% colegio)
  ecommerceServiceFeeFixed Decimal? @db.Decimal(10, 2) // O monto fijo
  
  // Condiciones especiales
  specialTerms    String?  @db.Text
  
  // Documentos
  contractUrl     String?
  signedAt        DateTime?
  
  // Vigencia
  startDate       DateTime @default(now())
  endDate         DateTime?
  autoRenew       Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([planType])
}

// ==========================================
// M√ìDULO DE COMEDOR
// ==========================================

enum MealType {
  BREAKFAST
  LUNCH
  SNACK
}

model CafeteriaMenu {
  id          String    @id @default(cuid())
  schoolId    String
  school      School    @relation("SchoolCafeteria", fields: [schoolId], references: [id])
  
  weekStartDate DateTime  // Lunes de la semana
  
  isPublished Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  items       CafeteriaMenuItem[]
  
  @@unique([schoolId, weekStartDate])
  @@index([schoolId])
  @@index([weekStartDate])
}

model CafeteriaMenuItem {
  id          String     @id @default(cuid())
  menuId      String
  menu        CafeteriaMenu @relation(fields: [menuId], references: [id], onDelete: Cascade)
  
  dayOfWeek   Int        // 1-5 (Lunes-Viernes)
  mealType    MealType
  
  name        String
  description String?
  imageUrl    String?
  
  price       Decimal?   @db.Decimal(10, 2)  // null = no disponible para compra
  isAvailable Boolean    @default(true)
  
  // Informaci√≥n nutricional
  calories    Int?
  allergens   String?    // "gluten, lactosa, nueces"
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@index([menuId])
  @@index([dayOfWeek])
}

// Configuraci√≥n de Stripe para diferentes entidades
model StripeConnectAccount {
  id              String   @id @default(cuid())
  
  // Puede ser colegio, vocal, o comedor
  entityType      String   // "school", "vocal", "cafeteria"
  entityId        String   // schoolId, vocalId, etc.
  
  // Stripe
  stripeAccountId String   @unique
  accountStatus   String   @default("pending")  // "pending", "active", "restricted"
  chargesEnabled  Boolean  @default(false)
  payoutsEnabled  Boolean  @default(false)
  
  // Datos bancarios b√°sicos (para referencia)
  bankLast4       String?
  bankName        String?
  
  // Onboarding
  onboardingComplete Boolean @default(false)
  onboardingUrl     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([entityType, entityId])
  @@index([entityType])
  @@index([stripeAccountId])
}

// ==========================================
// M√ìDULO DE RENDIMIENTO DE PROFESORES
// ==========================================

enum PerformanceCategory {
  ATTENDANCE
  TASK_COMPLETION
  COMMUNICATION
  STUDENT_GRADES
  PARENT_SATISFACTION
  PUNCTUALITY
}

model TeacherPerformanceMetric {
  id            String   @id @default(cuid())
  schoolId      String
  school        School   @relation("SchoolTeacherPerformance", fields: [schoolId], references: [id])
  
  teacherId     String
  teacher       User     @relation("TeacherMetrics", fields: [teacherId], references: [id])
  
  category      PerformanceCategory
  
  periodStart   DateTime
  periodEnd     DateTime
  
  // Valores
  value         Decimal  @db.Decimal(5, 2)  // Porcentaje o puntaje
  target        Decimal? @db.Decimal(5, 2)  // Meta objetivo
  
  // Detalles adicionales
  details       Json?    // Detalles espec√≠ficos seg√∫n categor√≠a
  notes         String?
  
  calculatedAt  DateTime @default(now())
  createdAt     DateTime @default(now())
  
  @@index([schoolId])
  @@index([teacherId])
  @@index([category])
  @@index([periodStart, periodEnd])
}

model TeacherPerformanceReview {
  id            String   @id @default(cuid())
  schoolId      String
  school        School   @relation("SchoolTeacherReviews", fields: [schoolId], references: [id])
  
  teacherId     String
  teacher       User     @relation("TeacherReviews", fields: [teacherId], references: [id])
  
  reviewerId    String
  reviewer      User     @relation("TeacherReviewsGiven", fields: [reviewerId], references: [id])
  
  periodStart   DateTime
  periodEnd     DateTime
  
  // Puntuaci√≥n general
  overallScore  Decimal  @db.Decimal(5, 2)
  
  // Desglose por categor√≠a
  attendanceScore      Decimal? @db.Decimal(5, 2)
  taskCompletionScore  Decimal? @db.Decimal(5, 2)
  communicationScore   Decimal? @db.Decimal(5, 2)
  studentGradesScore   Decimal? @db.Decimal(5, 2)
  punctualityScore     Decimal? @db.Decimal(5, 2)
  
  // Feedback
  strengths     String?
  areasToImprove String?
  comments      String?
  goals         String?  // Metas para siguiente per√≠odo
  
  // Estado
  status        String   @default("draft") // draft, submitted, acknowledged
  acknowledgedAt DateTime?
  teacherComments String?  // Comentarios del profesor
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([schoolId])
  @@index([teacherId])
  @@index([periodStart, periodEnd])
}

// ==========================================
// M√ìDULO DE REPORTES POR √ÅREA
// ==========================================

enum ReportType {
  ACADEMIC
  FINANCIAL
  ATTENDANCE
  COMMUNICATION
  DISCIPLINE
  HEALTH
  PERFORMANCE
  ENROLLMENT
  STORE
  CUSTOM
}

model ReportSchedule {
  id            String     @id @default(cuid())
  schoolId      String
  school        School     @relation("SchoolReportSchedules", fields: [schoolId], references: [id])
  
  name          String
  description   String?
  reportType    ReportType
  
  // Configuraci√≥n
  frequency     String     // "daily", "weekly", "monthly", "quarterly"
  dayOfWeek     Int?       // 1-7 para weekly
  dayOfMonth    Int?       // 1-31 para monthly
  
  // Filtros guardados
  filters       Json?      // Filtros espec√≠ficos del reporte
  
  // Distribuci√≥n
  recipients    String[]   // Email addresses
  
  isActive      Boolean    @default(true)
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  
  createdById   String
  createdBy     User       @relation("ReportSchedulesCreated", fields: [createdById], references: [id])
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  executions    ReportExecution[]
  
  @@index([schoolId])
  @@index([reportType])
}

model ReportExecution {
  id            String     @id @default(cuid())
  scheduleId    String?
  schedule      ReportSchedule? @relation(fields: [scheduleId], references: [id])
  
  schoolId      String
  school        School     @relation("SchoolReportExecutions", fields: [schoolId], references: [id])
  
  reportType    ReportType
  name          String
  
  // Par√°metros usados
  parameters    Json?
  
  // Resultados
  status        String     @default("running") // running, completed, failed
  fileUrl       String?    // URL del archivo generado
  errorMessage  String?
  
  // M√©tricas de ejecuci√≥n
  startedAt     DateTime   @default(now())
  completedAt   DateTime?
  rowCount      Int?       // Cantidad de registros en el reporte
  
  generatedById String
  generatedBy   User       @relation("ReportsGenerated", fields: [generatedById], references: [id])
  
  createdAt     DateTime   @default(now())
  
  @@index([schoolId])
  @@index([reportType])
  @@index([status])
}

// ==========================================
// M√ìDULO DE PROVEEDORES (VENDORS)
// ==========================================

enum VendorStatus {
  PENDING
  APPROVED
  SUSPENDED
  REJECTED
}

enum VendorType {
  STORE         // Tienda escolar
  CAFETERIA     // Comedor
  BOTH
}

model Vendor {
  id              String       @id @default(cuid())
  schoolId        String
  school          School       @relation("SchoolVendors", fields: [schoolId], references: [id])
  
  // Informaci√≥n b√°sica
  name            String
  description     String?
  logoUrl         String?
  
  // Tipo y estado
  type            VendorType
  status          VendorStatus @default(PENDING)
  
  // Contacto
  contactName     String
  contactEmail    String
  contactPhone    String?
  
  // Direcci√≥n (para env√≠os)
  address         String?
  city            String?
  state           String?
  zipCode         String?
  
  // RFC para facturaci√≥n
  rfc             String?
  businessName    String?
  
  // Stripe Connect
  stripeAccountId String?
  chargesEnabled  Boolean      @default(false)
  payoutsEnabled  Boolean      @default(false)
  
  // Configuraci√≥n de env√≠os
  shippingEnabled Boolean      @default(false)
  enviaApiKey     String?      // API key de envia.com
  
  // Comisiones
  commissionRate  Decimal      @default(0) @db.Decimal(5, 2)  // % que cobra el colegio
  
  // Usuario propietario
  ownerId         String
  owner           User         @relation("VendorOwner", fields: [ownerId], references: [id])
  
  approvedById    String?
  approvedBy      User?        @relation("VendorApprovals", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  products        VendorProduct[]
  orders          VendorOrder[]
  payouts         VendorPayout[]
  
  @@index([schoolId])
  @@index([status])
  @@index([type])
  @@index([ownerId])
}

model VendorProduct {
  id              String    @id @default(cuid())
  vendorId        String
  vendor          Vendor    @relation(fields: [vendorId], references: [id])
  
  // Categor√≠a (si aplica al Store del colegio)
  categoryId      String?
  category        StoreCategory? @relation(fields: [categoryId], references: [id])
  
  // Datos del producto
  name            String
  description     String?
  sku             String?
  imageUrl        String?
  images          String[]   // URLs adicionales
  
  // Precios
  price           Decimal    @db.Decimal(10, 2)
  compareAtPrice  Decimal?   @db.Decimal(10, 2)  // Precio tachado
  cost            Decimal?   @db.Decimal(10, 2)  // Costo del proveedor
  
  // Inventario
  trackInventory  Boolean    @default(true)
  stock           Int        @default(0)
  lowStockAlert   Int        @default(5)
  
  // Variantes (tallas, colores)
  hasVariants     Boolean    @default(false)
  variants        Json?      // [{name: "Talla", options: ["CH", "M", "G"]}]
  
  // Opciones de env√≠o
  weight          Decimal?   @db.Decimal(10, 2)  // kg
  dimensions      String?    // "30x20x10 cm"
  
  // Estado
  isActive        Boolean    @default(true)
  isFeatured      Boolean    @default(false)
  
  // Para comedor
  mealType        MealType?
  dayOfWeek       Int?       // 1-5
  availableFrom   DateTime?
  availableTo     DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  orderItems      VendorOrderItem[]
  
  @@index([vendorId])
  @@index([categoryId])
  @@index([isActive])
}

model VendorOrder {
  id              String    @id @default(cuid())
  orderNumber     String    @unique
  vendorId        String
  vendor          Vendor    @relation(fields: [vendorId], references: [id])
  
  // Comprador
  customerId      String
  customer        User      @relation("VendorOrdersPlaced", fields: [customerId], references: [id])
  
  // Estudiante (si aplica)
  studentId       String?
  student         Student?  @relation("VendorOrdersForStudent", fields: [studentId], references: [id])
  
  // Totales
  subtotal        Decimal   @db.Decimal(10, 2)
  serviceFee      Decimal   @default(0) @db.Decimal(10, 2)  // Cargo por servicio
  shippingCost    Decimal   @default(0) @db.Decimal(10, 2)
  tax             Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  
  // Distribuci√≥n de pagos
  vendorAmount    Decimal   @db.Decimal(10, 2)  // Lo que recibe el proveedor
  platformAmount  Decimal   @db.Decimal(10, 2)  // Lo que recibe la plataforma/colegio
  
  // Pago
  paymentStatus   String    @default("pending")  // pending, paid, failed, refunded
  paymentMethod   String?
  stripePaymentId String?
  
  // Estado del pedido
  status          String    @default("pending")  // pending, confirmed, preparing, shipped, delivered, cancelled
  
  // Env√≠o (si aplica)
  shippingMethod  String?   // "pickup", "delivery", "envia"
  shippingAddress Json?
  trackingNumber  String?
  trackingUrl     String?
  enviaShipmentId String?
  
  // Notas
  notes           String?
  internalNotes   String?
  
  // Timestamps
  confirmedAt     DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  items           VendorOrderItem[]
  
  @@index([vendorId])
  @@index([customerId])
  @@index([status])
  @@index([paymentStatus])
}

model VendorOrderItem {
  id              String        @id @default(cuid())
  orderId         String
  order           VendorOrder   @relation(fields: [orderId], references: [id])
  
  productId       String
  product         VendorProduct @relation(fields: [productId], references: [id])
  
  name            String        // Snapshot del nombre
  sku             String?
  
  quantity        Int
  unitPrice       Decimal       @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  
  // Variantes seleccionadas
  selectedVariants Json?       // {"Talla": "M", "Color": "Azul"}
  
  createdAt       DateTime      @default(now())
  
  @@index([orderId])
  @@index([productId])
}

model VendorPayout {
  id              String    @id @default(cuid())
  vendorId        String
  vendor          Vendor    @relation(fields: [vendorId], references: [id])
  
  // Monto
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("MXN")
  
  // Per√≠odo cubierto
  periodStart     DateTime
  periodEnd       DateTime
  
  // Estado
  status          String    @default("pending")  // pending, processing, completed, failed
  
  // Detalles de Stripe
  stripeTransferId String?
  stripePayoutId   String?
  
  // Desglose
  orderCount      Int
  grossAmount     Decimal   @db.Decimal(10, 2)  // Total de ventas
  commissionAmount Decimal  @db.Decimal(10, 2)  // Comisi√≥n retenida
  netAmount       Decimal   @db.Decimal(10, 2)  // Monto a pagar
  
  processedAt     DateTime?
  failureReason   String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([vendorId])
  @@index([status])
}

// ==========================================
// CONFIGURACI√ìN DE ENV√çOS (ENVIA.COM)
// ==========================================

model ShippingConfig {
  id              String   @id @default(cuid())
  schoolId        String   @unique
  school          School   @relation("SchoolShippingConfig", fields: [schoolId], references: [id])
  
  // Envia.com
  enviaEnabled    Boolean  @default(false)
  enviaApiKey     String?
  enviaSecretKey  String?
  
  // Origen de env√≠o (direcci√≥n del colegio/almac√©n)
  originName      String?
  originStreet    String?
  originNumber    String?
  originColony    String?
  originCity      String?
  originState     String?
  originZipCode   String?
  originPhone     String?
  
  // Carriers habilitados
  enabledCarriers String[]  // ["fedex", "dhl", "estafeta", "ups"]
  
  // Configuraci√≥n
  freeShippingThreshold Decimal? @db.Decimal(10, 2)  // Env√≠o gratis arriba de X
  handlingFee     Decimal? @db.Decimal(10, 2)        // Cargo de manejo
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==========================================
// CONFIGURACI√ìN DE CARGOS POR SERVICIO
// ==========================================

model ServiceFeeConfig {
  id              String   @id @default(cuid())
  schoolId        String   @unique
  school          School   @relation("SchoolServiceFeeConfig", fields: [schoolId], references: [id])
  
  // Cargo por servicio de e-commerce
  ecommerceEnabled Boolean @default(true)
  ecommerceFeeType String  @default("percentage")  // "percentage" | "fixed" | "both"
  ecommerceFeePercent Decimal @default(0) @db.Decimal(5, 2)
  ecommerceFeeFixed   Decimal @default(0) @db.Decimal(10, 2)
  ecommerceMinFee     Decimal? @db.Decimal(10, 2)  // M√≠nimo a cobrar
  ecommerceMaxFee     Decimal? @db.Decimal(10, 2)  // M√°ximo a cobrar
  
  // A qui√©n va el cargo por servicio
  ecommerceFeeDestination String @default("school")  // "school" | "platform" | "split"
  platformSplitPercent    Decimal @default(0) @db.Decimal(5, 2)  // Si es split
  
  // Cuenta destino del cargo por servicio (si va al colegio)
  serviceFeeStripeAccountId String?
  
  // Cargo por servicio de comedor
  cafeteriaEnabled     Boolean @default(true)
  cafeteriaFeeType     String  @default("percentage")
  cafeteriaFeePercent  Decimal @default(0) @db.Decimal(5, 2)
  cafeteriaFeeFixed    Decimal @default(0) @db.Decimal(10, 2)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==========================================
// SISTEMA DE SOPORTE (TICKETS)
// ==========================================

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  WAITING_INTERNAL
  RESOLVED
  CLOSED
}

enum TicketCategory {
  TECHNICAL       // Problemas t√©cnicos
  BILLING         // Facturaci√≥n y pagos
  ACADEMIC        // Consultas acad√©micas
  COMPLAINT       // Quejas
  SUGGESTION      // Sugerencias
  GENERAL         // General
}

model SupportTicket {
  id              String         @id @default(cuid())
  ticketNumber    String         @unique  // TICKET-2026-0001
  
  // Origen
  schoolId        String?
  school          School?        @relation("SchoolSupportTickets", fields: [schoolId], references: [id])
  
  // Creador (puede ser usuario de colegio o usuario externo)
  createdById     String?
  createdBy       User?          @relation("TicketsCreated", fields: [createdById], references: [id])
  
  // Para usuarios no registrados
  guestEmail      String?
  guestName       String?
  
  // Clasificaci√≥n
  category        TicketCategory
  priority        TicketPriority @default(MEDIUM)
  
  // Contenido
  subject         String
  description     String
  
  // Archivos adjuntos
  attachments     String[]       // URLs
  
  // Estado
  status          TicketStatus   @default(OPEN)
  
  // Asignaci√≥n
  assignedToId    String?
  assignedTo      User?          @relation("TicketsAssigned", fields: [assignedToId], references: [id])
  
  // Tipo de ticket
  isInternal      Boolean        @default(false)  // Ticket interno del colegio
  isPlatformLevel Boolean        @default(false)  // Ticket a nivel IA School
  
  // M√©tricas
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  satisfactionRating Int?        // 1-5
  satisfactionFeedback String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  messages        SupportTicketMessage[]
  
  @@index([schoolId])
  @@index([status])
  @@index([category])
  @@index([assignedToId])
}

model SupportTicketMessage {
  id              String        @id @default(cuid())
  ticketId        String
  ticket          SupportTicket @relation(fields: [ticketId], references: [id])
  
  // Autor
  authorId        String?
  author          User?         @relation("TicketMessages", fields: [authorId], references: [id])
  
  // Para respuestas de guest
  authorName      String?
  authorEmail     String?
  
  // Contenido
  content         String
  attachments     String[]
  
  // Tipo de mensaje
  isInternal      Boolean       @default(false)  // Nota interna (no visible para cliente)
  isFromAI        Boolean       @default(false)  // Respuesta del chatbot
  
  createdAt       DateTime      @default(now())
  
  @@index([ticketId])
}

// ==========================================
// CONFIGURACI√ìN DE REMINDERS IA
// ==========================================

enum ReminderType {
  APPOINTMENT         // Tienes una cita
  TASK_PENDING        // No has registrado la tarea
  SURVEY_PENDING      // No has respondido la encuesta
  PAYMENT_DUE         // No se ha registrado tu pago
  EVENT_UPCOMING      // Evento pr√≥ximo
  GRADE_PENDING       // Calificaciones por registrar
  ATTENDANCE_MISSING  // Falta registrar asistencia
  MESSAGE_UNREAD      // Mensajes sin leer
  DOCUMENT_PENDING    // Documentos por firmar
  PERMIT_PENDING      // Permiso pendiente de autorizar
  CUSTOM              // Personalizado
}

model ReminderConfig {
  id              String       @id @default(cuid())
  schoolId        String
  school          School       @relation("SchoolReminderConfigs", fields: [schoolId], references: [id])
  
  reminderType    ReminderType
  
  // A qui√©n aplica
  targetRoles     String[]     // ["PADRE", "PROFESOR", "ADMIN"]
  
  // Cu√°ndo enviar
  enabled         Boolean      @default(true)
  daysBeforeDue   Int          @default(1)  // D√≠as antes del vencimiento
  sendTime        String       @default("09:00")  // Hora de env√≠o
  
  // Canales
  sendEmail       Boolean      @default(true)
  sendPush        Boolean      @default(true)
  sendInApp       Boolean      @default(true)
  
  // Mensaje personalizado (opcional)
  customSubject   String?
  customMessage   String?
  
  // Frecuencia si es recurrente
  maxReminders    Int          @default(3)  // M√°ximo de recordatorios
  intervalDays    Int          @default(1)  // Intervalo entre recordatorios
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@unique([schoolId, reminderType])
  @@index([schoolId])
}

model ReminderLog {
  id              String       @id @default(cuid())
  schoolId        String
  school          School       @relation("SchoolReminderLogs", fields: [schoolId], references: [id])
  
  reminderType    ReminderType
  
  // Destinatario
  userId          String
  user            User         @relation("RemindersReceived", fields: [userId], references: [id])
  
  // Referencia al objeto relacionado
  referenceType   String?      // "task", "event", "payment", etc.
  referenceId     String?
  
  // Mensaje enviado
  subject         String
  message         String
  
  // Canales utilizados
  sentViaEmail    Boolean      @default(false)
  sentViaPush     Boolean      @default(false)
  sentViaInApp    Boolean      @default(false)
  
  // Estado
  status          String       @default("sent")  // sent, delivered, failed
  errorMessage    String?
  
  // IA gener√≥ el mensaje?
  isAiGenerated   Boolean      @default(false)
  
  sentAt          DateTime     @default(now())
  
  @@index([schoolId])
  @@index([userId])
  @@index([reminderType])
  @@index([sentAt])
}


// ==========================================
// SISTEMA DE GAMIFICACI√ìN PARA ESTUDIANTES
// ==========================================

enum BadgeCategory {
  ACADEMIC       // Logros acad√©micos
  ATTENDANCE     // Asistencia
  PARTICIPATION  // Participaci√≥n en clase
  BEHAVIOR       // Comportamiento
  TEAMWORK       // Trabajo en equipo
  CREATIVITY     // Creatividad
  SPORTS         // Deportes
  SPECIAL        // Eventos especiales
}

enum BadgeRarity {
  COMMON         // F√°cil de obtener
  UNCOMMON       // Requiere esfuerzo
  RARE           // Dif√≠cil de obtener
  EPIC           // Muy dif√≠cil
  LEGENDARY      // Excepcional
}

model GamificationBadge {
  id              String          @id @default(cuid())
  
  name            String
  description     String          @db.Text
  iconUrl         String?         // URL del √≠cono/imagen
  iconEmoji       String?         // Emoji alternativo
  
  category        BadgeCategory
  rarity          BadgeRarity     @default(COMMON)
  
  // Puntos otorgados al obtener
  pointsAwarded   Int             @default(10)
  
  // Requisitos para obtener (puede ser autom√°tico o manual)
  isAutomatic     Boolean         @default(false)
  criteria        Json?           // Criterios autom√°ticos { type: "attendance", threshold: 30 }
  
  // Visibilidad
  isActive        Boolean         @default(true)
  isSecret        Boolean         @default(false) // Insignia oculta hasta obtenerla
  
  // Per√≠odo de validez (para badges temporales)
  availableFrom   DateTime?
  availableUntil  DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  studentBadges   StudentBadge[]
  
  @@index([category])
  @@index([rarity])
  @@index([isActive])
}

model StudentBadge {
  id              String              @id @default(cuid())
  
  studentId       String
  student         Student             @relation("StudentBadges", fields: [studentId], references: [id], onDelete: Cascade)
  
  badgeId         String
  badge           GamificationBadge   @relation(fields: [badgeId], references: [id])
  
  // Qui√©n otorg√≥ la insignia
  awardedById     String?             // null = sistema autom√°tico
  
  // Contexto
  reason          String?             // Raz√≥n espec√≠fica
  referenceType   String?             // "task", "event", "attendance", etc.
  referenceId     String?
  
  // Puntos en el momento de otorgamiento
  pointsEarned    Int
  
  earnedAt        DateTime            @default(now())
  
  @@unique([studentId, badgeId])
  @@index([studentId])
  @@index([badgeId])
  @@index([earnedAt])
}

// Puntos totales y nivel del estudiante
model StudentGamificationProfile {
  id              String       @id @default(cuid())
  
  studentId       String       @unique
  student         Student      @relation("GamificationProfile", fields: [studentId], references: [id], onDelete: Cascade)
  
  // Puntos
  totalPoints     Int          @default(0)
  weeklyPoints    Int          @default(0)
  monthlyPoints   Int          @default(0)
  
  // Nivel
  currentLevel    Int          @default(1)
  levelName       String       @default("Principiante")
  experienceToNextLevel Int    @default(100)
  
  // Rachas
  currentStreak   Int          @default(0)  // D√≠as consecutivos de logros
  longestStreak   Int          @default(0)
  lastActivityDate DateTime?
  
  // Rankings (actualizados peri√≥dicamente)
  schoolRank      Int?         // Posici√≥n en el colegio
  groupRank       Int?         // Posici√≥n en su grupo
  
  // Logros especiales
  totalBadges     Int          @default(0)
  rareBadges      Int          @default(0)
  epicBadges      Int          @default(0)
  legendaryBadges Int          @default(0)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([totalPoints])
  @@index([schoolRank])
}

// Historial de puntos ganados
model StudentPointsLog {
  id              String       @id @default(cuid())
  
  studentId       String
  student         Student      @relation("PointsLogs", fields: [studentId], references: [id], onDelete: Cascade)
  
  points          Int          // Puede ser positivo o negativo
  reason          String
  category        BadgeCategory?
  
  // Referencia
  referenceType   String?      // "task", "badge", "attendance", etc.
  referenceId     String?
  
  // Qui√©n otorg√≥
  awardedById     String?
  
  earnedAt        DateTime     @default(now())
  
  @@index([studentId])
  @@index([earnedAt])
  @@index([category])
}

// ==========================================
// M√ìDULO DE TIPS Y CONSEJOS EDUCATIVOS (IA)
// ==========================================

enum TipCategory {
  PARENTING         // Crianza y educaci√≥n
  HOMEWORK_HELP     // Ayuda con tareas
  HEALTH_WELLNESS   // Salud y bienestar
  DIGITAL_SAFETY    // Seguridad digital
  SOCIAL_SKILLS     // Habilidades sociales
  EMOTIONAL_INTEL   // Inteligencia emocional
  STUDY_HABITS      // H√°bitos de estudio
  NUTRITION         // Nutrici√≥n
  ACTIVITIES        // Actividades familiares
  SCHOOL_PREP       // Preparaci√≥n escolar
}

enum TipAgeRange {
  PRESCHOOL         // 3-5 a√±os
  EARLY_ELEMENTARY  // 6-8 a√±os
  LATE_ELEMENTARY   // 9-11 a√±os
  MIDDLE_SCHOOL     // 12-14 a√±os
  HIGH_SCHOOL       // 15-18 a√±os
  ALL_AGES          // Todas las edades
}

enum TipStatus {
  DRAFT             // Generado por IA, pendiente revisi√≥n
  PENDING_REVIEW    // En revisi√≥n
  APPROVED          // Aprobado para publicaci√≥n
  PUBLISHED         // Publicado
  ARCHIVED          // Archivado
  REJECTED          // Rechazado
}

model EducationalTip {
  id              String         @id @default(cuid())
  
  title           String
  slug            String         @unique
  content         String         @db.Text
  summary         String?        @db.Text  // Resumen corto
  
  // Categorizaci√≥n
  category        TipCategory
  ageRange        TipAgeRange
  tags            String[]       // Tags adicionales
  
  // Imagen destacada
  featuredImageUrl String?
  featuredImageAlt String?
  
  // Generaci√≥n IA
  isAiGenerated   Boolean        @default(true)
  aiModel         String?        // Modelo usado
  aiPrompt        String?        @db.Text  // Prompt original
  
  // Aprobaci√≥n
  status          TipStatus      @default(DRAFT)
  reviewedById    String?
  reviewedAt      DateTime?
  reviewNotes     String?        @db.Text
  rejectionReason String?
  
  // Publicaci√≥n
  publishedAt     DateTime?
  scheduledFor    DateTime?      // Publicaci√≥n programada
  
  // Engagement
  viewCount       Int            @default(0)
  likeCount       Int            @default(0)
  shareCount      Int            @default(0)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Interacciones de usuarios
  interactions    TipInteraction[]
  
  @@index([category])
  @@index([ageRange])
  @@index([status])
  @@index([publishedAt])
  @@index([slug])
}

model TipInteraction {
  id              String         @id @default(cuid())
  
  tipId           String
  tip             EducationalTip @relation(fields: [tipId], references: [id], onDelete: Cascade)
  
  userId          String
  
  // Tipo de interacci√≥n
  interactionType String         // "view", "like", "share", "save"
  
  createdAt       DateTime       @default(now())
  
  @@unique([tipId, userId, interactionType])
  @@index([tipId])
  @@index([userId])
}

// Configuraci√≥n del generador de tips por escuela
model TipGenerationConfig {
  id              String         @id @default(cuid())
  
  schoolId        String?        // null = configuraci√≥n global
  
  // Frecuencia de generaci√≥n
  isEnabled       Boolean        @default(true)
  generationFrequency String     @default("weekly") // "daily", "weekly", "monthly"
  tipsPerGeneration Int          @default(3)
  
  // Preferencias de categor√≠as
  preferredCategories TipCategory[]
  excludedCategories  TipCategory[]
  
  // Flujo de aprobaci√≥n
  requiresApproval Boolean       @default(true)
  approverRoleRequired String?   // "ADMIN", "DIRECCION", etc.
  autoPublishAfterDays Int?      // Auto-publicar si no hay revisi√≥n
  
  // Notificaciones
  notifyOnGeneration Boolean     @default(true)
  notifyEmail        String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@unique([schoolId])
}


// =====================================================
// WEBAUTHN / PASSKEYS - Autenticaci√≥n Biom√©trica
// =====================================================

model UserPasskey {
  id              String   @id @default(cuid())
  
  userId          String
  user            User     @relation("UserPasskeys", fields: [userId], references: [id], onDelete: Cascade)
  
  // Credential data
  credentialId    String   @unique  // Base64URL encoded credential ID
  publicKey       String   @db.Text // Base64URL encoded public key or attestation
  counter         Int      @default(0)
  
  // Device info
  deviceName      String   @default("Unknown Device")
  deviceType      String?  // "mobile", "desktop", "tablet"
  browser         String?
  os              String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  lastUsedAt      DateTime @default(now())
  
  @@index([userId])
  @@index([credentialId])
}

model WebAuthnChallenge {
  id              String   @id @default(cuid())
  
  challenge       Bytes    // Random challenge bytes
  userId          String   // User this challenge is for (or "anonymous")
  type            String   // "registration" or "authentication"
  
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  
  @@index([userId, type])
  @@index([expiresAt])
}

// =====================================================
// AUDIT LOG - Registro de Actividades Sensibles
// =====================================================

model SecurityAuditLog {
  id              String   @id @default(cuid())
  
  userId          String?
  schoolId        String?
  
  // Action details
  action          String   // "LOGIN", "LOGOUT", "VIEW_MEDICAL", "MODIFY_PAYMENT", etc.
  resource        String   // Resource type: "USER", "PAYMENT", "MEDICAL_RECORD", etc.
  resourceId      String?  // ID of affected resource
  
  // Request details
  ipAddress       String?
  userAgent       String?
  endpoint        String?  // API endpoint
  method          String?  // HTTP method
  
  // Result
  success         Boolean  @default(true)
  errorMessage    String?
  
  // Additional context (JSON)
  metadata        Json?
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([schoolId])
  @@index([action])
  @@index([createdAt])
}

// =====================================================
// PROGRAMA DE REFERIDOS ESCOLAR
// Sistema para que padres refieran nuevas familias
// =====================================================

enum SchoolReferralStatus {
  PENDING       // Referido enviado, pendiente de contacto
  CONTACTED     // La escuela contact√≥ al prospecto
  INTERESTED    // El prospecto mostr√≥ inter√©s
  ENROLLED      // ¬°El prospecto se inscribi√≥! - √âXITO
  NOT_INTERESTED // El prospecto no mostr√≥ inter√©s
  ALREADY_REFERRED // Ya fue referido por alguien m√°s
  INVALID       // Datos inv√°lidos o duplicados
}

enum ReferralRewardType {
  DISCOUNT_PERCENTAGE   // Descuento porcentual en colegiatura
  DISCOUNT_FIXED        // Descuento fijo en pesos
  FREE_MONTHS           // Meses gratis de colegiatura
  STORE_CREDIT          // Cr√©dito en la tienda escolar
  CASH_BACK             // Reembolso en efectivo
  CUSTOM                // Recompensa personalizada
}

model SchoolReferralProgram {
  id              String   @id @default(cuid())
  
  schoolId        String   @unique
  school          School   @relation("SchoolReferralProgram", fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Estado del programa
  isActive        Boolean  @default(true)
  
  // Configuraci√≥n de la recompensa
  rewardType      ReferralRewardType @default(DISCOUNT_PERCENTAGE)
  rewardValue     Decimal  @default(10)    // Valor del descuento/recompensa
  rewardDescription String?  @db.Text      // Descripci√≥n personalizada
  
  // L√≠mites
  maxRewardsPerYear Int?     @default(5)    // M√°ximo de recompensas por padre/a√±o
  minEnrollmentValue Decimal? @default(0)   // Inscripci√≥n m√≠nima para calificar
  
  // Condiciones de elegibilidad
  requiresActiveAccount Boolean @default(true)   // El referidor debe estar al corriente
  requiresMinMonths     Int?     @default(3)     // Meses m√≠nimos en la escuela
  
  // Mensajes personalizados
  welcomeMessage  String?   @db.Text  // Mensaje de bienvenida al referido
  thankYouMessage String?   @db.Text  // Mensaje de agradecimiento al referidor
  
  // T√©rminos y condiciones
  termsUrl        String?
  
  // Contadores (cache para performance)
  totalReferrals       Int @default(0)
  successfulReferrals  Int @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones
  referrals       SchoolReferral[] @relation("ProgramReferrals")
  rewards         ReferralReward[] @relation("ProgramRewards")
  
  @@index([schoolId])
}

model SchoolReferral {
  id              String   @id @default(cuid())
  
  // Programa y escuela
  programId       String
  program         SchoolReferralProgram @relation("ProgramReferrals", fields: [programId], references: [id], onDelete: Cascade)
  
  schoolId        String
  school          School   @relation("SchoolReferralsReceived", fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Padre que refiere
  referrerId      String
  referrer        User     @relation("UserSchoolReferrals", fields: [referrerId], references: [id], onDelete: Cascade)
  
  // Datos del referido (prospecto)
  referredName      String           // Nombre del padre/tutor prospecto
  referredEmail     String?          // Email del prospecto
  referredPhone     String           // Tel√©fono del prospecto (requerido)
  referredChildName String?          // Nombre del ni√±o (opcional)
  referredChildGrade String?         // Grado de inter√©s
  referredNotes     String?  @db.Text // Notas adicionales
  
  // Estado y tracking
  status          SchoolReferralStatus @default(PENDING)
  statusHistory   Json?                // Historial de cambios de estado
  
  // Fechas importantes
  contactedAt     DateTime?   // Cu√°ndo la escuela contact√≥
  enrolledAt      DateTime?   // Cu√°ndo se inscribi√≥ (si convirti√≥)
  
  // Para detectar duplicados - hash del tel√©fono normalizado
  phoneHash       String
  
  // Si el prospecto se convirti√≥ en usuario
  convertedUserId String?  @unique
  convertedUser   User?    @relation("ReferredBySchoolReferral", fields: [convertedUserId], references: [id])
  
  // Notas del admin
  adminNotes      String?  @db.Text
  
  // Qui√©n proces√≥ el referido
  processedById   String?
  processedBy     User?    @relation("ProcessedSchoolReferrals", fields: [processedById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaci√≥n con recompensa (si se otorg√≥)
  reward          ReferralReward? @relation("ReferralRewardLink")
  
  @@unique([schoolId, phoneHash]) // Solo un referido por tel√©fono por escuela
  @@index([programId])
  @@index([referrerId])
  @@index([schoolId])
  @@index([status])
  @@index([phoneHash])
}

model ReferralReward {
  id              String   @id @default(cuid())
  
  programId       String
  program         SchoolReferralProgram @relation("ProgramRewards", fields: [programId], references: [id], onDelete: Cascade)
  
  // Referido que gener√≥ la recompensa
  referralId      String   @unique
  referral        SchoolReferral @relation("ReferralRewardLink", fields: [referralId], references: [id], onDelete: Cascade)
  
  // Beneficiario
  beneficiaryId   String
  beneficiary     User     @relation("ReferralRewardsBeneficiary", fields: [beneficiaryId], references: [id], onDelete: Cascade)
  
  // Detalles de la recompensa
  rewardType      ReferralRewardType
  rewardValue     Decimal
  description     String?  @db.Text
  
  // Estado
  isApplied       Boolean  @default(false)
  appliedAt       DateTime?
  appliedById     String?
  appliedBy       User?    @relation("ReferralRewardsApplied", fields: [appliedById], references: [id])
  
  // Si se vincul√≥ a un cargo espec√≠fico
  appliedToChargeId String?
  appliedToCharge   Charge?  @relation("ReferralRewardCharge", fields: [appliedToChargeId], references: [id])
  
  // Expiraci√≥n
  expiresAt       DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([programId])
  @@index([beneficiaryId])
  @@index([isApplied])
}

// ============================================
// CICLOS ESCOLARES
// ============================================
model SchoolCycle {
  id              String   @id @default(cuid())
  schoolId        String
  school          School   @relation("SchoolCycles", fields: [schoolId], references: [id], onDelete: Cascade)
  
  name            String           // "2025-2026", "2026-2027"
  startDate       DateTime
  endDate         DateTime
  
  // Estado del ciclo
  status          CycleStatus      @default(UPCOMING)
  
  // Configuraci√≥n del ciclo
  isCurrentCycle  Boolean          @default(false)
  
  // Fechas importantes
  inscriptionStart DateTime?       // Inicio de inscripciones
  inscriptionEnd   DateTime?       // Fin de inscripciones
  classesStart     DateTime?       // Inicio de clases
  classesEnd       DateTime?       // Fin de clases
  
  // Configuraci√≥n de reinscripci√≥n
  autoPromotionEnabled Boolean     @default(false)  // Promover autom√°ticamente al siguiente grado
  promotionMinGPA      Float?                        // Promedio m√≠nimo para promoci√≥n autom√°tica
  
  // Configuraci√≥n financiera del ciclo
  inscriptionFee      Decimal?     @db.Decimal(10, 2)
  monthlyTuition      Decimal?     @db.Decimal(10, 2)
  materialsFee        Decimal?     @db.Decimal(10, 2)
  
  // Relaciones
  enrollments         Enrollment[]     @relation("CycleEnrollments")
  charges             Charge[]         @relation("CycleCharges")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([status])
  @@index([isCurrentCycle])
}

enum CycleStatus {
  UPCOMING      // Pr√≥ximo ciclo
  ACTIVE        // Ciclo activo actual
  COMPLETED     // Ciclo finalizado
  ARCHIVED      // Ciclo archivado
}

// ============================================
// MULTI-TUTOR (Soporte para padres divorciados/separados)
// ============================================
model StudentTutor {
  id              String   @id @default(cuid())
  
  studentId       String
  student         Student  @relation("StudentTutors", fields: [studentId], references: [id], onDelete: Cascade)
  
  tutorId         String
  tutor           User     @relation("TutorStudents", fields: [tutorId], references: [id], onDelete: Cascade)
  
  // Tipo de relaci√≥n
  relationship    TutorRelationship @default(PARENT)
  relationshipDetail String?         // "Madre", "Padre", "Abuelo", "T√≠o", etc.
  
  // Permisos y configuraci√≥n
  isPrimaryContact    Boolean  @default(false)   // Contacto principal
  hasFullAccess       Boolean  @default(true)    // Acceso completo a informaci√≥n
  canViewGrades       Boolean  @default(true)    // Ver calificaciones
  canViewAttendance   Boolean  @default(true)    // Ver asistencia
  canViewPayments     Boolean  @default(true)    // Ver pagos/estados de cuenta
  canMakePayments     Boolean  @default(true)    // Realizar pagos
  canPickup           Boolean  @default(true)    // Autorizado para recoger
  canCommunicate      Boolean  @default(true)    // Comunicarse con maestros
  canReceiveNotifications Boolean @default(true) // Recibir notificaciones
  canRequestPermissions Boolean @default(true)   // Solicitar permisos
  
  // Para custodia compartida
  custodyType         CustodyType?               // Tipo de custodia
  custodyNotes        String?      @db.Text      // Notas sobre custodia/acuerdos
  
  // Estado
  isActive            Boolean  @default(true)
  activatedAt         DateTime @default(now())
  deactivatedAt       DateTime?
  deactivatedReason   String?
  
  // Qui√©n configur√≥ esta relaci√≥n
  configuredById      String?
  configuredBy        User?    @relation("TutorConfiguredBy", fields: [configuredById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([studentId, tutorId])
  @@index([studentId])
  @@index([tutorId])
  @@index([isPrimaryContact])
}

enum TutorRelationship {
  PARENT        // Padre/Madre biol√≥gico
  STEPPARENT    // Padrastro/Madrastra
  GRANDPARENT   // Abuelo/Abuela
  LEGAL_GUARDIAN // Tutor legal
  RELATIVE      // Otro familiar
  OTHER         // Otro
}

enum CustodyType {
  FULL          // Custodia total
  SHARED        // Custodia compartida
  VISITATION    // Solo visitas
  RESTRICTED    // Restringida (por orden judicial)
}
